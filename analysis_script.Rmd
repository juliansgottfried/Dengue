---
author: "Julian Gottfried"
date: "2024-11-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Set-up
```{r}
library(tidyverse)
library(pomp)
library(ggridges)
library(doParallel)
library(doRNG)
library(ggtext)
library(splines2)
library(forecast)
library(viridis)
library(ggnewscale)
library(WaveletComp)
library(Rssa)
library(viridis)
library(scales)
library(varhandle)

library(sf)
library(classInt)
library(cartogram)

setwd("/Users/juliangottfried/Desktop/NYU/thailand")

source("./helper_functions.R")

seed <- 9087235
set.seed(seed)

#bk <- read_csv("data/bk_df.csv",show_col_types=FALSE)

#covariates <- covariate_table(bk %>% select(
#        time, covariate, el_nino, la_nina, pop, dpopdt,
#        season1, season2, season3, season4, season5, season6),
#    times = "time")
#covariates <- covariate_table(bk %>% select(-c(cases)),
#    times = "time")
#covariates <- covariate_table(bk %>% select(-c(cases,iso1,iso2,iso3,iso4)),
#    times = "time")
  
#t_extrap <- with(bk, c(2 * time[1] - time[2], time))
#covariates <- repair_lookup_table(covariates, t_extrap)

```

Choose fit
```{r}
type <- "cluster"
date <- "5_23"
fit <- "f"

#read_csv("cluster_runs/run_5_23_e/pars.csv") %>%
#    mutate(bNina=0) %>%
#    write_csv("cluster_runs/run_5_23_e/pars.csv")


```

Format data
```{r}
cases <- read_csv("data/case_data.csv",show_col_types=FALSE)
bk <- data.frame(cases %>% mutate(cases=KrungThep) %>% select("date","cases"))
bk$time <- sapply(str_split(bk$date,"-"),function(x){sum(as.numeric(x)/c(1,12))})
bk <- bk %>% filter(time>=1970 & time<2000)

bsplines <- periodic_bspline_basis(x = bk$time, nbasis = 6, names = "season%d") |> as_tibble()

#pop <- read_csv("data/population_data.csv",show_col_types=FALSE)
pop <- read_csv("bangkok_pop.csv",show_col_types=FALSE)

pop$date <- sapply(str_split(pop$date,"-"),function(x){sum(as.numeric(x)*c(1,1/12,0))})
pop <- pop %>% filter(date>=1970 & date<2019)
#pop$covariate <- read_csv("data/covariates.csv") %>% pull(interannual_cov)
names(pop) <- c("date","population","dpdt")

pop <- pop %>% 
    mutate(date=as.character(date)) %>% 
    group_by(date) %>% 
    summarise(pop=mean(population),
              dpopdt=mean(dpdt))%>% 
    ungroup() %>% 
    mutate(date=as.numeric(date))

#bk <- cbind(bk[,c(3,2)],pop[,2:3],bsplines)
bk <- read_csv("data/full_time.csv")
bk$pop <- pop$pop
bk$dpopdt <- pop$dpopdt

smooth_pop <- loess(bk$pop ~ bk$time)$fitted
smooth_pop <- smooth.spline(x = bk$time, smooth_pop)

pop = predict(smooth_pop, deriv = 0, x = bk$time)$y
dpopdt = predict(smooth_pop, deriv = 1, x = bk$time)$y

bk$pop <- pop
bk$dpopdt <- dpopdt

write_csv(bk, "data/full_time.csv")

```

Format enso data
```{r}
for (i in list.files("data/enso",full.names=T)) {
    df <- read_csv(i)
    bk$tmp <- df$enso_34_anomaly
    names(bk) <- ifelse(names(bk)=="tmp",df$months[1],names(bk))
}
write_csv(bk,"data/bk_df.csv")

bk <- bk %>% select(-AMJ,-MJJ,-JJA)
bk <- bk %>% rename(enso=JAS)
ninos <- ifelse(bk$el_nino==0,0,1)
no_ninas <- ifelse(bk$la_nina==0,1,0)
bk$enso_no_nina <- bk$enso*no_ninas
bk$enso_nino <- bk$enso*ninos

write_csv(bk,"data/bk_df.csv")


#More

tmp <- read_csv("data/bk_enso_temp_df.csv")
bk_more_enso <- bk %>% select(-c(enso,covariate,el_nino,la_nina,enso_no_nina,enso_nino))
bk_more_enso <- bind_cols(bk_more_enso,tmp %>% select(enso_34_anom_JJA:temp_JAS))
bk_more_enso <- bk_more_enso %>% rename(enso1=enso_34_anom_JJA,
                                        enso2=enso_34_anom_JAS,
                                        temp1=temp_JJA,
                                        temp2=temp_JAS)
write_csv(bk_more_enso,"bk_enso_temp.csv")


tmp <- read_csv("data/bk_enso_temp_df_2.csv")
tmp <- tmp %>% 
    select(-c(temp_JJA,temp_JAS,date,year)) %>% 
    rename(ensoJFM=enso_34_anom_JFM,
               ensoFMA=enso_34_anom_FMA,
               ensoMAM=enso_34_anom_MAM,
               ensoJJA=enso_34_anom_JJA,
               ensoJAS=enso_34_anom_JAS)

bk_clean <- bk %>% 
    select(-c(el_nino,la_nina,enso_no_nina,enso_nino,enso)) %>% 
    rename(temp=covariate)
write_csv(bk_clean,"data/bk_clean_df.csv")

bk_winter <- bind_cols(bk_clean,tmp %>% select(starts_with("enso")))
write_csv(bk_winter,"data/bk_ensos_df.csv")

```

Format and create full time series data
```{r}
enso <- read_csv("data/enso.csv")
enso <- enso %>% 
    select(year,month,enso_34_anomaly) %>% 
    filter(month%in%c("Jul","Aug","Sep")) %>%
    group_by(year) %>% 
    summarise(enso=mean(enso_34_anomaly))
enso$nina <- ifelse(enso$enso<0,enso$enso,0)
enso$enso <- ifelse(enso$enso>0,enso$enso,0)
enso <- enso %>% rename(nino=enso)

bk <- bk %>% filter(time>=1970&time<2019)
enso <- enso %>% filter(year>=1970&year<2019)

full_time_series <- cbind(bk,enso[rep(1:nrow(enso),each=12),2:3])

mean_temp <- read_csv("data/mean_temp.csv")
mean_temp <- mean_temp %>% filter(location=="bangkok")
mean_temp$date <- sapply(str_split(mean_temp$date,"-"),function(x){x[1]})
mean_temp <- mean_temp %>% filter(date>=1970&date<2019) %>% select(-location)

full_time_series$temp <- mean_temp$temperature

write_csv(full_time_series,"data/full_time.csv")

write_csv(read_csv("data/full_time.csv") %>% 
    mutate(beta_eff=read_csv("data/beta_eff.csv",col_names=F) %>% pull(X1)),"data/full_time.csv")

```

Four time series raw epidemics data
```{r}
tmp <- read_csv("data/full_time.csv") %>% 
    select(-cases) %>% 
    filter(time>=1994 & time<2015)
epidemics <- read_csv("data/epidemic_data.csv")
four_den <- cbind(tmp,epidemics[,3:6])
colnames(four_den)[(ncol(four_den)-3):ncol(four_den)] <- sprintf("den%d",1:4)
write_csv(four_den,"data/four_time_real.csv")

```

Plot data from paper
```{r}
table_3 <- read.table("data/paper_data/table_3.txt",sep="") %>% as.data.frame
names <- c("Year","Pri","Sec","Total")
den1 <- table_3 %>% select(c(V1,V7:V8,V10)) %>% set_names(names)
den2 <- table_3 %>% select(c(V1,V11:V12,V14)) %>% set_names(names)
den3 <- table_3 %>% select(c(V1,V15:V16,V18)) %>% set_names(names)
den4 <- table_3 %>% select(c(V1,V19:V20,V22)) %>% set_names(names)

serotype_df <- bind_rows(list(den1,den2,den3,den4))
serotype_df$Serotype <- paste0("den",rep(1:4,each=nrow(den1)))

smoother <- function(df,sero,time) {
    #df <- total
    #time="Year"
    #sero="den1"
    smoth <- loess(df[[sero]] ~ df[[time]],degree=2)$fitted
    smoth <- smooth.spline(x = df[[time]], smoth)
    predict(smoth, deriv = 0, x = df[[time]])$y
}

primary <- serotype_df %>% select(-Sec,-Total) %>% rename(Cases=Pri)
primary <- primary %>% pivot_wider(id_cols=Year,names_from=Serotype,values_from=Cases)
primary$total <- rowSums(primary[,2:5])
primary[,2:6] <- apply(primary[,2:6],1,function(x) return(x/x[5])) %>% t
primary <- primary %>% select(-total)
#primary[,2:5] <- sapply(names(primary)[2:5],function(x) smoother(primary,x,"Year"))

secondary <- serotype_df %>% select(-Pri,-Total) %>% rename(Cases=Sec)
secondary <- secondary %>% pivot_wider(id_cols=Year,names_from=Serotype,values_from=Cases)
secondary$total <- rowSums(secondary[,2:5])
secondary[,2:6] <- apply(secondary[,2:6],1,function(x) return(x/x[5])) %>% t
secondary <- secondary %>% select(-total)
#secondary[,2:5] <- sapply(names(secondary)[2:5],function(x) smoother(secondary,x,"Year"))

total <- serotype_df %>% select(-Sec,-Pri) %>% rename(Cases=Total)
total <- total %>% pivot_wider(id_cols=Year,names_from=Serotype,values_from=Cases)
total$total <- rowSums(total[,2:5])
total[,2:6] <- apply(total[,2:6],1,function(x) return(x/x[5])) %>% t
total <- total %>% select(-total)
#total[,2:5] <- sapply(names(total)[2:5],function(x) smoother(total,x,"Year"))

ggplot(primary %>% pivot_longer(cols=den1:den4,names_to="Serotype",values_to="Freq"),
       aes(x=Year,y=Freq,color=Serotype))+
    geom_line(linewidth=0.8,alpha=0.9)+
    scale_color_manual(values=c("#facd16","#94790d","#7a1145","#fa4da3"))+
    theme_classic()+
    ylim(0,1)+
    scale_x_continuous(breaks=seq(1973,1998,by=5))+
    ggtitle("Relative Frequencies of Primary Infections (Thailand)")+
    ylab("Frequency")
ggplot(secondary %>% pivot_longer(cols=den1:den4,names_to="Serotype",values_to="Freq"),
       aes(x=Year,y=Freq,color=Serotype))+
    geom_line(linewidth=0.8,alpha=0.9)+
    scale_color_manual(values=c("#facd16","#94790d","#7a1145","#fa4da3"))+
    theme_classic()+
    ylim(0,1)+
    scale_x_continuous(breaks=seq(1973,1998,by=5))+
    ggtitle("Relative Frequencies of Secondary Infections (Thailand)")+
    ylab("Frequency")
ggplot(total %>% pivot_longer(cols=den1:den4,names_to="Serotype",values_to="Freq"),
       aes(x=Year,y=Freq,color=Serotype))+
    geom_line(linewidth=0.8,alpha=0.9)+
    scale_color_manual(values=c("#facd16","#94790d","#7a1145","#fa4da3"))+
    theme_classic()+
    ylim(0,1)+
    scale_x_continuous(breaks=seq(1973,1998,by=5))+
    ggtitle("Relative Frequencies of Infections (Thailand)")+
    ylab("Frequency")

```

Format data from paper
```{r}
table_3 <- read.table("data/paper data/table_3.txt",sep="") %>% as.data.frame
table_3 <- table_3 %>% select(c(V1,V6,V10,V14,V18,V22))
names(table_3) <- c("time","iso_rate","iso1","iso2","iso3","iso4")
table_3 <- table_3 %>% mutate(iso_rate = rowSums(across(iso1:iso4))/iso_rate)
table_3 <- table_3 %>% slice(rep(1:n(), each = 12))

bk_iso <- bk %>% 
    select(-c(el_nino,la_nina,enso_no_nina,enso_nino)) %>% 
    rename(temp=covariate) %>% 
    filter(time>=table_3$time[1])

table_3$time <- bk_iso$time

bk_iso <- bind_cols(bk_iso,table_3 %>% select(-time))

write_csv(bk_iso,"data/bk_df_iso.csv")

```

Generate new data - noisy four time series
```{r}
tmp <- read_csv("data/bk_split_enso.csv")

total <- total[rep(1:nrow(total),each=12),]

tmp <- cbind(tmp,total)

tmp[,21:24] <- apply(tmp %>% select(c(cases,den1:den4)),1,function(x) {x[2:5]*x[1]}) %>% t

tmp <- tmp %>% select(-c(cases,iso1:iso4,enso,iso_rate,Year))

tmp <- tmp %>% rename(cases1=den1,cases2=den2,cases3=den3,cases4=den4)

tmp <- tmp %>% mutate(across(cases1:cases4,round))

write_csv(tmp,"data/bk_four_time_series.csv")

```

Load fit
```{r}
construction <- function(type,date,fit,which) {
    file_path <- paste0("./",type,"_runs/run_",date,"_",fit)
    source(paste0(file_path,"/object.R"))
    init_vals <- read.csv(paste0(file_path,"/pars.csv"))
    pars <- names(init_vals)
    model_fit <- read.csv(paste0(file_path,"/results.csv")) %>% arrange(-loglik)
    bk <- read_csv(paste0(file_path,"/bk_df.csv"))
    covariates <- covariate_table(bk %>% select(all_of(covars)),
    times = "time")
    t_extrap <- with(bk, c(2 * time[1] - time[2], time))
    covariates <- repair_lookup_table(covariates, t_extrap)
    pomped <- construct_pomp(bk,covariates)
    mle <- model_fit %>% select(all_of(pars)) %>% slice(which)
    coef(pomped,pars) <- unname(mle[pars])
    return(list(pomped,state_names))
}

file_path <- paste0("./",type,"_runs/run_",date,"_",fit)

source(paste0(file_path,"/object.R"))

#source(paste0(file_path,"/object_no_nina.R"))
#source(paste0(file_path,"/object_nino.R"))

init_vals <- read.csv(paste0(file_path,"/pars.csv"))

model_fit <- read.csv(paste0(file_path,"/results.csv")) %>% arrange(-loglik)

#model_fit <- read.csv(paste0(file_path,"/results_no_nina.csv")) %>% arrange(-loglik)
#model_fit <- read.csv(paste0(file_path,"/results_nino.csv")) %>% arrange(-loglik)

#model_fit <- read.csv(paste0(file_path,"/results_amj.csv")) %>% arrange(-loglik)
#model_fit <- read.csv(paste0(file_path,"/results_mjj.csv")) %>% arrange(-loglik)
#model_fit <- read.csv(paste0(file_path,"/results_jja.csv")) %>% arrange(-loglik)
#model_fit <- read.csv(paste0(file_path,"/results_jas.csv")) %>% arrange(-loglik)

if (file.exists(paste0(file_path,"/bk_df.csv"))) {
    bk <- read_csv(paste0(file_path,"/bk_df.csv"))
} else {bk <- read_csv("data/bk_df.csv")}

covariates <- covariate_table(bk %>% select(all_of(covars)),
    times = "time")
  
t_extrap <- with(bk, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

pars <- names(init_vals)
est_pars <- names(init_vals)[apply(init_vals,2,function(x) {max(x)-min(x)})!=0]
fixed_pars <- pars[!pars%in%est_pars]

pomped <- pomp(
    data = bk %>% select(all_of(data_vars)) %>% na.omit,
    times = "time",
    t0 = with(bk, 2*time[1]-time[2]),
    covar = covariates,
    rprocess = euler(step.fun = rproc, delta.t = 1/365),
    rmeasure = rmeas,
    dmeasure = dmeas,
    rinit = rinit,
    paramnames = par_names,
    partrans = parameter_trans(
        log = log_transf,
        logit = logit_transf,
        barycentric = barycentric_transf
        ),
    accumvars = accum_names,
    statenames = c(accum_names,state_names),
    verbose = TRUE)

#coef(pomped) <- init_vals[3,]
#pf <- pfilter(pomped,Np=100)
#logLik(pf)

head(model_fit$loglik,n=10)

mle <- model_fit %>% select(all_of(pars)) %>% slice(1)
#write_csv(mle,paste0(file_path,"/mle.csv"))
coef(pomped,pars) <- unname(mle[pars])

```

Plot S and cases
```{r}
mle <- read_csv("~/Desktop/NYU/DengueClimateThailand/analysis/julian_fit/mles/JAS_enso_mle.csv")
source("objects/object_seirs_enso.R")
pomped <- construct_pomp(bk,covariates)
pars <- names(mle)
coef(pomped,pars) <- unname(mle[pars])

sims <- pomped %>% simulate(nsim = 100,include.data = TRUE,format = "data.frame")
   
sim_S <- sims %>% 
        select(time,S,cases,.id,pop) %>%
    pivot_longer(cols=S:cases,names_to="Type",values_to="Value") %>% 
    na.omit() %>% 
    filter(!(.id!="data"&Type=="cases"))

sim_S$Value[sim_S$Type=="S"]=sim_S$Value[sim_S$Type=="S"]/sim_S$pop[sim_S$Type=="S"]

sim_S %>% ggplot(aes(x = time, y = Value)) +
    ggdist::stat_lineribbon(.width = c(0.5,0.95), alpha = 0.5, linewidth = 0.8, fill="red") +
            labs(x = "Year", y = "Count", title="Dengue in Bangkok")+
            theme_classic()+
            theme(legend.position = "none",text = element_text(size = 14))+
    facet_wrap(~Type,scales="free_y")

S_mean <- sims %>%
    filter(.id!="data") %>%
    group_by(year=round(time)) %>%
    summarise(S=mean(S),
              enso=mean(nino+nina)) %>% 
    mutate(cases=bk %>% group_by(year=round(time)) %>%
               summarise(cases=mean(cases)) %>% 
               pull(cases))

S_mean[1:(nrow(S_mean)-1),c(1,4)] <- S_mean[2:nrow(S_mean),c(1,4)]
S_mean <- S_mean[1:(nrow(S_mean)-1),]

S_mean %>% ggplot(aes(x=S,y=cases))+geom_point()+theme_classic()
S_mean %>% ggplot(aes(x=enso,y=cases))+geom_point()+theme_classic()

sims %>% filter(.id!="cases") %>% mutate(tmp=E/pop) %>% pull(tmp) %>% sort() %>% head

```

Simulate from fit
```{r}
head(model_fit$loglik)

mle <- model_fit %>% select(all_of(pars)) %>% slice(1)
#mle %>% write_csv("JAS_mle_5th.csv")

#mle <- model_fit %>% select(-c(X,sample,bAMJ,bMJJ,bJJA,loglik,loglik.se,flag)) %>% slice(4)
#mle <- mle %>% rename(bT=bH,bENSO=bJAS)
#mle %>% write_csv("JAS_mle_4th_prev.csv")

coef(pomped,pars) <- unname(mle[pars])

#source("./helper_functions.R")
sims_cases <- run_simulation(pomped,1000)

#plot_simulation(sims_cases, CI=c(0.5,0.95),mode="traj")
plot_simulation(sims_cases, CI=c(0.47,0.89),mode="ribbon")


mle_range <- model_fit %>% filter(loglik>max(loglik)-40,loglik.se<4) %>% select(all_of(pars))
mle_range <- mle_range %>% pivot_longer(cols = everything(), names_to="param",values_to="value")
mle_range$param <- factor(mle_range$param,levels=par_names)
ggplot(mle_range %>%
           filter(!param%in%c("delta","sig_obs","muIS","q")),
       aes(x=value))+
    geom_density()+
    theme_classic()+
    facet_wrap(~param,scales="free")+
    theme(text = element_text(size = 10))

```

Prepare old param guesses
```{r}
new_type <- "cluster"
new_date <- "5_20"
new_fit <- "f"

nseq <- 500

# SEIRS
object <- "objects/object_seirs.R"
source(object)
new_init_vals <- runif_design(
  lower=c(b1=-4,b2=-4,b3=-4,b4=-4,b5=-4,b6=-4,
          bH=0,
          beta_out=0.001,
          sigma=0.001,
          sig_obs=0.05,
          mu=1/60,incub=20,infect=20,wane=0.5,
          rho=0.001,
          S_0=0.1,E_0=0,I_0=0,R_0=0.1),
  upper=c(b1=4,b2=4,b3=4,b4=4,b5=4,b6=4,
          bH=5,
          beta_out=0.1,
          sigma=0.01,
          sig_obs=0.05,
          mu=1/60,incub=40,infect=40,wane=2,
          rho=0.05,
          S_0=1,E_0=0.1,I_0=0.1,R_0=1),
  nseq=nseq)
new_est_pars <- c("b1","b2","b3","b4","b5","b6",
                  "bH",
                  "beta_out",
                  "sigma",
                  "incub","infect","wane",
                  "rho",
                  "S_0", "E_0", "I_0","R_0")

#SEIRSEIR
object <- "objects/object_seirseir.R"
source(object)
new_init_vals <- runif_design(
  lower=c(b1=-5,b2=-5,b3=-5,b4=-5,b5=-5,b6=-5,
          bH=-2,
          beta_out=0.001,
          sigma=0.001,
          mu=1/60,mu_I2=0.01,
          incub1=10,infect1=10,
          incub2=10,infect2=10,
          wane=0.5,
          eta=0.5,
          q=0.5,
          rho=0,
          sig_obs=0.05,
          S1_0=0.1,E1_0=0,I1_0=0,R1_0=0.1,
          S2_0=0.1,E2_0=0,I2_0=0,R2_0=0.1),
  upper=c(b1=5,b2=5,b3=5,b4=5,b5=5,b6=5,
          bH=2,
          beta_out=0.01,
          sigma=0.01,
          mu=1/60,mu_I2=0.05,
          incub1=50,infect1=50,
          incub2=50,infect2=50,
          wane=6,
          eta=1,
          q=1.5,
          rho=0.2,
          sig_obs=0.05,
          S1_0=1,E1_0=0.2,I1_0=0.2,R1_0=1,
          S2_0=1,E2_0=0.2,I2_0=0.2,R2_0=1),
  nseq=nseq)
new_est_pars <- c("b1","b2","b3","b4","b5","b6",
                  "bH",
                  "beta_out",
                  "sigma",
                  "mu_I2",
                  "incub1","infect1",
                  "incub2","infect2",
                  "wane",
                  "eta",
                  "q",
                  "rho",
                  "S1_0", "E1_0", "I1_0", "R1_0",
                  "S2_0", "E2_0", "I2_0", "R2_0")

# Latent FOI with constricted ranges, SEIRS
object <- "objects/object_seirs_ornamented.R"
source(object)
new_init_vals <- runif_design(
  lower=c(b1=-0.35,b2=1.7,b3=0.7,b4=3,b5=0.65,b6=1.5,bH=1,
          sigma=0.01,
          beta_out=0.001,q=0,alpha=0.85,
          delta=1/60,
          muEI=8,muIS=0,muIQ=8,muQS=3,
          tau=0.008,
          rho=0.001,
          S_0=0.9,E_0=0,I_0=0,Q_0=0,
          K_0=0.005,F_0=0.005,
          sig_obs=0.05),
  upper=c(b1=-0.15,b2=1.9,b3=0.9,b4=5,b5=0.85,b6=3.5,bH=3,
          sigma=0.1,
          beta_out=0.01,q=0,alpha=1,
          delta=1/60,
          muEI=10,muIS=0,muIQ=10,muQS=5,
          tau=0.03,
          rho=0.01,
          S_0=1,E_0=0.005,I_0=0.005,Q_0=0.1,
          K_0=0.02,F_0=0.02,
          sig_obs=0.05),
  nseq=nseq)
new_est_pars <- c("b1","b2","b3","b4","b5","b6","bH",
               "sigma",
               "beta_out","alpha",
               "muEI","muIQ","muQS",
               "tau",
               "rho",
               "S_0", "E_0", "I_0", "Q_0",
               "K_0","F_0")

# Latent FOI with looser ranges, SEIRS
object <- "objects/object_seirs_ornament.R"
source(object)
new_init_vals <- runif_design(
  lower=c(b1=-1,b2=-1,b3=-1,b4=-1,b5=-1,b6=-1,bH=0,bNINO=0,bNINA=-1,
          sigma=0.01,
          beta_out=0.0001,q=0,alpha=0.8,
          delta=1/60,
          muEI=10,muIS=0,muIQ=10,muQS=1,
          tau=0.001,
          rho=0.001,
          S_0=0.5,E_0=0,I_0=0,Q_0=0,
          K_0=0.001,F_0=0.001,
          sig_obs=0.05),
  upper=c(b1=4,b2=4,b3=4,b4=4,b5=4,b6=4,bH=4,bNINO=4,bNINA=1,
          sigma=0.1,
          beta_out=0.01,q=0,alpha=1,
          delta=1/60,
          muEI=30,muIS=0,muIQ=30,muQS=4,
          tau=0.01,
          rho=0.01,
          S_0=1,E_0=0.01,I_0=0.01,Q_0=0.5,
          K_0=0.01,F_0=0.01,
          sig_obs=0.05),
  nseq=nseq)
new_est_pars <- c("b1","b2","b3","b4","b5","b6","bH","bNINO","bNINA",
               "sigma",
               "beta_out","alpha",
               "muEI","muIQ","muQS",
               "tau",
               "rho",
               "S_0", "E_0", "I_0", "Q_0",
               "K_0","F_0")

# Latent FOI, SEIRSEIR
object <- "objects/object_seirseir_enso_tweaked.R"
source(object)
new_init_vals <- runif_design(
  lower=c(b1=-1,b2=-1,b3=-1,b4=-1,b5=-1,b6=-1,bT=0,bNino=0,bNina=-1,
          sigma=0.01,
          beta_out=0.0001,alpha=0.8,
          delta=1/60,delta_I2=1/60,
          muE1I1=10,muI1R1=10,muR1S2=1,muE2I2=10,muI2R2=10,
          eta=0.8,
          tau=0.001,
          rho=0.001,
          S1_0=40,E1_0=0.1,I1_0=0.1,R1_0=0.1,
          S2_0=0.5,E2_0=0.1,I2_0=0.1,R2_0=5,
          K_0=0.001,F_0=0.001,
          sig_obs=0.05),
  upper=c(b1=4,b2=4,b3=4,b4=4,b5=4,b6=4,bT=4,bNino=4,bNina=1,
          sigma=0.1,
          beta_out=0.01,alpha=1,
          delta=1/60,delta_I2=1/20,
          muE1I1=30,muI1R1=30,muR1S2=4,muE2I2=30,muI2R2=30,
          eta=1,
          tau=0.01,
          rho=0.01,
          S1_0=80,E1_0=1,I1_0=1,R1_0=5,
          S2_0=5,E2_0=1,I2_0=1,R2_0=15,
          K_0=0.01,F_0=0.01,
          sig_obs=0.05),
  nseq=nseq)
new_est_pars <- c("b1","b2","b3","b4","b5","b6","bT","bNino","bNina",
               "sigma",
               "beta_out","alpha",
               "delta_I2",
               "muE1I1","muI1R1","muR1S2","muE2I2","muI2R2",
               "eta",
               "tau",
               "rho",
               "S1_0", "E1_0", "I1_0", "R1_0",
               "S2_0", "E2_0", "I2_0", "R2_0",
               "K_0","F_0")

# 4 classes
object <- "objects/object_four_serotypes.R"
source(object)
new_init_vals <- runif_design(
  lower=c(b1=-1,b2=-1,b3=-1,b4=-1,b5=-1,b6=-1,bH=0,bNINO=0,bNINA=-1,
          sigma=0.01,
          beta_out=0.0001,alpha=0.8,
          delta=1/60,delta_I2=1/60,
          muEI=10,muIR=10,muRS=1,
          tau=0.001,
          rho=0.001,
          S_1_0=5,
          E1_1_0=0,E2_1_0=0,E3_1_0=0,E4_1_0=0,
          I1_1_0=0,I2_1_0=0,I3_1_0=0,I4_1_0=0,
          R1_1_0=0.1,R2_1_0=0.1,R3_1_0=0.1,R4_1_0=0.1,
          S1_2_0=5,S2_2_0=5,S3_2_0=5,S4_2_0=5,
          E1_2_0=0,E2_2_0=0,E3_2_0=0,E4_2_0=0,
          I1_2_0=0,I2_2_0=0,I3_2_0=0,I4_2_0=0,
          R_2_0=50,
          K1_0=0.001,K2_0=0.001,K3_0=0.001,K4_0=0.001,
          F1_0=0.001,F2_0=0.001,F3_0=0.001,F4_0=0.001,
          sig_obs=0.05),
  upper=c(b1=4,b2=4,b3=4,b4=4,b5=4,b6=4,bH=4,bNINO=4,bNINA=1,
          sigma=0.1,
          beta_out=0.01,alpha=1,
          delta=1/60,delta_I2=1/20,
          muEI=30,muIR=30,muRS=4,
          tau=0.01,
          rho=0.01,
          S_1_0=15,
          E1_1_0=1,E2_1_0=1,E3_1_0=1,E4_1_0=1,
          I1_1_0=1,I2_1_0=1,I3_1_0=1,I4_1_0=1,
          R1_1_0=1,R2_1_0=1,R3_1_0=1,R4_1_0=1,
          S1_2_0=15,S2_2_0=15,S3_2_0=15,S4_2_0=15,
          E1_2_0=1,E2_2_0=1,E3_2_0=1,E4_2_0=1,
          I1_2_0=1,I2_2_0=1,I3_2_0=1,I4_2_0=1,
          R_2_0=150,
          K1_0=0.01,K2_0=0.01,K3_0=0.01,K4_0=0.01,
          F1_0=0.01,F2_0=0.01,F3_0=0.01,F4_0=0.01,
          sig_obs=0.05),
  nseq=nseq)
new_est_pars <- c("b1","b2","b3","b4","b5","b6","bH","bNINO","bNINA",
               "sigma",
               "beta_out","alpha",
               "delta_I2",
               "muEI","muIR","muRS",
               "tau",
               "rho",
               "S_1_0",
               "E1_1_0","E2_1_0","E3_1_0","E4_1_0",
               "I1_1_0","I2_1_0","I3_1_0","I4_1_0",
               "R1_1_0","R2_1_0","R3_1_0","R4_1_0",
               "S1_2_0","S2_2_0","S3_2_0","S4_2_0",
               "E1_2_0","E2_2_0","E3_2_0","E4_2_0",
               "I1_2_0","I2_2_0","I3_2_0","I4_2_0",
               "R_2_0",
               "K1_0","K2_0","K3_0","K4_0",
               "F1_0","F2_0","F3_0","F4_0")


#SEIRS, full enso, tweaked
object <- "objects/object_seirs_enso_tweaked.R"
source(object)
new_init_vals <- runif_design(
  lower=c(b1=-1,b2=-1,b3=-1,b4=-1,b5=-1,b6=-1,bT=0,bNino=0,bNina=-1,
          sigma=0.01,
          beta_out=0.0001,q=0,alpha=0.8,
          delta=1/60,
          muEI=10,muIS=0,muIQ=10,muQS=1,
          tau=0.001,
          rho=0.001,
          S_0=0.5,E_0=0,I_0=0,Q_0=0,
          K_0=0.001,F_0=0.001,
          sig_obs=0.05),
  upper=c(b1=4,b2=4,b3=4,b4=4,b5=4,b6=4,bT=4,bNino=4,bNina=4,
          sigma=0.1,
          beta_out=0.01,q=0,alpha=1,
          delta=1/60,
          muEI=30,muIS=0,muIQ=30,muQS=4,
          tau=0.01,
          rho=0.01,
          S_0=1,E_0=0.01,I_0=0.01,Q_0=0.5,
          K_0=0.01,F_0=0.01,
          sig_obs=0.05),
  nseq=nseq)
new_est_pars <- c("b1","b2","b3","b4","b5","b6","bT","bNino","bNina",
               "sigma",
               "beta_out","alpha",
               "muEI","muIQ","muQS",
               "tau",
               "rho",
               "S_0", "E_0", "I_0", "Q_0",
               "K_0","F_0")

# 4 classes and now with isolate data!!
object <- "objects/object_isolate_data.R"
source(object)
new_init_vals <- runif_design(
  lower=c(b1=-1,b2=-1,b3=-1,b4=-1,b5=-1,b6=-1,
          bT=-1,bENSO=0,
          beta_out=0.00001,
          sigma=0.01,
          alpha=0.5,
          gamma=0.1,phi=0.1,
          delta=1/60,
          muEI=10,muIR=10,muRS=1,
          rho=-6,rho_C=0,
          nu=0.005,
          S_1_0=5,
          E1_1_0=0,E2_1_0=0,E3_1_0=0,E4_1_0=0,
          I1_1_0=0,I2_1_0=0,I3_1_0=0,I4_1_0=0,
          R1_1_0=0.1,R2_1_0=0.1,R3_1_0=0.1,R4_1_0=0.1,
          S1_2_0=5,S2_2_0=5,S3_2_0=5,S4_2_0=5,
          E1_2_0=0,E2_2_0=0,E3_2_0=0,E4_2_0=0,
          I1_2_0=0,I2_2_0=0,I3_2_0=0,I4_2_0=0,
          R_2_0=50,
          sig_obs=0.05,
          eta=0.025,
          psi=0.001),
  upper=c(b1=4,b2=4,b3=4,b4=4,b5=4,b6=4,
          bT=4,bENSO=4,
          beta_out=0.0005,
          sigma=0.1,
          alpha=1,
          gamma=1,phi=1,
          delta=1/60,
          muEI=30,muIR=30,muRS=4,
          rho=-4,rho_C=0.00002,
          nu=0.2,
          S_1_0=15,
          E1_1_0=1,E2_1_0=1,E3_1_0=1,E4_1_0=1,
          I1_1_0=1,I2_1_0=1,I3_1_0=1,I4_1_0=1,
          R1_1_0=1,R2_1_0=1,R3_1_0=1,R4_1_0=1,
          S1_2_0=15,S2_2_0=15,S3_2_0=15,S4_2_0=15,
          E1_2_0=1,E2_2_0=1,E3_2_0=1,E4_2_0=1,
          I1_2_0=1,I2_2_0=1,I3_2_0=1,I4_2_0=1,
          R_2_0=150,
          sig_obs=0.05,
          eta=0.75,
          psi=0.01),
  nseq=nseq)

bk_iso <- read_csv("data/bk_df_iso.csv")
just_iso <- bk_iso %>% select(iso1:iso4)
just_iso$sums <- just_iso %>% rowSums()
just_iso <- apply(just_iso,1,function(x) return(x/x[5])) %>% t

inits <- unname(just_iso[1,1:4])
init_spread <- abs(MASS::mvrnorm(nseq,inits,0.2*diag(1,4,4)))
init_spread <- t(apply(init_spread, 1, function(x)(x/sum(x))))

cS_1 <- runif(nseq,100,10000)
cE_1 <- runif(nseq,0,10)
cI_1 <- runif(nseq,0,10)
cR_1 <- runif(nseq,10,1000)
cS_2 <- runif(nseq,10,1000)
cE_2 <- runif(nseq,0,10)
cI_2 <- runif(nseq,0,10)
cR_2 <- runif(nseq,10,1000)

cE_1s <- cE_1*init_spread
cI_1s <- cI_1*init_spread
cR_1s <- cR_1*init_spread
cS_2s <- cS_2*init_spread
cE_2s <- cE_2*init_spread
cI_2s <- cI_2*init_spread

new_init_vals[21:46] <- unname(bind_cols(cS_1,cE_1s,cI_1s,cR_1s,cS_2s,cE_2s,cI_2s,cR_2))

new_est_pars <- c("b1","b2","b3","b4","b5","b6","bT","bENSO",
               "sigma",
               "beta_out","alpha",
               "gamma","phi",
               "muEI","muIR","muRS",
               "rho","rho_C",
               "nu",
               "S_1_0",
               "E1_1_0","E2_1_0","E3_1_0","E4_1_0",
               "I1_1_0","I2_1_0","I3_1_0","I4_1_0",
               "R1_1_0","R2_1_0","R3_1_0","R4_1_0",
               "S1_2_0","S2_2_0","S3_2_0","S4_2_0",
               "E1_2_0","E2_2_0","E3_2_0","E4_2_0",
               "I1_2_0","I2_2_0","I3_2_0","I4_2_0",
               "R_2_0",
               "eta",
               "psi")


# Complete model and with iso
object <- "objects/object_track_all.R"
source(object)
new_init_vals <- runif_design(
  lower=c(
    g12=0,g13=0,g14=0,g21=0,g23=0,g24=0,g31=0,g32=0,g34=0,g41=0,g42=0,g43=0,
    p12=0,p13=0,p14=0,p21=0,p23=0,p24=0,p31=0,p32=0,p34=0,p41=0,p42=0,p43=0, 
    bO1=0,bO2=0,bO3=0,bO4=0,
    beta1=0.2,beta2=0.2,beta3=0.2,beta4=0.2,
    b1=-1,b2=-1,b3=-1,b4=-1,b5=-1,b6=-1,bT=-1,bNino=0,bNina=-4,
    sigma=0.01,
    alpha=0.5,
    delta=1/60,muEI=10,muIR=10,muRS=1,
    nu=0.005,rho=0.001,
    S_0=1000,
    E1_0=0,E2_0=0,E3_0=0,E4_0=0,
    I1_0=0,I2_0=0,I3_0=0,I4_0=0,
    R1_0=2,R2_0=2,R3_0=2,R4_0=2,
    S1_0=20,S2_0=20,S3_0=20,S4_0=20,
    E12_0=0,E13_0=0,E14_0=0,E21_0=0,E23_0=0,E24_0=0,E31_0=0,E32_0=0,E34_0=0,E41_0=0,E42_0=0,E43_0=0,
    I12_0=0,I13_0=0,I14_0=0,I21_0=0,I23_0=0,I24_0=0,I31_0=0,I32_0=0,I34_0=0,I41_0=0,I42_0=0,I43_0=0,
    R_0=100,
    sig_obs=0.05,
    eta=0.1,
    psi=0.001),
  upper=c(
    g12=1,g13=1,g14=1,g21=1,g23=1,g24=1,g31=1,g32=1,g34=1,g41=1,g42=1,g43=1,
    p12=1,p13=1,p14=1,p21=1,p23=1,p24=1,p31=1,p32=1,p34=1,p41=1,p42=1,p43=1, 
    bO1=0.0002,bO2=0.0002,bO3=0.0002,bO4=0.0002,
    beta1=1,beta2=1,beta3=1,beta4=1,
    b1=4,b2=4,b3=4,b4=4,b5=4,b6=4,bT=4,bNino=4,bNina=4,
    sigma=0.1,
    alpha=0.9,
    delta=1/60,muEI=30,muIR=30,muRS=4,
    nu=0.2,rho=0.05,
    S_0=10000,
    E1_0=5,E2_0=5,E3_0=5,E4_0=5,
    I1_0=5,I2_0=5,I3_0=5,I4_0=5,
    R1_0=20,R2_0=20,R3_0=20,R4_0=20,
    S1_0=200,S2_0=200,S3_0=200,S4_0=200,
    E12_0=5,E13_0=5,E14_0=5,E21_0=5,E23_0=5,E24_0=5,E31_0=5,E32_0=5,E34_0=5,E41_0=5,E42_0=5,E43_0=5,
    I12_0=5,I13_0=5,I14_0=5,I21_0=5,I23_0=5,I24_0=5,I31_0=5,I32_0=5,I34_0=5,I41_0=5,I42_0=5,I43_0=5,
    R_0=1000,
    sig_obs=0.05,
    eta=0.8,
    psi=0.01),
  nseq=nseq)
new_est_pars <- c(
    sprintf("g%d",idx),
    sprintf("p%d",idx),
    sprintf("bO%d",1:4),
    sprintf("beta%d",1:4),
    sprintf("b%d",1:6),
    "bT","bNino","bNina",
    "sigma",
    "alpha",
    "muEI","muIR","muRS",
    "nu","rho",
    "S_0",
    sprintf("E%d_0",1:4),
    sprintf("I%d_0",1:4),
    sprintf("R%d_0",1:4),
    sprintf("S%d_0",1:4),
    sprintf("E%d_0",idx),
    sprintf("I%d_0",idx),
    "R_0",
    "eta",
    "psi"
    )

# Complete model but without iso
object <- "objects/object_track_all_no_iso.R"
source(object)
new_init_vals <- runif_design(
  lower=c(
    g12=0,g13=0,g14=0,g21=0,g23=0,g24=0,g31=0,g32=0,g34=0,g41=0,g42=0,g43=0,
    p12=0,p13=0,p14=0,p21=0,p23=0,p24=0,p31=0,p32=0,p34=0,p41=0,p42=0,p43=0, 
    bO1=0,bO2=0,bO3=0,bO4=0,
    beta1=0.2,beta2=0.2,beta3=0.2,beta4=0.2,
    b1=-1,b2=-1,b3=-1,b4=-1,b5=-1,b6=-1,bT=-1,bNino=0,bNina=-4,
    sigma=0.01,
    alpha=0.5,
    delta=1/60,muEI=10,muIR=10,muRS=1,
    nu=0.005,rho=0.001,
    S_0=1000,
    E1_0=0,E2_0=0,E3_0=0,E4_0=0,
    I1_0=0,I2_0=0,I3_0=0,I4_0=0,
    R1_0=2,R2_0=2,R3_0=2,R4_0=2,
    S1_0=20,S2_0=20,S3_0=20,S4_0=20,
    E12_0=0,E13_0=0,E14_0=0,E21_0=0,E23_0=0,E24_0=0,E31_0=0,E32_0=0,E34_0=0,E41_0=0,E42_0=0,E43_0=0,
    I12_0=0,I13_0=0,I14_0=0,I21_0=0,I23_0=0,I24_0=0,I31_0=0,I32_0=0,I34_0=0,I41_0=0,I42_0=0,I43_0=0,
    R_0=100,
    sig_obs=0.05),
  upper=c(
    g12=1,g13=1,g14=1,g21=1,g23=1,g24=1,g31=1,g32=1,g34=1,g41=1,g42=1,g43=1,
    p12=1,p13=1,p14=1,p21=1,p23=1,p24=1,p31=1,p32=1,p34=1,p41=1,p42=1,p43=1, 
    bO1=0.0002,bO2=0.0002,bO3=0.0002,bO4=0.0002,
    beta1=1,beta2=1,beta3=1,beta4=1,
    b1=4,b2=4,b3=4,b4=4,b5=4,b6=4,bT=4,bNino=4,bNina=4,
    sigma=0.1,
    alpha=0.9,
    delta=1/60,muEI=30,muIR=30,muRS=4,
    nu=0.2,rho=0.05,
    S_0=10000,
    E1_0=5,E2_0=5,E3_0=5,E4_0=5,
    I1_0=5,I2_0=5,I3_0=5,I4_0=5,
    R1_0=20,R2_0=20,R3_0=20,R4_0=20,
    S1_0=200,S2_0=200,S3_0=200,S4_0=200,
    E12_0=5,E13_0=5,E14_0=5,E21_0=5,E23_0=5,E24_0=5,E31_0=5,E32_0=5,E34_0=5,E41_0=5,E42_0=5,E43_0=5,
    I12_0=5,I13_0=5,I14_0=5,I21_0=5,I23_0=5,I24_0=5,I31_0=5,I32_0=5,I34_0=5,I41_0=5,I42_0=5,I43_0=5,
    R_0=1000,
    sig_obs=0.05),
  nseq=nseq)
new_est_pars <- c(
    sprintf("g%d",idx),
    sprintf("p%d",idx),
    sprintf("bO%d",1:4),
    sprintf("beta%d",1:4),
    sprintf("b%d",1:6),
    "bT","bNino","bNina",
    "sigma",
    "alpha",
    "muEI","muIR","muRS",
    "nu","rho",
    "S_0",
    sprintf("E%d_0",1:4),
    sprintf("I%d_0",1:4),
    sprintf("R%d_0",1:4),
    sprintf("S%d_0",1:4),
    sprintf("E%d_0",idx),
    sprintf("I%d_0",idx),
    "R_0"
    )

sim_vals <- c(
    g12=0.8,g21=0.8,
    p12=0.9,p21=0.9,
    bO1=0.0001,bO2=0.0001,
    beta1=0.2,beta2=0.2,
    b1=0.05,b2=2.8,b3=0.1,b4=0.2,b5=1.4,b6=1.4,bT=1.5,bNino=2.5,bNina=1,
    sigma=0.1,
    alpha=0.54,
    delta=1/60,muEI=84,muIR=304,muRS=1,
    nu=0.03,rho=0.005,
    S_0=1000,
    E1_0=.1,E2_0=.15,
    I1_0=.15,I2_0=.1,
    R1_0=.2,R2_0=.1,
    S1_0=10,S2_0=20,
    E12_0=0.1,E21_0=0.2,
    I12_0=0.2,I21_0=0.1,
    R_0=100,
    sig_obs=0.05,
    n_sero=n)

# n-serotype model, n=2
object <- "objects/object_n_serotypes.R"
source(object)
new_init_vals <- runif_design(
  lower=c(
    g12=0,g21=0,
    p12=0,p21=0,
    bO1=0,bO2=0,
    beta1=0.2,beta2=0.2,
    b1=-1,b2=-1,b3=-1,b4=-1,b5=-1,b6=-1,bT=-1,bNino=0,bNina=-2,
    sigma=0.01,
    alpha=0.5,
    delta=1/60,muEI=10,muIR=10,muRS=1,
    nu=0.005,rho=0.001,
    S_0=1000,
    E1_0=0,E2_0=0,
    I1_0=0,I2_0=0,
    R1_0=2,R2_0=2,
    S1_0=20,S2_0=20,
    E12_0=0,E21_0=0,
    I12_0=0,I21_0=0,
    R_0=100,
    sig_obs=0.05,
    n_sero=2),
  upper=c(
    g12=1,g21=1,
    p12=1,p21=1,
    bO1=0.0002,bO2=0.0002,
    beta1=1,beta2=1,
    b1=2,b2=2,b3=2,b4=2,b5=2,b6=2,bT=2,bNino=2,bNina=2,
    sigma=0.1,
    alpha=0.9,
    delta=1/60,muEI=30,muIR=30,muRS=4,
    nu=0.2,rho=0.05,
    S_0=10000,
    E1_0=5,E2_0=5,
    I1_0=5,I2_0=5,
    R1_0=20,R2_0=20,
    S1_0=200,S2_0=200,
    E12_0=5,E21_0=5,
    I12_0=5,I21_0=5,
    R_0=1000,
    sig_obs=0.05,
    n_sero=2),
  nseq=nseq)

new_est_pars <- c(
    sprintf("g%s",idx),
    sprintf("p%s",idx),
    sprintf("bO%d",1:n),
    sprintf("beta%d",1:n),
    sprintf("b%d",1:6),
    "bT","bNino","bNina",
    "sigma",
    "alpha",
    "muEI","muIR","muRS",
    "nu","rho",
    "S_0",
    sprintf("E%d_0",1:n),
    sprintf("I%d_0",1:n),
    sprintf("R%d_0",1:n),
    sprintf("S%d_0",1:n),
    sprintf("E%s_0",idx),
    sprintf("I%s_0",idx),
    "R_0")


# Jaime's model
object <- "objects/object_jaime.R"
source(object)
new_init_vals <- runif_design(
  lower=c(b1=-1,b2=-1,b3=-1,b4=-1,b5=-1,b6=-1,bEFF=-1,bNino=0,bNina=-1,
          sigma=0.001,beta_out=0.0001,alpha=0.5,
          delta=1/60,
          muEI=365/30,muIRh=365/30,muIRl=365/30,muRhRl=365/30,muRlS=365/720,
          theta=0.1,
          tau=0.001,rho=0.001,
          S_0=0.5,E_0=0,I_0=0,Rh_0=0,Rl_0=0,
          K_0=0.001,F_0=0.001,
          sig_obs=0.05),
  upper=c(b1=4,b2=4,b3=4,b4=4,b5=4,b6=4,bEFF=2,bNino=4,bNina=2,
          sigma=0.1,beta_out=0.01,alpha=1,
          delta=1/60,
          muEI=365/10,muIRh=365/10,muIRl=365/10,muRhRl=365/10,muRlS=365/180,
          theta=1,
          tau=0.01,rho=0.01,
          S_0=1,E_0=0.01,I_0=0.01,Rh_0=0.3,Rl_0=0.3,
          K_0=0.01,F_0=0.01,
          sig_obs=0.05),
  nseq=nseq)
new_est_pars <- c("b1","b2","b3","b4","b5","b6","bEFF","bNino","bNina",
               "sigma","beta_out","alpha",
               "muEI","muIRh","muIRl","muRhRl","muRlS",
               "theta",
               "tau","rho",
               "S_0", "E_0", "I_0", "Rh_0", "Rl_0",
               "K_0","F_0")

# My new model
object <- "objects/object_test.R"
source(object)
new_init_vals <- runif_design(
  lower=c(b1=-1,b2=-1,b3=-1,b4=-1,b5=-1,b6=-1,bEFF=-1,bNino=0,bNina=-1,
          sigma=0.001,beta_out=0.0001,alpha=0.5,
          delta=1/60,
          muE1I1=365/30,muI1R1=365/30,muR1H=365/720,muE2I2=365/30,
          tau=0.001,rho=0.001,
          eta=20,omega=365/10,
          S1_0=0.5,E1_0=0,I1_0=0,R1_0=0,H_0=0,
          S2_0=0.5,E2_0=0,I2_0=0,
          K_0=0.001,F_0=0.001,
          sig_obs=0.05),
  upper=c(b1=4,b2=4,b3=4,b4=4,b5=4,b6=4,bEFF=2,bNino=4,bNina=2,
          sigma=0.1,beta_out=0.01,alpha=1,
          delta=1/60,
          muE1I1=365/10,muI1R1=365/10,muR1H=365/180,muE2I2=365/10,
          tau=0.01,rho=0.01,
          eta=200,omega=365/0.5,
          S1_0=1,E1_0=0.01,I1_0=0.01,R1_0=0.2,H_0=0.2,
          S2_0=1,E2_0=0.01,I2_0=0.01,
          K_0=0.01,F_0=0.01,
          sig_obs=0.05),
  nseq=nseq)
new_est_pars <- c("b1","b2","b3","b4","b5","b6","bEFF","bNino","bNina",
               "sigma",
               "beta_out","alpha",
               "muE1I1","muI1R1","muR1H","muE2I2",
               "eta","omega",
               "tau",
               "rho",
               "S1_0","E1_0","I1_0","R1_0","H_0",
               "S2_0","E2_0","I2_0",
               "K_0","F_0")

# Jaime's model, updated to be SEIRSEIR
object <- "objects/object_jaime_seirseir.R"
source(object)
new_init_vals <- runif_design(
  lower=c(b1=-1,b2=-1,b3=-1,b4=-1,b5=-1,b6=-1,bEFF=-1,bNino=0,bNina=-1,
          sigma=0.001,beta_out=0.0001,alpha=0.5,
          delta=1/60,
          muEI=365/30,muIR=365/30,muRhRl=365/30,muRlS=365/720,
          theta=0.1,p1=0.1,p2=0.1,
          tau=0.001,rho=0.001,
          S1_0=0.5,E1_0=0,I1_0=0,Rh_0=0,Rl_0=0,
          S2_0=0.5,E2_0=0,I2_0=0,
          K_0=0.001,F_0=0.001,
          sig_obs=0.05),
  upper=c(b1=4,b2=4,b3=4,b4=4,b5=4,b6=4,bEFF=2,bNino=4,bNina=2,
          sigma=0.1,beta_out=0.01,alpha=1,
          delta=1/60,
          muEI=365/10,muIR=365/10,muRhRl=365/10,muRlS=365/180,
          theta=1.5,p1=0.9,p2=0.9,
          tau=0.01,rho=0.01,
          S1_0=1,E1_0=0.01,I1_0=0.01,Rh_0=0.3,Rl_0=0.3,
          S2_0=1,E2_0=0.01,I2_0=0.01,
          K_0=0.01,F_0=0.01,
          sig_obs=0.05),
  nseq=nseq)
new_est_pars <- c("b1","b2","b3","b4","b5","b6","bEFF","bNino","bNina",
               "sigma","beta_out","alpha",
               "muEI","muIR","muRhRl","muRlS",
               "p1","p2",
               "theta",
               "tau","rho",
               "S1_0","E1_0","I1_0","Rh_0","Rl_0",
               "S2_0","E2_0","I2_0",
               "K_0","F_0")

```

Prepare new param guesses
```{r}
new_type <- "cluster"
new_date <- "5_23"
new_fit <- "f"

nseq <- 500

#Recent SEIRS
object <- "cluster_runs/run_5_23_a/object.R"
source(object)
new_init_vals <- sobol_design(
  lower=c(sigma=0.001,
          theta=0,phi=20,
          bNina=-2,bNino=0,
          beta_out=0.0001,alpha=0.8,
          muEI=365/30,muIR=365/30,muRS=0.5,
          delta=1/60,
          tau=0.001,
          rho=0.001,
          S_0=0.5,E_0=0,I_0=0,R_0=0,
          K_0=0.001,F_0=0.001,
          sig_obs=5),
  upper=c(sigma=0.01,
          theta=4,phi=120,
          bNina=2,bNino=4,
          beta_out=0.001,alpha=1,
          muEI=365/10,muIR=365/10,muRS=4,
          delta=1/60,
          tau=0.01,
          rho=0.05,
          S_0=1,E_0=0.01,I_0=0.01,R_0=0.5,
          K_0=0.01,F_0=0.01,
          sig_obs=15),
  nseq=nseq)
new_est_pars <- c("sigma",
               "theta","phi",
               "bNina","bNino",
               "beta_out","alpha",
               "muEI","muIR","muRS",
               "tau",
               "rho",
               "S_0","E_0","I_0","R_0",
               "K_0","F_0",
               "sig_obs")

#Rainfall model
object <- "cluster_runs/run_5_23_f/object.R"
source(object)
new_init_vals <- sobol_design(
  lower=c(sigma=0.001,
          kappa=3.9*10^(-5),W_max=150,
          n1=4,n2=8,K_a=0.05,K_b=0.9,
          theta=0,
          bNino=0,bNina=-2,
          beta_out=0.0001,alpha=0.8,
          muEI=365/30,muIR=365/30,muRS=0.5,
          delta=1/60,
          tau=0.001,
          rho=0.001,
          S_0=0.5,E_0=0,I_0=0,R_0=0,
          K_0=0.001,F_0=0.001,
          W_0=0,
          sig_obs=5),
  upper=c(sigma=0.01,
          kappa=3.9*10^(-5),W_max=300,
          n1=8,n2=15,K_a=0.2,K_b=1,
          theta=4,
          bNino=3,bNina=2,
          beta_out=0.001,alpha=1,
          muEI=365/10,muIR=365/10,muRS=4,
          delta=1/60,
          tau=0.01,
          rho=0.05,
          S_0=1,E_0=0.01,I_0=0.01,R_0=0.5,
          K_0=0.01,F_0=0.01,
          W_0=0.05,
          sig_obs=15),
  nseq=nseq)
new_est_pars <- c("sigma",
               "kappa","W_max",
               "n1","n2","K_a","K_b",
               "theta",
               "bNina","bNino",
               "beta_out","alpha",
               "muEI","muIR","muRS",
               "tau",
               "rho",
               "S_0","E_0","I_0","R_0",
               "K_0","F_0",
               "W_0",
               "sig_obs")

new_init_vals <- new_init_vals %>% select(all_of(new_est_pars))
new_fixed_values <- params[!names(params)%in%new_est_pars]
new_init_vals <- cbind(new_init_vals,t(data.frame(new_fixed_values)))

path <- paste0("./",new_type,"_runs/run_",new_date,"_",new_fit)
if (!file.exists(path)) dir.create(path)

write_csv(new_init_vals,paste0(path,"/pars.csv"))
#file.copy(object,paste0(path,"/object.R"))

```

Prepare param guesses for refinement (useless)
```{r}
#model_fit <- read.csv(paste0(file_path,"/results_jas.csv"))

guesses <- model_fit %>% 
    filter(loglik>max(loglik)-30 & loglik.se<5) %>% 
    select(-loglik,-loglik.se,-X,-sample,-flag)

guesses <- apply(guesses,2,function(x) runif(500,min(x),max(x))) %>% as.data.frame()
#write_csv(guesses,"cluster_runs/run_1_16_b/pars.csv")

```

Construct profiling initial values
```{r}
n_samples <- 100
splits <- 50

mle <- model_fit %>% select(all_of(par_names)) %>% slice(1)

profiles <- model_fit %>% 
    filter(loglik>max(loglik)-40,loglik.se<4) %>%
    select(all_of(est_pars))

profiles <- apply(profiles,2,function(x) {
    rep(seq(from=min(x),to=max(x),length.out=splits),each=n_samples)
    }) %>% as.data.frame()

init_vals <- mle[rep(1,5000),]
rownames(init_vals) <- 1:5000

#writeLines(names(profiles), "pars.txt")

write_csv(profiles,"profiling_stuff/profiles.csv")
write_csv(init_vals,"profiling_stuff/init_vals.csv")

```

Prepare separate param files for each 3 month combo
```{r}
init_vals <- read_csv(paste0(path,"/pars.csv"))
options <- c("bAMJ","bMJJ","bJJA","bJAS")
for (i in options) {
    tmp <- init_vals
    tmp[options[options!=i]]=0
    write_csv(tmp,paste0(path,"/pars_",i,".csv"))
}

```

Run on local
```{r}
type <- "cluster"
date <- "5_6"
fit <- "a"

#init_vals <- new_init_vals[1:8,]
#est_pars <- new_est_pars

#pomped <- construct_pomp(bk_sim,covariates)

file_path <- paste0("./",type,"_runs/run_",date,"_",fit)

source(paste0(file_path,"/object.R"))

init_vals <- read.csv(paste0(file_path,"/pars.csv"))

if (file.exists(paste0(file_path,"/bk_df.csv"))) {
    bk <- read_csv(paste0(file_path,"/bk_df.csv"))
} else {bk <- read_csv("data/bk_df.csv")}

pars <- names(init_vals)
est_pars <- names(init_vals)[apply(init_vals,2,function(x) {max(x)-min(x)})!=0]
fixed_pars <- pars[!pars%in%est_pars]

covariates <- covariate_table(
    bk %>% select(all_of(covars)),
    times = "time")
  
t_extrap <- with(bk, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

pomped <- construct_pomp(bk,covariates)

#filter(loglik>max(loglik)-20,loglik.se<2) |>
#sapply(range) -> box

#box <- model_fit %>% 
#    filter(loglik>max(loglik)-30,loglik.se<5) %>% 
#    select(all_of(pars)) %>% 
#    sapply(range)

#paste0("new_init_vals <- runif_design(lower=c(",
#       paste0(colnames(box),"=",as.character(box[1,]),collapse=","),"),",
#       "upper=c(",
#       paste0(colnames(box),"=",as.character(box[2,]),collapse=","),"),",
#       "nseq=8)") %>% str2expression %>% eval.parent

paste0("rw.sd<-rw_sd(",
       paste0(est_pars,
              ifelse(
                  str_sub(est_pars,-2,-1)!="_0",
                     paste0("=0.02"),
                     paste0("=ivp(0.01)")),
              collapse=","),
       ")") %>%
    str2expression %>%
    eval.parent

#path <- paste0("./",new_type,"_runs/run_",new_date,"_",new_fit)
#if (!file.exists(path)) dir.create(path)

#write_csv(init_vals,paste0(path,"/pars.csv"))
#file.copy(object,paste0(path,"/object.R"))

source("./helper_functions_2.R")
mif2 <- run_fitting(po=pomped,
            n_cores=1,
            parameters=init_vals[1,],
            seed_num=seed,
            rdd=rw.sd,
            allow_parallel=F,
            start_index=1,
            output_to_file=T,
            output_result=paste0("../../results.csv"),
            output_log=paste0("../../log.txt"),
            output_format="data.frame")


traces <- data.frame(mif2@traces,iteration=0:Nmif)
cond <- data.frame(loglik=mif2@cond.logLik,time=bk$time)
eff <- data.frame(eff=mif2@eff.sample.size,time=bk$time)

examine <- bk %>% mutate(time=round(time,0)) %>% 
    group_by(time) %>% 
    summarise(present=max(el_nino))

ggplot(bk,aes(x=time,y=el_nino))+geom_line()+theme_classic()

#source(paste0(file_path,"/object.R"))
#pomped <- construct_pomp(bk,covariates)
#mf <- mif2(pomped,
#           Np = 100,
#           Nmif = 10,
#           cooling.type = "geometric",
#           cooling.fraction.50 = 0.5,
#           params = params,
#           rw.sd = rw.sd)

```

Retrodict seirs
```{r}
source("objects/object_seirs_multinom.R")
pomped <- construct_pomp(bk,covariates)
beta <- 3
beta_none <- -4
sim_vals <- c(b1=beta_none,b2=beta_none,b3=beta/2,b4=beta,b5=beta,b6=beta/2,
              beta_out=0.01,
              bH=5,
              sigma=0.005,
              sig_obs=0.05,
              rho=0.005,
              mu=1/60,incub=365/10,infect=365/10,wane=2,
              S_0=0.5,E_0=0,I_0=0.1,R_0=1)

coef(pomped,names(sim_vals)) <- unname(sim_vals)
sims <- pomped %>% simulate(nsim = 1,include.data = T,format = "data.frame")

sims_cases <- sims %>% 
        select(time,.id,cases,C:R) %>%
        pivot_longer(cols=c(cases:R),names_to="source",values_to="count") %>% 
        na.omit() %>% 
        filter(!(.id==1 & source=="cases"))
sims_cases$source <- factor(sims_cases$source,levels=c("S","E","I","R","C","cases"))
ggplot(sims_cases %>% filter(source%in%c("C","cases")),
       aes(x=time,y=count))+
    geom_line()+
    theme_classic()+
    facet_grid(source~.,scales = "free_y")


source("./helper_functions.R")
sims_cases <- run_simulation(pomped)
plot_simulation(sims_cases, CI=c(0.5,0.95))



bk_sim <- bk
bk_sim$cases <- sims %>% filter(.id==1) %>% pull(C) %>% round()

write_csv(bk_sim,"bk_df_sim.csv")

pomped <- construct_pomp(bk_sim,covariates)

```

Retrodict SEIRSEIR
```{r}
source("objects/object_seirseir_multinom.R")
pomped <- construct_pomp(bk,covariates)

beta <- 5
beta_none <- -4
sim_vals <- c(b1=beta_none,b2=beta_none,b3=beta/2,b4=beta/2,b5=beta,b6=beta/2,
            bH=2,
            beta_out=0.01,
            sigma=0.005,
            sig_obs=0.1,
            mu=1/60,mu_I2=1/20,
            incub1=365/10,infect1=365/10,
            incub2=365/10,infect2=365/10,
            wane=2,
            eta=0.75,
            q=1,
            rho=0.05,
            S1_0=0.1,E1_0=0,I1_0=0.1,R1_0=1,
            S2_0=0.1,E2_0=0,I2_0=0,R2_0=1)

coef(pomped,names(sim_vals)) <- unname(sim_vals)
sims <- pomped %>% simulate(nsim = 1,include.data = T,format = "data.frame")

sims_cases <- sims %>% 
        select(time,.id,cases,C:R2) %>%
        pivot_longer(cols=c(cases:R2),names_to="source",values_to="count") %>% 
        na.omit() %>% 
        filter(!(.id==1 & source=="cases"))
sims_cases$source <- factor(sims_cases$source,
                            levels=c("S1","E1","I1","R1",
                                     "S2","E2","I2","R2",
                                     "C","cases"))

ggplot(sims_cases %>% filter(source%in%c("cases","C")),
       aes(x=time,y=count))+
    geom_line()+
    theme_classic()+
    facet_grid(source~.,scales = "free_y")

```

Retrodict seirs with sin function
```{r}
source("objects/object_seirs_adj.R")
pomped <- construct_pomp(bk %>% filter(time<2000),covariates)

sim_vals <- c(beta=100,delta=1,omega=2*pi,phi=-2.5,
              sigma=0.01,
              mu=1/60,incub=50,infect=50,wane=6,
              rho=0.01,
              sig_obs=0.01,
              S_0=0.1,E_0=0,I_0=0.1,R_0=1)

coef(pomped,names(sim_vals)) <- unname(sim_vals)
sims <- pomped %>% simulate(nsim = 1,include.data = T,format = "data.frame")

sims_cases <- sims %>% 
        select(time,.id,cases,C:R) %>%
        pivot_longer(cols=c(cases:R),names_to="source",values_to="count") %>% 
        na.omit() %>% 
        filter(!(.id==1 & source=="cases"))
sims_cases$source <- factor(sims_cases$source,levels=c("S","E","I","R","C","cases"))
ggplot(sims_cases,
       aes(x=time,y=count))+
    geom_line()+
    theme_classic()+
    facet_grid(source~.,scales = "free_y")



source("./helper_functions.R")
sims_cases <- run_simulation(pomped)
plot_simulation(sims_cases, CI=c(0.5,0.95))


beta=sim_vals["beta"]
delta=sim_vals["delta"]
omega=sim_vals["omega"]
phi=sim_vals["phi"]
t <- seq(from=0,to=1,length.out=100)
ggplot(data.frame(t,cases=beta*(1+delta*sin(omega*t+phi))),aes(x=t,y=cases))+
    geom_line()+
    theme_classic()+
    ylim(0,beta+beta*1.5*delta)

```

Retrodict four classes
```{r}
source("objects/object_four_serotypes.R")
pomped <- construct_pomp(bk,covariates)

sim_vals <- c(b1=-0.25,b2=1.8,b3=0.8,b4=4,b5=0.75,b6=2.6,bH=3,bNINO=3,bNINA=-1,
              sigma=0.06,
              beta_out=0.004,alpha=0.9,
              delta=1/60,delta_I2=1/20,
              muEI=9.1,muIR=8.8,muRS=4.3,
              tau=0.01,
              rho=0.01,
              S_1_0=10,
              E1_1_0=0.2,E2_1_0=0.2,E3_1_0=0.2,E4_1_0=0.2,
              I1_1_0=0.2,I2_1_0=0.2,I3_1_0=0.2,I4_1_0=0.2,
              R1_1_0=0.5,R2_1_0=0.5,R3_1_0=0.5,R4_1_0=0.5,
              S1_2_0=10,S2_2_0=10,S3_2_0=10,S4_2_0=10,
              E1_2_0=0,E2_2_0=0,E3_2_0=0,E4_2_0=0,
              I1_2_0=0,I2_2_0=0,I3_2_0=0,I4_2_0=0,
              R_2_0=100,
              K1_0=0.01,K2_0=0.01,K3_0=0.01,K4_0=0.01,
              F1_0=0.01,F2_0=0.01,F3_0=0.01,F4_0=0.01,
              sig_obs=0.05)

coef(pomped,names(sim_vals)) <- unname(sim_vals)
sims <- pomped %>% simulate(nsim = 1,include.data = T,format = "data.frame")

sims_cases <- sims %>% 
        select(time,.id,cases,C) %>%
        pivot_longer(cols=c(cases,C),names_to="source",values_to="count") %>% 
        na.omit() %>% 
        filter(!(.id==1 & source=="cases"))
sims_cases$source <- factor(sims_cases$source,levels=c("C","cases"))
ggplot(sims_cases, aes(x=time,y=count))+
    geom_line()+
    theme_classic()+
    facet_grid(source~.,scales = "free_y")

pomped %>% pfilter(Np=100,params=sim_vals) %>% logLik

source("./helper_functions.R")
sims_cases <- run_simulation(pomped)
plot_simulation(sims_cases, CI=c(0.5,0.95))

```

Retrodict latent foi seirs
```{r}
source("objects/object_seirs_ornament.R")
pomped <- construct_pomp(bk,covariates)
sim_vals <- c(b1=-0.25,b2=1.8,b3=0.8,b4=4,b5=0.75,b6=2.6,bH=2,
              sigma=0.06,
              beta_out=0.004,q=0,alpha=.9,
              delta=1/60,
              muEI=9.1,muIS=0,muIQ=8.8,muQS=4.3,
              tau=0.01,
              rho=0.001,
              S_0=0.99,E_0=0.002,I_0=0.002,Q_0=0.005,
              K_0=0.01,F_0=0.01,
              sig_obs=0.05)

coef(pomped,names(sim_vals)) <- unname(sim_vals)
sims <- pomped %>% simulate(nsim = 1,include.data = T,format = "data.frame")

sims_cases <- sims %>% 
        select(time,.id,cases,C:Q) %>%
        pivot_longer(cols=c(cases:Q),names_to="source",values_to="count") %>% 
        na.omit() %>% 
        filter(!(.id==1 & source=="cases"))
sims_cases$source <- factor(sims_cases$source,levels=c("S","E","I","Q","C","cases"))
ggplot(sims_cases %>% filter(source%in%c("C","cases")),
       aes(x=time,y=count))+
    geom_line()+
    theme_classic()+
    facet_grid(source~.,scales = "free_y")

pomped %>% pfilter(Np=100,params=sim_vals) %>% logLik

source("./helper_functions.R")
sims_cases <- run_simulation(pomped)
plot_simulation(sims_cases, CI=c(0.5,0.95))

```

Retrodict latent foi seirseir
```{r}
source("objects/object_seirseir_ornament.R")
pomped <- construct_pomp(bk,covariates)
sim_vals <- c(b1=-0.25,b2=1.8,b3=0.8,b4=4,b5=0.75,b6=2.6,bH=2,
              sigma=0.06,
              beta_out=0.004,alpha=.9,
              delta=1/60,delta_I2=1/20,
              muE1I1=9,muI1R1=9,muR1S2=4,muE2I2=9,muI2R2=9,
              eta=0.75,
              tau=0.01,
              rho=0.005,
              S1_0=50,E1_0=0.1,I1_0=0.1,R1_0=1,
              S2_0=1,E2_0=0.1,I2_0=0.1,R2_0=10,
              K_0=0.01,F_0=0.01,
              sig_obs=0.05)

coef(pomped,names(sim_vals)) <- unname(sim_vals)
sims <- pomped %>% simulate(nsim = 1,include.data = T,format = "data.frame")

sims_cases <- sims %>% 
        select(time,.id,cases,C) %>%
        pivot_longer(cols=c(cases,C),names_to="source",values_to="count") %>% 
        na.omit() %>% 
        filter(!(.id==1 & source=="cases"))
sims_cases$source <- factor(sims_cases$source,levels=c("C","cases"))
ggplot(sims_cases,
       aes(x=time,y=count))+
    geom_line()+
    theme_classic()+
    facet_grid(source~.,scales = "free_y")

pomped %>% pfilter(Np=100,params=sim_vals) %>% logLik

source("./helper_functions.R")
sims_cases <- run_simulation(pomped)
plot_simulation(sims_cases, CI=c(0.5,0.95))

```

Plot splines
```{r}
splines <- exp(rowSums(bk[,8:13]*sim_vals[1:6][col(bk[,8:13])]))
times <- bk$time
ggplot(data.frame(times,splines) %>% filter(times<1971),aes(x=times,y=splines))+geom_line()+theme_classic()


bk[,c(1,8:13)] %>% 
    pivot_longer(cols=season1:season6,
                                names_to="spline",
                                values_to="value") %>% 
    filter(time<1971) %>% 
    ggplot(aes(x=time,y=value,color=spline))+
    geom_line()+
    theme_classic()

```

Simulate from four serotypes
```{r}
source("objects/object_four_serotypes.R")
pomped <- construct_pomp(bk,covariates)

pars <- names(mle)
coef(pomped,pars) <- unname(mle[pars])

source("./helper_functions.R")
sims_cases <- run_simulation(pomped)

plot_simulation(sims_cases, CI=c(0.5,0.95),mode="traj")
plot_simulation(sims_cases, CI=c(0.5,0.95),mode="ribbon")

sims_cases <- sims_cases %>% filter(Type!="Data") %>% select(-c(.id,Type))
sim <- sims_cases %>% group_by(time) %>% summarise(Cases=mean(Cases))

bk_sim <- bk
bk_sim$cases <- sim$Cases
write_csv(bk_sim,"bk_df_sim.csv")

head(sim$Cases)

```

Simulate from four serotypes with serotypes introduced at specific times
```{r}
source("objects/object_introduce_sero.R")
pomped <- construct_pomp(bk,covariates)

sim_vals <- c(b1=0.05,b2=2.8,b3=0.1,b4=0.2,b5=1.4,b6=1.4,
              bH=2,bENSO=2,
              beta_out=0.002,
          sigma=0.1,
          alpha=0.54,
          delta=1/60,delta_I2=0.0072,
          muEI=84,muIR=304,muRS=3.76,
          tau=0.05,
          rho=0.005,
          S_1_0=10000,
          E1_1_0=1,E2_1_0=1,E3_1_0=1,E4_1_0=0,
          I1_1_0=1,I2_1_0=1,I3_1_0=1,I4_1_0=0,
          R1_1_0=10,R2_1_0=10,R3_1_0=10,R4_1_0=0,
          S1_2_0=10,S2_2_0=10,S3_2_0=10,S4_2_0=0,
          E1_2_0=0.1,E2_2_0=0.1,E3_2_0=0.1,E4_2_0=0,
          I1_2_0=0.1,I2_2_0=0.1,I3_2_0=0.1,I4_2_0=0,
          R_2_0=30,
          K1_0=0.001,K2_0=0.001,K3_0=0.001,K4_0=0,
          F1_0=0.001,F2_0=0.001,F3_0=0.001,F4_0=0,
          sig_obs=0.05)

pars <- names(sim_vals)
coef(pomped,pars) <- unname(sim_vals[pars])

#source("./helper_functions.R")
sims_cases <- run_simulation(pomped,100)

#plot_simulation(sims_cases, CI=c(0.5,0.95),mode="traj")
plot_simulation(sims_cases, CI=c(0.5,0.95),mode="ribbon")



sims_cases <- sims_cases %>% filter(Type!="Data") %>% select(-c(.id,Type))
sim <- sims_cases %>% group_by(time) %>% summarise(Cases=mean(Cases))

bk_sim <- bk
bk_sim$cases <- sim$Cases

ggplot(bk_sim,aes(x=time,y=cases))+geom_line()+theme_classic()+ylim(0,3000)
ggplot(bk,aes(x=time,y=cases))+geom_line()+theme_classic()+ylim(0,3000)

write_csv(bk_sim,"bk_df_sim.csv")

```

Simulate from four serotypes with serotype data
```{r}
bk_iso <- read_csv("data/bk_df_iso.csv")

source("objects/object_isolate_data.R")
covariates <- covariate_table(bk_iso %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk_iso, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

source("objects/object_isolate_data.R")
pomped <- construct_pomp(bk_iso,covariates)

just_iso <- bk_iso %>% select(iso1:iso4)
just_iso$sums <- just_iso %>% rowSums()
just_iso <- apply(just_iso,1,function(x) return(x/x[5])) %>% t

inits <- init_spread[1,]
bS_1 <- 10000
bE_1 <- 0.1
bI_1 <- 0.1
bR_1 <- 1000
bS_2 <- 1000
bE_2 <- 0.1
bI_2 <- 0.1
bR_2 <- 1000
sim_vals <- c(b1=0.05,b2=2,b3=0.1,b4=0.2,b5=1.4,b6=1.4,
              bT=0.1,bENSO=1.4,
              beta_out=0.00025,
              beta1=1.5,beta2=1,beta3=0.8,beta4=1.1,
              gamma1=0.2,gamma2=0.2,gamma3=0.2,gamma4=0.2,
              phi1=0.2,phi2=0.2,phi3=0.2,phi4=0.2,
              sigma=0.1,
              alpha=0.54,
              delta=1/60,
              muEI=84,muIR=304,
              muRS1=1,muRS2=1,muRS3=1,muRS4=1,
              rho=-6,rho_C=0.00002,
              nu=0.5,
              S_1_0=bS_1,
              E1_1_0=inits[1]*bE_1,E2_1_0=inits[2]*bE_1,E3_1_0=inits[3]*bE_1,E4_1_0=inits[4]*bE_1,
              I1_1_0=inits[1]*bI_1,I2_1_0=inits[2]*bI_1,I3_1_0=inits[3]*bI_1,I4_1_0=inits[4]*bI_1,
              R1_1_0=inits[1]*bR_1,R2_1_0=inits[2]*bR_1,R3_1_0=inits[3]*bR_1,R4_1_0=inits[4]*bR_1,
              S1_2_0=inits[1]*bS_2,S2_2_0=inits[2]*bS_2,S3_2_0=inits[3]*bS_2,S4_2_0=inits[4]*bS_2,
              E1_2_0=inits[1]*bE_2,E2_2_0=inits[2]*bE_2,E3_2_0=inits[3]*bE_2,E4_2_0=inits[4]*bE_2,
              I1_2_0=inits[1]*bI_2,I2_2_0=inits[2]*bI_2,I3_2_0=inits[3]*bI_2,I4_2_0=inits[4]*bI_2,
              R_2_0=100,
              sig_obs=0.05,
              eta=0.05,
              psi=0.01)
coef(pomped,par_names) <- unname(sim_vals[par_names])

sims <- pomped %>% simulate(nsim = 1000,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,C1:C4,cases)
sims_cases <- sims_cases %>% 
    pivot_longer(cols=C1:cases,names_to="state",values_to="count") %>% 
    na.omit %>% 
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    mutate(state=ifelse(state=="cases","Data",state)) %>% 
    filter(!(.id=="sim" & state=="Data"))

colors <- c("#c7040e","#3856eb","#cca937","#08bf0e","black")
labels <- c("C1","C2","C3","C4","Data")
ggplot(sims_cases, aes(x=time, y=count, color=state)) +
    geom_line(alpha=0.7,linewidth=1) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))

ggplot(sims_cases, aes(x=time, y=count, color=state, fill=state)) +
    ggdist::stat_lineribbon(.width = c(0.05,0.95), alpha = 0.5, linewidth = 0.8) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_fill_manual(values = colors,labels = labels) +
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))

#sims_cases <- run_simulation(pomped,1000)
#plot_simulation(sims_cases, CI=c(0.5,0.95),mode="ribbon")

pf <- pfilter(pomped,Np=1000)
logLik(pf)

```

Simulate from full model with serotype data
```{r}
bk_iso <- read_csv("data/bk_split_enso.csv")

source("objects/object_track_all.R")
covariates <- covariate_table(bk_iso %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk_iso, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

pomped <- construct_pomp(bk_iso,covariates)

sim_vals <- c(
    g12=0.8,g13=0.8,g14=0.8,
    g21=0.8,g23=0.8,g24=0.8,
    g31=0.8,g32=0.8,g34=0.8,
    g41=0.8,g42=0.8,g43=0.8,
    p12=0.9,p13=0.9,p14=0.9,
    p21=0.9,p23=0.9,p24=0.9,
    p31=0.9,p32=0.9,p34=0.9,
    p41=0.9,p42=0.9,p43=0.9, 
    bO1=0.0001,bO2=0.0001,bO3=0.0001,bO4=0.0001,
    beta1=0.5,beta2=0.5,beta3=0.5,beta4=0.5,
    b1=0.05,b2=2.8,b3=0.1,b4=0.2,b5=1.4,b6=1.4,bT=1.5,bNino=2.5,bNina=1,
    sigma=0.1,
    alpha=0.54,
    delta=1/60,muEI=84,muIR=304,muRS=1,
    nu=0.1,rho=0.01,
    S_0=1000,
    E1_0=.2,E2_0=.6,E3_0=.15,E4_0=0.01,
    I1_0=2,I2_0=6,I3_0=1.5,I4_0=0.1,
    R1_0=20,R2_0=60,R3_0=15,R4_0=1,
    S1_0=20,S2_0=60,S3_0=15,S4_0=1,
    E12_0=.1,E13_0=.1,E14_0=.1,
    E21_0=.2,E23_0=.2,E24_0=.2,
    E31_0=.1,E32_0=.1,E34_0=.1,
    E41_0=0,E42_0=0,E43_0=0,
    I12_0=.1,I13_0=.1,I14_0=.1,
    I21_0=.2,I23_0=.2,I24_0=.2,
    I31_0=.1,I32_0=.1,I34_0=.1,
    I41_0=0,I42_0=0,I43_0=0,
    R_0=100,
    sig_obs=0.05,
    eta=0.65,
    psi=0.01)

coef(pomped,par_names) <- unname(sim_vals[par_names])

#
mle <- model_fit %>% select(all_of(pars)) %>% slice(1)
coef(pomped,pars) <- unname(mle[pars])
#head(model_fit$loglik)
#

sims <- pomped %>% simulate(nsim = 1000,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,C1s:C4s,cases)

tmp <- read_csv("data/bk_four_time_series.csv") %>% select(cases1:cases4)
tmp <- tmp[rep(1:nrow(tmp),1001),]

sims_cases <- cbind(sims_cases %>% select(-cases),tmp)

sims_cases <- sims_cases %>% 
    pivot_longer(cols=c(C1s:C4s,cases1:cases4),names_to="state",values_to="count") %>% 
    na.omit %>% 
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    filter(!(.id=="sim" & state%in%paste0("cases",1:4)))
sims_cases$state[sims_cases$state=="C1s"]="cases1"
sims_cases$state[sims_cases$state=="C2s"]="cases2"
sims_cases$state[sims_cases$state=="C3s"]="cases3"
sims_cases$state[sims_cases$state=="C4s"]="cases4"

colors <- c("black","#de0909")
labels <- c("Data","Simulation")

ggplot(sims_cases, aes(x=time, y=count, color=.id, fill=.id)) +
    ggdist::stat_lineribbon(.width = c(0.05,0.95), alpha = 0.5, linewidth = 0.8) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_fill_manual(values = colors,labels = labels) +
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))+
    ylim(0,200)+
    facet_wrap(~state,ncol=1)


pf <- pfilter(pomped,Np=1000)
logLik(pf)


#bk_iso_split_enso <- bk_iso
#bk_iso_split_enso$nino <- ifelse(bk_iso_split_enso$enso>0,bk_iso_split_enso$enso,0)
#bk_iso_split_enso$nina <- ifelse(bk_iso_split_enso$enso<0,bk_iso_split_enso$enso,0)
#write_csv(bk_iso_split_enso,"data/bk_split_enso.csv")

```

Simulate from full model without serotype data
```{r}
bk_iso <- read_csv("data/bk_split_enso.csv")

source("objects/object_track_all_no_iso.R")
covariates <- covariate_table(bk_iso %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk_iso, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

pomped <- construct_pomp(bk_iso,covariates)

sim_vals <- c(
    g12=0.8,g13=0.8,g14=0.8,g21=0.8,g23=0.8,g24=0.8,g31=0.8,g32=0.8,g34=0.8,g41=0.8,g42=0.8,g43=0.8,
    p12=0.9,p13=0.9,p14=0.9,p21=0.9,p23=0.9,p24=0.9,p31=0.9,p32=0.9,p34=0.9,p41=0.9,p42=0.9,p43=0.9, 
    bO1=0.0001,bO2=0.0001,bO3=0.0001,bO4=0.0001,
    beta1=0.5,beta2=0.5,beta3=0.5,beta4=0.5,
    b1=0.05,b2=2.8,b3=0.1,b4=0.2,b5=1.4,b6=1.4,bT=1.5,bNino=2.5,bNina=1,
    sigma=0.1,
    alpha=0.54,
    delta=1/60,muEI=84,muIR=304,muRS=1,
    nu=0.1,rho=0.01,
    S_0=1000,
    E1_0=.2,E2_0=.6,E3_0=.15,E4_0=0.01,
    I1_0=2,I2_0=6,I3_0=1.5,I4_0=0.1,
    R1_0=20,R2_0=60,R3_0=15,R4_0=1,
    S1_0=20,S2_0=60,S3_0=15,S4_0=1,
    E12_0=.1,E13_0=.1,E14_0=.1,E21_0=.2,E23_0=.2,E24_0=.2,E31_0=.1,E32_0=.1,E34_0=.1,E41_0=0,E42_0=0,E43_0=0,
    I12_0=.1,I13_0=.1,I14_0=.1,I21_0=.2,I23_0=.2,I24_0=.2,I31_0=.1,I32_0=.1,I34_0=.1,I41_0=0,I42_0=0,I43_0=0,
    R_0=100,
    sig_obs=0.05,
    n=4)

coef(pomped,par_names) <- unname(sim_vals[par_names])


#
mle <- model_fit %>% select(all_of(pars)) %>% slice(8)
coef(pomped,pars) <- unname(mle[pars])
#

sims <- pomped %>% simulate(nsim = 100,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,C1s:C4s,cases)
sims_cases <- sims_cases %>% 
    pivot_longer(cols=c(C1s:C4s,cases),names_to="state",values_to="count") %>% 
    na.omit %>% 
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    mutate(state=ifelse(state=="cases","Data",state)) %>% 
    filter(!(.id=="sim" & state=="Data"))

colors <- c("#c7040e","#3856eb","#cca937","#08bf0e","black")
labels <- c("C1","C2","C3","C4","Data")
ggplot(sims_cases, aes(x=time, y=count, color=state)) +
    geom_line(alpha=0.7,linewidth=1) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))

ggplot(sims_cases, aes(x=time, y=count, color=state, fill=state)) +
    ggdist::stat_lineribbon(.width = c(0.47,0.89), alpha = 0.5, linewidth = 0.8) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_fill_manual(values = colors,labels = labels) +
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))+
    ylim(0,2000)

sims_cases <- run_simulation(pomped,1000)
plot_simulation(sims_cases,CI=c(0.47,0.89),mode="ribbon")


pf <- pfilter(pomped,Np=1000)
logLik(pf)


bk_iso_split_enso <- bk_iso
bk_iso_split_enso$nino <- ifelse(bk_iso_split_enso$enso>0,bk_iso_split_enso$enso,0)
bk_iso_split_enso$nina <- ifelse(bk_iso_split_enso$enso<0,bk_iso_split_enso$enso,0)
write_csv(bk_iso_split_enso,"data/bk_split_enso.csv")

```

Simulate from full n-serotype model, n=2
```{r}
bk_iso <- read_csv("data/bk_split_enso.csv")

source("objects/object_n_serotypes.R")
covariates <- covariate_table(bk_iso %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk_iso, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

#source("objects/object_n_serotypes.R")
pomped <- construct_pomp(bk_iso,covariates)

sim_vals <- c(
    g12=0.1,g21=0.1,
    p12=0.1,p21=0.1,
    bO1=0.0002,bO2=0.0002,
    beta1=1,beta2=1,
    b1=0.05,b2=2.8,b3=0.1,b4=0.2,b5=1.4,b6=1.4,bT=1.5,bNino=1,bNina=1,
    sigma=0.1,
    alpha=0.54,
    delta=1/60,muEI=84,muIR=304,muRS=1,
    nu=0.1,rho=0.05,
    S_0=1000,
    E1_0=1,E2_0=1,
    I1_0=1,I2_0=1,
    R1_0=100,R2_0=100,
    S1_0=100,S2_0=100,
    E12_0=1,E21_0=1,
    I12_0=1,I21_0=1,
    R_0=1000,
    sig_obs=0.05,
    n_sero=n)

coef(pomped,par_names) <- unname(sim_vals[par_names])

#
mle <- model_fit %>% select(all_of(pars)) %>% slice(3)
coef(pomped,pars) <- unname(mle[pars])
#

sims <- pomped %>% simulate(nsim = 1000,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,C1s:C2s,cases)
sims_cases <- sims_cases %>% 
    pivot_longer(cols=c(C1s:C2s,cases),names_to="state",values_to="count") %>% 
    na.omit %>% 
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    mutate(state=ifelse(state=="cases","Data",state)) %>% 
    filter(!(.id=="sim" & state=="Data"))

#colors <- c("#c7040e","#cca937","black")
#colors <- c("#c7040e","#325aa8","black")
colors <- c("#f03a43","#3d6ecc","black")
labels <- c("C1","C2","Data")

ggplot(sims_cases, aes(x=time, y=count, color=state, fill=state)) +
    ggdist::stat_lineribbon(.width = c(0.47,0.89), alpha = 0.5, linewidth = 0.8) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_fill_manual(values = colors,labels = labels) +
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))
    ylim(0,2000)

ggplot(sims_cases, aes(x=time, y=count, color=state)) +
    geom_line(alpha=0.5,linewidth=1) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))

sims_cases <- run_simulation(pomped,1000)
plot_simulation(sims_cases,CI=c(0.47,0.89),mode="ribbon")


pf <- pfilter(pomped,Np=1000)
logLik(pf)


#bk_iso_split_enso <- bk_iso
#bk_iso_split_enso$nino <- ifelse(bk_iso_split_enso$enso>0,bk_iso_split_enso$enso,0)
#bk_iso_split_enso$nina <- ifelse(bk_iso_split_enso$enso<0,bk_iso_split_enso$enso,0)
#write_csv(bk_iso_split_enso,"data/bk_split_enso.csv")

```

Simulate from 4 serotypes with 4 time series
```{r}
bk <- read_csv("data/bk_four_time_series.csv")

source("objects/object_track_all_alternate_data.R")
covariates <- covariate_table(bk %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

pomped <- construct_pomp(bk,covariates)

sim_vals <- c(
    g12=0.8,g13=0.8,g14=0.8,
    g21=0.8,g23=0.8,g24=0.8,
    g31=0.8,g32=0.8,g34=0.8,
    g41=0.8,g42=0.8,g43=0.8,
    p12=0.9,p13=0.9,p14=0.9,
    p21=0.9,p23=0.9,p24=0.9,
    p31=0.9,p32=0.9,p34=0.9,
    p41=0.9,p42=0.9,p43=0.9, 
    bO1=0.0001,bO2=0.0001,bO3=0.0001,bO4=0.0001,
    beta1=1,beta2=1,beta3=1,beta4=1,
    b1=0.05,b2=2.8,b3=0.1,b4=0.2,b5=1.4,b6=1.4,bT=1.5,bNino=2.5,bNina=1,
    sigma=0.1,
    alpha=0.54,
    delta=1/60,muEI=84,muIR=304,muRS=1,
    nu=0.1,rho=0.01,
    S_0=1000,
    E1_0=.2,E2_0=.6,E3_0=.15,E4_0=0.01,
    I1_0=2,I2_0=6,I3_0=1.5,I4_0=0.1,
    R1_0=20,R2_0=60,R3_0=15,R4_0=1,
    S1_0=20,S2_0=60,S3_0=15,S4_0=1,
    E12_0=0.1,E13_0=0.1,E14_0=0.1,
    E21_0=0.1,E23_0=0.1,E24_0=0.1,
    E31_0=0.1,E32_0=0.1,E34_0=0.1,
    E41_0=0.1,E42_0=0.1,E43_0=0.1,
    I12_0=0.1,I13_0=0.1,I14_0=0.1,
    I21_0=0.1,I23_0=0.1,I24_0=0.1,
    I31_0=0.1,I32_0=0.1,I34_0=0.1,
    I41_0=0.1,I42_0=0.1,I43_0=0.1,
    R_0=100,
    sig_obs=0.05)

coef(pomped,par_names) <- unname(sim_vals[par_names])

#
mle <- model_fit %>% select(all_of(pars)) %>% slice(1)
coef(pomped,pars) <- unname(mle[pars])
#head(model_fit$loglik)
#

sims <- pomped %>% simulate(nsim = 1000,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,C1s:C4s,cases1:cases4)
sims_cases <- sims_cases %>% 
    pivot_longer(cols=c(C1s:C4s,cases1:cases4),names_to="state",values_to="count") %>% 
    na.omit %>% 
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    filter(!(.id=="sim" & state%in%paste0("cases",1:4)))
sims_cases$state[sims_cases$state=="C1s"]="cases1"
sims_cases$state[sims_cases$state=="C2s"]="cases2"
sims_cases$state[sims_cases$state=="C3s"]="cases3"
sims_cases$state[sims_cases$state=="C4s"]="cases4"

colors <- c("black","#de0909")
labels <- c("Data","Simulation")

ggplot(sims_cases, aes(x=time, y=count, color=.id, fill=.id)) +
    ggdist::stat_lineribbon(.width = c(0.05,0.95), alpha = 0.5, linewidth = 0.8) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_fill_manual(values = colors,labels = labels) +
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))+
    ylim(0,200)+
    facet_wrap(~state,ncol=1)


pf <- pfilter(pomped,Np=1000)
logLik(pf)/4

```

Simulate from 4 serotypes with 4 time series; new data source
```{r}
#
mle <- model_fit %>% select(all_of(pars)) %>% slice(1)
coef(pomped,pars) <- unname(mle[pars])
#head(model_fit$loglik)
#

sims <- pomped %>% simulate(nsim = 1000,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,C1s:C4s,den1:den4)
sims_cases <- sims_cases %>% 
    pivot_longer(cols=c(C1s:C4s,den1:den4),names_to="state",values_to="count") %>% 
    na.omit %>% 
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    filter(!(.id=="sim" & state%in%paste0("den",1:4)))
sims_cases$state[sims_cases$state=="C1s"]="den1"
sims_cases$state[sims_cases$state=="C2s"]="den2"
sims_cases$state[sims_cases$state=="C3s"]="den3"
sims_cases$state[sims_cases$state=="C4s"]="den4"

colors <- c("black","#de0909")
labels <- c("Data","Simulation")

ggplot(sims_cases, aes(x=time, y=count, color=.id, fill=.id)) +
    ggdist::stat_lineribbon(.width = c(0.05,0.95), alpha = 0.5, linewidth = 0.8) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_fill_manual(values = colors,labels = labels) +
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))+
    ylim(0,100)+
    facet_wrap(~state,ncol=1)

ggplot(sims_cases, aes(x=time, y=count, color=state)) +
    geom_line(alpha=0.7,linewidth=1) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))

pf <- pfilter(pomped,Np=1000)
logLik(pf)/4

```

Simulate from full n-serotype model, n=4
```{r}
bk_iso <- read_csv("data/bk_split_enso.csv")

source("objects/object_n_serotypes.R")
covariates <- covariate_table(bk_iso %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk_iso, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

#source("objects/object_n_serotypes.R")
pomped <- construct_pomp(bk_iso,covariates)

sim_vals <- c(
    g12=0.4,g13=0.4,g14=0.4,
    g21=0.5,g23=0.5,g24=0.5,
    g31=0.6,g32=0.6,g34=0.6,
    g41=0.7,g42=0.7,g43=0.7,
    p12=0.8,p13=0.8,p14=0.8,
    p21=0.9,p23=0.9,p24=0.9,
    p31=1.0,p32=1.0,p34=1.0,
    p41=1.1,p42=1.1,p43=1.1,
    bO1=0.001,bO2=0.001,bO3=0.001,bO4=0.001,
    beta1=0.8,beta2=0.9,beta3=1.0,beta4=1.1,
    b1=0.05,b2=2.8,b3=0.1,b4=0.2,b5=1.4,b6=1.4,bT=0.5,bNino=2,bNina=1,
    sigma=0.1,
    alpha=0.54,
    delta=1/60,muEI=84,muIR=304,muRS=1,
    nu=0.1,rho=0.05,
    S_0=500,
    E1_0=0,E2_0=10,E3_0=0,E4_0=10,
    I1_0=0,I2_0=10,I3_0=0,I4_0=10,
    R1_0=50,R2_0=100,R3_0=150,R4_0=200,
    S1_0=200,S2_0=150,S3_0=100,S4_0=50,
    E12_0=0,E13_0=1,E14_0=0,
    E21_0=0,E23_0=1,E24_0=0,
    E31_0=0,E32_0=1,E34_0=0,
    E41_0=0,E42_0=1,E43_0=0,
    I12_0=0,I13_0=1,I14_0=0,
    I21_0=0,I23_0=1,I24_0=0,
    I31_0=0,I32_0=1,I34_0=0,
    I41_0=0,I42_0=1,I43_0=0,
    R_0=500,
    sig_obs=0.05,
    n_sero=4)

coef(pomped,par_names) <- unname(sim_vals[par_names])

#
#mle <- model_fit %>% select(all_of(pars)) %>% slice(1)
#coef(pomped,pars) <- unname(mle[pars])
#

sims <- pomped %>% simulate(nsim = 100,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,C1s:C4s,cases)
sims_cases <- sims_cases %>% 
    pivot_longer(cols=c(C1s:C4s,cases),names_to="state",values_to="count") %>% 
    na.omit %>% 
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    mutate(state=ifelse(state=="cases","Data",state)) %>% 
    filter(!(.id=="sim" & state=="Data"))

colors <- c("#c7040e","#3856eb","#cca937","#08bf0e","black")
labels <- c("C1","C2","C3","C4","Data")

ggplot(sims_cases, aes(x=time, y=count, color=state, fill=state)) +
    ggdist::stat_lineribbon(.width = c(0.47,0.89), alpha = 0.5, linewidth = 0.8) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_fill_manual(values = colors,labels = labels) +
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))

ggplot(sims_cases, aes(x=time, y=count, color=state)) +
    geom_line(alpha=0.5,linewidth=1) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))

sims_cases <- run_simulation(pomped,1000)
plot_simulation(sims_cases,CI=c(0.47,0.89),mode="ribbon")


pf <- pfilter(pomped,Np=1000)
logLik(pf)


#bk_iso_split_enso <- bk_iso
#bk_iso_split_enso$nino <- ifelse(bk_iso_split_enso$enso>0,bk_iso_split_enso$enso,0)
#bk_iso_split_enso$nina <- ifelse(bk_iso_split_enso$enso<0,bk_iso_split_enso$enso,0)
#write_csv(bk_iso_split_enso,"data/bk_split_enso.csv")


```

Simulate seirs
```{r}
bk <- read_csv("data/bk_clean_asym.csv")

source("objects/object_seirs_enso_tweaked.R")
covariates <- covariate_table(bk %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

pomped <- construct_pomp(bk,covariates)

sim_vals <- c(b1=-0.25,b2=1.8,b3=0.8,b4=4,b5=0.75,b6=2.6,bT=1,bNino=2,bNina=1,
              sigma=0.06,
              beta_out=0.004,q=0,alpha=.9,
              delta=1/60,
              muEI=9.1,muIS=0,muIQ=8.8,muQS=4.3,
              tau=0.01,
              rho=0.001,
              S_0=0.99,E_0=0.002,I_0=0.002,Q_0=0.005,
              K_0=0.01,F_0=0.01,
              sig_obs=0.05)

coef(pomped,par_names) <- unname(sim_vals[par_names])

#
head(model_fit$loglik,n=10)
mle <- model_fit %>% select(all_of(pars)) %>% slice(1)
#mle %>% select(c(bT,bNino,bNina,muQS,rho)) %>% mutate(muQS=365/muQS)

coef(pomped,pars) <- unname(mle[pars])
#

#mle$rho <- 3*mle$rho
#coef(pomped,pars) <- unname(mle[pars])

#
#mle <- model_fit %>% filter(rho>logit(0.01)) %>% arrange(-loglik) %>%  select(all_of(pars)) %>% slice(5)
#coef(pomped,pars) <- unname(mle[pars])
#

#write_csv(mle,"mle.csv")

#
#coef(pomped,pars) <- unname(profile_mle[pars])
#

#mle <- model_fit %>% select(all_of(pars)) %>% slice(1)
#mle2 <- model_fit %>% select(all_of(pars)) %>% slice(2)

#coef(pomped,pars) <- unname(mle[pars])
#par <- c("S_0","E_0","I_0","R_0","K_0","F_0",
#         "sigma","sig_obs","beta_out","rho",
#         "bNina","muRS","tau")

#c("alpha","bNino","theta","phi","muEI","muIR")
#coef(pomped,par) <- unname(mle2[par])
#coef(pomped,"beta_out") <- 0

sims <- pomped %>% simulate(nsim = 1000,include.data = TRUE,format = "data.frame")

sims_cases <- sims %>% select(time,.id,cases)
#sims_cases <- sims_cases %>%
#    mutate(cases=ifelse(is.na(cases),0,cases))
sims_cases <- sims_cases %>%
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    mutate(cases=ifelse(is.na(cases),0,cases))

nino_years <- bk %>% 
    filter(!is.na(cases)) %>% 
    select(time,nino,nina) %>% 
    mutate(enso=nino+nina) %>% 
    select(time,enso) %>% 
    mutate(upper=sims_cases %>% 
    filter(.id!="data") %>% 
    group_by(time) %>% 
    summarize(upper=quantile(cases,0.95)) %>% 
    ungroup %>%
    pull(upper))

#colors <- c("black","#d42626")
fill_colors <- c("black","#40d6ed")
color_colors <- c("black","#16a4ba")
labels <- c("Data","Simulation")
bg.color <- "#e6e6e6"
bg.color <- "white"

start <- 1900
end <- 2100
ggplot() +
    ggdist::stat_lineribbon(data=sims_cases %>% 
                                filter(time>=start&time<end),
                            mapping=aes(x=time, y=cases, color=.id, fill=.id),.width = c(0.1,0.9), alpha=0.65, linewidth=0.8)+
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_fill_manual(values = fill_colors,labels = labels)+
    scale_color_manual(values = color_colors,labels = labels)+
    guides(color="none",fill=guide_legend(title=""))+
    new_scale_fill()+
    geom_rect(data=nino_years %>% 
                                filter(time>=start&time<end),
              mapping=aes(xmin=time,
                          xmax=time+1/12,
                          ymin=upper,
                          ymax=Inf,
                          fill=enso),
              alpha=0.45,
              inherit.aes=F)+
    scale_fill_gradient2(low="#f2c51f",mid=bg.color,high="#f54997",name="ENSO")+
    theme_classic()+
    theme(legend.position="bottom",
          legend.title=element_text(size=10,vjust=0.8),
          text=element_text(size = 14),
          legend.background=element_rect(fill=bg.color,color=bg.color),
          panel.background=element_rect(fill=bg.color,color=bg.color),
          plot.background=element_rect(fill=bg.color,color=bg.color))+
    ylim(0,5000)

    geom_segment(aes(x=2020-1/12,y=0,xend=2021,yend=0),color=bg.color,linewidth=0.8)


pf <- pfilter(pomped,Np=1000)
logLik(pf)


# tmp <- read_csv("data/bk_df.csv")
# tmp_split <- tmp
# tmp_split$nino <- ifelse(tmp_split$enso>0,tmp_split$enso,0)
# tmp_split$nina <- ifelse(tmp_split$enso<0,tmp_split$enso,0)
# tmp_split <- tmp_split %>% 
#     rename(temp=covariate) %>% 
#     select(-c(el_nino,la_nina,starts_with("enso")))
# write_csv(tmp_split,"data/bk_clean_assym.csv")


sims %>% 
    select(time,W,beta_eff,nino,nina,pop) %>%
    na.omit %>% 
    group_by(time) %>% 
    summarise_all(mean) %>% 
    mutate(k=with(mle,theta+exp(bNino*nino+bNina*nina)*phi*pop)) %>% 
    mutate(VC=beta_eff*k) %>% 
    mutate(full=VC*W) %>% 
    pivot_longer(cols=c(beta_eff,W,k,VC,full)) %>% 
    mutate(name=factor(name,levels=c("beta_eff","k","VC","W","full"))) %>% 
    ggplot(aes(x=time,y=value))+
    geom_line()+
    facet_wrap(~name,scales="free_y",ncol=1)+
    geom_vline(xintercept=seq(from=1981,to=2019,by=1),linetype=3)+
    theme_classic()

sims %>% 
    select(time,W,F) %>% 
    na.omit %>% 
    mutate(VC=W*F,month=month(date_decimal(time))) %>% 
    group_by(month) %>% 
    summarise(mean=mean(VC),lo=quantile(VC,0.025),hi=quantile(VC,0.975)) %>% 
    ggplot(aes(x=month,y=mean))+
    geom_line()+
    geom_ribbon(aes(ymin=lo,ymax=hi),alpha=0.2)+
    theme_classic()

sims %>% 
    select(time,W) %>% 
    filter(time>2000&time<2008) %>% 
    na.omit %>% 
    ggplot(aes(x=time,y=W))+
    geom_line()+
    geom_hline(yintercept=c(0.02255239,0.7,0.975736),
               linetype=2)+
    theme_classic()




```

Examine profiling
```{r}
source("objects/object_seirs_enso_tweaked.R")

profile_pars <- readLines("profiling_stuff/pars.txt")

profile_mle <- sapply(profile_pars,function(x) {
  read_csv(paste0("profiling_stuff/results/",x,"_results.csv")) %>% 
        arrange(-loglik) %>%
        pull(all_of(x)) %>% 
        head(1)  
})

profile_mle <- c(profile_mle,params[!names(params)%in%profile_pars])

prof_par <- "muQS"
profile <- read_csv(paste0("profiling_stuff/results/",prof_par,"_results.csv")) %>%
    arrange(prof_par) %>% 
    group_by(as.factor(!!sym(prof_par))) %>% 
    slice_max(order_by=loglik,n=1) %>% 
    ungroup() %>% 
    select(all_of(c(profile_pars,"loglik"))) %>% 
    distinct()

ggplot(profile,aes(x=!!sym(prof_par),y=loglik))+geom_point()+theme_classic()

```

Misc
```{r}
tmp <- read_csv("data/full_time.csv")
#ggplot(tmp,aes(x=time,y=nino))+geom_line()+theme_classic()
write_csv(read_csv("cluster_runs/run_2_3_a/bk_df.csv") %>% 
              filter(time<2010),
          "cluster_runs/run_2_4_a/bk_df.csv")

tmp <- tmp %>% filter(time>=1970&time<2000)
tmp$temp <- tmp$temp*tmp$season5*(tmp$nino-tmp$nina)
tmp$temp <- tmp$temp/max(tmp$temp)

beta_eff <- read_csv("data/bk_clean_asym.csv")
beta_eff$temp <- beta_eff$temp*(beta_eff$nino-beta_eff$nina)
beta_eff$temp <- beta_eff$temp/max(beta_eff$temp)

combine <- data.frame(time=rep(tmp$time,2),
                   value=c(tmp$temp,beta_eff$temp),
                   type=c(rep("temp",nrow(tmp)),rep("beta_eff",nrow(beta_eff))))
ggplot(combine,aes(x=time,y=value,color=type))+
    geom_line(alpha=0.75,linewidth=0.75)+
    theme_classic()+
    scale_colour_manual(values=c(temp="forestgreen",beta_eff="red"))


max(tmp$temp*tmp$season5)/max(beta_eff$temp)


read_csv("data/full_time.csv") %>% 
    select(time,temp,beta_eff) %>%
    mutate(temp=scale(temp),beta_eff=scale(beta_eff)) %>% 
    pivot_longer(cols=temp:beta_eff,names_to="type",values_to="value") %>% 
    ggplot(aes(x=time,y=value,color=type))+
    geom_line(alpha=0.75,linewidth=0.75)+
    theme_classic()+
    scale_colour_manual(values=c(temp="forestgreen",beta_eff="red2"))

#pass temperature*enso through beta_effective

```

Plot interannual parameters for different seirs
```{r}
use <- c(2,4)

seirs <- c("cluster_runs/run_2_12_a","cluster_runs/run_2_3_b","cluster_runs/run_2_4_a","cluster_runs/run_2_3_a")[use]
pick <- c(4,3,9,2)[use]

plot_vals <- map2(seirs,pick,function(x,y) 
    {read.csv(paste0(x,"/results.csv")) %>% arrange(-loglik) %>% slice(y) %>% select(b1:bNina,muQS)}
    ) %>% melt() %>% select(-name)
colnames(plot_vals) <- c("range","par","val")
plot_vals$range <- as.character(plot_vals$range)

colors <- c("black","#bd0417","#ff7583","#f7a8b0")[use]
labels <- c("1970-1989","1970-2000","1970-2010","1970-2020")[use]
ggplot(plot_vals,aes(x=par,y=val,color=range))+
    geom_point(size=5,alpha=0.7)+
    theme_classic()+
    scale_color_manual(values=colors, labels=labels)+
    ylim(-1,10)+
    xlab("Parameter")+
    ylab("Value")+
    guides(color=guide_legend(title="Date range"))+
    theme(text = element_text(size=15))

```

Seasonal ARIMA and compare with our model
```{r}
fit_date <- 2000
sim_date <- 2019

df <- read_csv("data/full_time.csv") %>% select(time,cases)
df <- df %>% filter(time<fit_date)
case_df <- df$cases
df <- ts(df$cases,
         start=df$time[1],
         end=df$time[nrow(df)],
         frequency=12)
autoplot(df)

arima_fit <- auto.arima(df,lambda=0,approximation=F,stepwise=F,allowdrift=F)

loglik <- arima_fit$loglik
k <- (arima_fit$aic+2*loglik)/2
loglik <- loglik-sum(log(case_df))
aic <- 2*k-2*loglik
loglik
aic

arima_fit %>% forecast(h=12*(sim_date-fit_date)) %>% autoplot() + 
    theme_classic()+
    ylab("Cases")+
    xlab("Year")+
    ggtitle("Dengue in Bangkok")+
    theme(text=element_text(size=14))

checkresiduals(arima_fit)

#Alright. compare

#sarima
sarima_pred <- forecast(arima_fit,h=12*(sim_date-fit_date))
sarima_pred <- sarima_pred$mean
sarima_pred <- data.frame(time=as.matrix(time(sarima_pred)),cases=as.matrix(sarima_pred))
ggplot(sarima_pred,aes(x=time,y=cases))+geom_line()+theme_classic()+ylim(0,2000)

#seirs. source correct fit first!!
bk <- read_csv("data/full_time.csv")
covariates <- covariate_table(bk %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

data.frame(x=1:24,y=covariates@table[8,1:24]) %>% ggplot(aes(x=x,y=y))+geom_line()

pomped <- construct_pomp(bk,covariates)
#choose correct mle!!
mle <- model_fit %>% select(all_of(pars)) %>% slice(2)
coef(pomped,pars) <- unname(mle[pars])

filtered_mean <- pomped %>% pfilter(Np=1000,filter.mean=T)
coef(pomped,c("S_0","E_0","I_0","Q_0","K_0","F_0")) <- filtered_mean@filter.mean[2:7,(fit_date-1970)*12]
sims <- pomped %>% simulate(nsim = 1000,
                            times=seq(from=fit_date,to=sim_date-1/12,by=1/12),
                            format = "data.frame")
avgs <- sims %>% select(time,cases) %>% 
    group_by(time) %>% 
    summarise(cases=mean(cases))
ggplot(avgs,aes(x=time,y=cases))+geom_line()+theme_classic()+ylim(0,2000)

#errors
compare <- data.frame(Year=sarima_pred$time,SARIMA=sarima_pred$cases,SEIRS=avgs$cases) %>% 
    pivot_longer(cols=SARIMA:SEIRS,names_to="Model",values_to="Cases")
real <- bk %>% filter(time>=fit_date&time<sim_date) %>% pull(cases)
compare$Error <- (compare$Cases-rep(real,each=2))^2
compare <- compare[3:nrow(compare),]
compare <- compare %>% pivot_wider(id_cols=Year,names_from=Model,values_from=Error)

for (i in 2:nrow(compare)) compare[i,2:3] <- (compare[i-1,2:3]*(i-1)+compare[i,2:3])/i

compare <- compare %>% 
    pivot_longer(cols=SARIMA:SEIRS,names_to="Model",values_to="Error") %>% 
    mutate(Error=sqrt(Error))

ggplot(compare,aes(x=Year,y=Error,color=Model))+
    geom_line()+
    theme_classic()+
    scale_color_manual(values=c("#39b7bf","#eb4dd6"))+
    ylab("Mean Error Over Time")

#weighted interval scores
quantiles <- c(0.5,0.1,0.9,0.025,0.975)
sarima_pred <- forecast(arima_fit,h=12*(sim_date-fit_date))
wis_sarima <- apply(cbind(as.matrix(as.data.frame(sarima_pred)),real), 1, function(x) {
    evalcast::weighted_interval_score(quantiles,x[1:5],x[6])
    }) %>% unname

intervals <- sims %>% select(time,cases) %>% 
    group_by(time) %>% 
    summarise(as_tibble_row(quantile(cases,probs=quantiles)))
wis_seirs <- apply(cbind(intervals,real), 1, function(x) {
    evalcast::weighted_interval_score(quantiles,x[2:6],x[7])
    })

compare <- data.frame(Year=intervals$time,SARIMA=wis_sarima,SEIRS=wis_seirs)[2:length(intervals$time),]
for (i in 2:nrow(compare)) compare[i,2:3] <- (compare[i-1,2:3]*(i-1)+compare[i,2:3])/i

compare$SEIRS_adv <- compare$SEIRS/compare$SARIMA

compare <- compare %>% 
    pivot_longer(cols=SARIMA:SEIRS,names_to="Model",values_to="WIS")

ggplot(compare,aes(x=Year,y=WIS,color=Model))+
    geom_line(linewidth=1)+
    theme_classic()+
    scale_color_manual(values=c("#59dae3","#ff63ea"))+
    ylab("Mean WIS Over Forecasting Periods")+
    theme(text=element_text(size=13))

ggplot(compare,aes(x=Year,y=1/SEIRS_adv))+
    geom_line(color="#de0909",linewidth=1)+
    geom_hline(yintercept=1,linetype=2)+
    theme_classic()+
    ylab("WIS, SEIRS over SARIMA")+
    theme(text=element_text(size=13))

```

Prep India data
```{r}
india_data <- read_csv("../india_data/dataset_Ahmedabad_2023.csv")
india_cases <- read_csv("../india_data/Monthly_Dengue_Cases_Ahmedabad.csv")

india_data <- india_data %>% 
    filter(year>=2003) %>% 
    select(-c(PF,PV,mvd)) %>% 
    mutate(cases=india_cases %>% arrange(Year,Month) %>% pull(cases))
india_data$cases[india_data$year==2020]=NA

smooth_pop <- loess(india_data$pop ~ india_data$time)$fitted
smooth_pop <- smooth.spline(x = india_data$time, smooth_pop)
pop = predict(smooth_pop, deriv = 0, x = india_data$time)$y
dpopdt = predict(smooth_pop, deriv = 1, x = india_data$time)$y
india_data$pop <- pop
india_data$dpopdt <- dpopdt

write_csv(india_data,"data/india_df.csv")

ggplot(india_data,aes(x=time,y=cases))+geom_line()+theme_classic()
ggplot(india_data,aes(x=time,y=hadISD))+geom_line()+theme_classic()

#number of tests; can we get some additional data from reporting or hospitals to figure out which years were fucked by covid?
#are malaria vectors competing with dengue? stephensi (malaria) chooses deep water while the dengue vector (aegypti) chooses shallow water. so maybe in a dry year they all compete more and influence disease dynamics. in 2019 malaria had a record low epidemic, while dengue had a super big peak. but 2019 was not dry.
#experimental evidence that dengue always beats malaria. but they seem to occupy different niches?

#read_csv("cluster_runs/run_2_14_b/pars.csv") %>% select(-c(bNino,bNina)) %>% write_csv("cluster_runs/run_2_14_b/pars.csv")

#tmp <- read_csv("cluster_runs/run_2_14_c/pars.csv")
#tmp$rho <- runif(nrow(tmp),-4,0)
#tmp$bT <- runif(nrow(tmp),0,0.5)
#write_csv(tmp,"cluster_runs/run_2_14_c/pars.csv")

```

India correlations
```{r}
india_data <- read_csv("data/india_df.csv")

refill <- read_csv("../india_data/Monthly_Dengue_Cases_Ahmedabad.csv") %>% 
    arrange(Year,Month) %>% filter(Year==2020) %>% pull(cases)
refilled <- india_data
refilled$cases[refilled$year==2020]=refill

peak_months <- c(-2,-1,0,1,2) + (refilled %>% filter(year>2009) %>% select(year,month,cases) %>% group_by(year) %>% filter(cases==max(cases)) %>% pull(month) %>% table %>% which.max %>% names %>% as.integer)

#refilled <- refilled %>% group_by(year) %>% 
##    filter(month%in%peak_months) %>% 
#    mutate(cases=mean(cases)) %>% 
#    filter(month==9) %>% 
#    ungroup()

s <- ssa(refilled$cases)
r <- reconstruct(s)
n_comps <- 9
r2 <- melt(r[c(1:n_comps)]) %>% rename(component=.L1,time=name,cases=value)
r2$time <- rep(refilled$time,n_comps)
r2 <- rbind(r2,cbind(component="data",refilled %>% select(time,cases)))
ggplot(r2,aes(x=time,y=cases,color=component))+
    geom_line()+
    scale_color_manual(values=c("red",viridis_pal()(n_comps)))+
    theme_classic()

#detrended <- melt(r[c(2:10)]) %>% group_by(name) %>% summarise(sum=sum(value))
detrended <- refilled$cases-r$F1
#detrended <- refilled$cases/r$F1
ggplot(data.frame(time=refilled$time,cases=detrended),aes(x=time,y=cases))+
    geom_line()+
    theme_classic()

big_years <- refilled %>% filter(year %in% (
    refilled %>%
    group_by(year) %>%
    summarise(comp=max(cases)>=(
        refilled %>% filter(time<2010) %>% pull(cases) %>% max)
        ) %>%
    filter(comp) %>%
    pull(year)
    )) %>% 
    filter(year!=2020)

#big_years$cases <- detrended[refilled$year%in%big_years$year]

case_sums <- big_years %>% 
    filter(month%in%peak_months) %>% 
    group_by(year) %>% 
    summarise(cases=sum(cases)) %>% pull(cases)

covs <- c("hadISD","Max_Temp","Mean_Temp")
collect <- list()
for (cov in covs) {
    i_hero <- 0
    j_hero <- 0
    cor_hero <- 0
    for (j in 1:12) {
        for (i in 1:12) {
            #cov="Max_Temp"
            #i=4
            #j=3
            
            batch=seq(from=i,to=i+j-1,by=1)%%12+1

            batched <- big_years %>% 
                group_by(year) %>% 
                filter(month%in%batch)
            
            #batched <- refilled %>% 
            #    group_by(year) %>% 
            #    filter(month%in%batch)
            
            test_cov <- batched %>% 
                summarise(test=mean(!!sym(cov))) %>% 
                pull(test)
            
            cor <- cor(case_sums,test_cov)
            
            #if (abs(cor)>0.25) print(paste0(cor,", ",paste0(batch,collapse=" ")))
            
            if (abs(cor) >= abs(cor_hero)) {
                cor_hero <- cor
                i_hero <- i
                j_hero <- j
            }
            
            if (j==12) break
        }
    }
    months <- seq(from=i_hero,to=i_hero+j_hero-1,by=1)%%12+1
    collect[[cov]]=months
    print(paste0(cov,": ",cor_hero," ",paste0(months,collapse=" ")))
}

for (cov in covs) {
    india_data[paste0(cov,"_transf")] <- india_data %>%
        filter(month%in%collect[[cov]]) %>% 
        group_by(year) %>% 
        summarise(cov=mean(!!sym(cov))) %>% 
        pull(cov) %>% 
        rep(each=12)
}
write_csv(india_data,"data/india_df.csv")

tmp <- read_csv("cluster_runs/run_2_27_a/pars.csv")
#tmp$bMAXTEMP <- 0
#tmp$bMEANTEMP <- 0
#tmp$bHADISD <- runif(nrow(tmp),-1,1)
tmp$bT <- runif(nrow(tmp),0,0.05)
tmp$rho <- runif(nrow(tmp),-5,-3)
write_csv(tmp,"cluster_runs/run_2_27_a/pars.csv")

#Forced covariates
collect$Max_Temp <- c(5,6,7)
collect$hadISD <- c(5,6,7)
collect$Mean_Temp <- c(5,6,7)
for (cov in covs) {
    india_data[paste0(cov,"_transf")] <- india_data %>%
        filter(month%in%collect[[cov]]) %>% 
        group_by(year) %>% 
        summarise(cov=mean(!!sym(cov))) %>% 
        pull(cov) %>% 
        scale %>% data.frame %>% pull %>% 
        rep(each=12)
}
write_csv(india_data,"cluster_runs/run_2_27_c/bk_df.csv")

india_data %>% ggplot(aes(x=time,y=hadISD_transf))+
    geom_line()+
    theme_classic()


#write_csv(india_data %>% select(-ends_with("transf")),"india_df.csv")

```

India linear model regressions
```{r}
case_sums <- refilled %>% 
    filter(month%in%peak_months) %>% 
    group_by(year) %>% 
    summarise(cases=sum(cases)) %>% pull(cases)

df.lm <- data.frame(year=unique(refilled$year)-min(refilled$year),
                    cases=case_sums)

covs <- c("hadISD","Max_Temp","Mean_Temp")
collect <- list()
for (cov in covs) {
    i_hero <- 0
    j_hero <- 0
    p_hero <- 1
    coef_hero <- 0
    for (j in 1:12) {
        for (i in 1:12) {
            #cov="Max_Temp"
            #i=4
            #j=2
            
            batch=seq(from=i,to=i+j-1,by=1)%%12+1

            df.lm$cov <- refilled %>% 
                group_by(year) %>% 
                filter(month%in%batch) %>% 
                summarise(test=mean(!!sym(cov))) %>% 
                pull(test) %>% scale %>% data.frame %>% pull
            
            lm.fit <- lm(log(cases)~year+cov,df.lm)
            coef <- summary(lm.fit)$coefficients[3,1]
            #r.2 <- summary(lm.fit)$r.squared
            p.val <- summary(lm.fit)$coefficients[3,4]
            
            #if (p.val<0.05) print(paste0(round(coef,3),", ",paste0(batch,collapse=" ")))
            
            if (p.val < p_hero) {
                coef_hero <- coef
                p_hero <- p.val
                i_hero <- i
                j_hero <- j
            }
            
            if (j==12) break
        }
    }
    months <- seq(from=i_hero,to=i_hero+j_hero-1,by=1)%%12+1
    collect[[cov]]=months
    print(paste0(cov,
                 ": p is ",p_hero,
                 ", coef is ",coef_hero,
                 ", months are ",paste0(months,collapse=" ")))
}

#scale covariate and put trend in rho
#and also try putting trend in beta but outside exponential; linearly

india_data %>%
    filter(year==min(year)) %>% 
    select(starts_with("season")) %>% 
    apply(MARGIN=1,FUN=function(x) {mle[1:6]*x}) %>%
    melt %>% 
    ggplot(aes(x=.L1,y=value,color=.L2))+
    geom_line()+
    theme_classic()+
    scale_color_viridis(option="magma",discrete=T,end=0.9)

spline_sum <- india_data %>%
    filter(year==min(year)) %>% 
    select(starts_with("season")) %>% 
    apply(MARGIN=1,FUN=function(x) {sum(mle[1:6]*x)}) %>% 
    exp
ggplot(data.frame(x=1:12,y=spline_sum),aes(x=x,y=y))+geom_line()+theme_classic()
    
```

Cross wavelet
```{r}
diseases <- read_csv("../india_data/dataset_Ahmedabad_2023.csv")
diseases <- diseases %>% filter(year%in%unique(india_data$year)) %>% select(date=time,PF,PV)
diseases$DEN <- refilled$cases
diseases <- cbind(diseases,india_data %>% select(Max_Temp,hadISD))

diseases %>%
    pivot_longer(cols=PF:DEN,names_to="disease",values_to="cases") %>% 
    ggplot(aes(x=date,y=cases,color=disease))+
    geom_line(linewidth=0.8,alpha=0.9)+
    theme_classic()+
    scale_color_manual(values=c("#636363","#eb4dd6","#39b7bf"))
diseases %>%
    pivot_longer(cols=Max_Temp:hadISD,names_to="covariate",values_to="value") %>% 
    ggplot(aes(x=date,y=value,color=covariate))+
    geom_line(linewidth=0.8,alpha=0.9)+
    theme_classic()+
    scale_color_manual(values=c("#ffa8ee","black"))

nonseasonal <- diseases
for (x in names(diseases)[2:length(diseases)]) {
    #x <- "DEN"
    s <- ssa(diseases[x])
    r <- Rssa::reconstruct(s)
    nonseasonal[x] <- r[
        lapply(r,function(y) {
            #y <- r$F2
            change <- y[[x]][2:252]*y[[x]][1:251]
            (sum(change<0)/2)<(252/12)
            }) %>% 
            unlist %>% which %>% names
        ] %>% melt %>% 
            group_by(name) %>% 
            summarise(cases=sum(value)) %>% 
            pull(cases)
}

nonseasonal %>% 
    pivot_longer(cols=PF:DEN,names_to="disease",values_to="cases") %>% 
    ggplot(aes(x=date,y=cases,color=disease))+
    geom_line(linewidth=0.8,alpha=0.9)+
    theme_classic()+
    scale_color_manual(values=c("#636363","#eb4dd6","#39b7bf"))
nonseasonal %>%
    pivot_longer(cols=Max_Temp:hadISD,names_to="covariate",values_to="value") %>% 
    ggplot(aes(x=date,y=value,color=covariate))+
    geom_line(linewidth=0.8,alpha=0.9)+
    theme_classic()+
    scale_color_manual(values=c("#ffa8ee","#eaed91"))

# start <- 18
# stop <- start+2
# r2 <- melt(r[c(start:stop)]) %>% rename(component=.L1,time=name,cases=value)
# r2$time <- rep(diseases$date,stop-start+1)
# ggplot(r2,aes(x=time,y=cases,color=component))+
#     geom_line()+
#     scale_color_manual(values=c("red",viridis_pal()(stop-start+1)))+
#     theme_classic()+
#     geom_vline(xintercept=c(2003:2023),linetype=2,linewidth=0.1)
# 
# interannual <- list(DEN=c(6,7,11),
#                     PF=c(4,5,10,11),
#                     PV=c(4,5,11,12))
# 
# tmp <- map2(names(interannual),interannual,function(x,y) {
#     #x="DEN"
#     #y=c(6,7,11)
#     s <- ssa(diseases[x])
#     r <- Rssa::reconstruct(s)
#     melt(r[y]) %>% 
#         group_by(name) %>% 
#         summarise(cases=sum(value)) %>% 
#         pull(cases)
#     })
# detrended_disease <- melt(tmp)
# detrended_disease$.L1 <- names(interannual)[detrended_disease$.L1]
# detrended_disease <- detrended_disease %>% 
#     rename(disease=.L1,time=name,cases=value) %>% 
#     mutate(time=rep(diseases$date,3))
# 
# ggplot(detrended_disease, aes(x=time,y=cases,color=disease))+
#     geom_line()+
#     theme_classic()
# 
# detrended_disease <- detrended_disease %>%
#     pivot_wider(id_cols=time,names_from=disease,values_from=cases)


#nonseasonal$Max_Temp <- diseases$Max_Temp
#nonseasonal$hadISD <- diseases$hadISD
dis <- c("DEN","PV","PF","Max_Temp","hadISD")
dis1 <- dis[1]
dis2 <- dis[5]
wc <- analyze.coherency(nonseasonal, my.pair = c(dis1,dis2),
                           loess.span = 0,
                           dt = 1/12, dj = 1/100,
                           lowerPeriod = 1,
                           upperPeriod = 8,
                           window.type.t = 1, window.type.s = 1,
                           window.size.t = 1, window.size.s = 1,
                           make.pval = TRUE, n.sim = 10)
wc.image(wc, n.levels = 250,
         legend.params = list(lab = "cross-wavelet power levels"),
         timelab = "year", periodlab = "period (years)",
         main=paste0(dis1," and ",dis2," coherence"),
         color.key = "interval",exponent=0.5,
         spec.time.axis=list(at=seq(from=0,to=252,length.out=21),
                             labels=2003+0:20),maximum.level=3.4)
wc.image(wc, n.levels = 250,
         legend.params = list(lab = "cross-wavelet power levels"),
         timelab = "year", periodlab = "period (years)",
         main=paste0(dis1," and ",dis2," coherence"),
         color.key = "interval",
         spec.time.axis=list(at=seq(from=0,to=252,length.out=21),
                             labels=2003+0:20))

```

Create climate data
```{r}
#https://www.metoffice.gov.uk/hadobs/hadisd/

library(zoo)
library(lubridate)
library(ncdf4)

dataset <- nc_open("../hadisd.3.4.2.202501p_19310101-20250201_484550-99999_humidity.nc")
dataset_rain <- nc_open("../hadisd.3.4.2.202501p_19310101-20250201_484550-99999.nc")

names(dataset_rain$var)
time <- ncvar_get(dataset_rain, "time")
depth <- c(24,18,15,12,9,6,3,2,1)[6]
var <- paste0("precip",depth,"_depth")
rain <- ncvar_get(dataset_rain, var)

rain_data <- data.frame(time=time,rain=rain) %>%
    mutate(days=round(time/24)) %>% 
    mutate(time = as.Date("1931-01-01 00:00")+hours(time)) %>%
    filter(time >= as.Date("1970-01-01 00:00") & time <= as.Date("2019-12-31 23:59")) %>%
    mutate(day = yday(time),year=format(time,"%Y")) %>% 
    mutate(time = decimal_date(time)) %>% 
    filter(!is.na(rain)&rain>=0)
rain_data %>%
    ggplot(aes(x=time,y=rain))+
    geom_point()+
    theme_classic()

print(dataset)
{
  sink("../hadISD_metadata.txt")
  print(dataset)
  sink()
}
time <- ncvar_get(dataset, "time")
Temp <- ncvar_get(dataset, "temperatures")
#RH <- ncvar_get(dataset, "relative_humidity")
Dew <- ncvar_get(dataset, "dewpoints")
#Precip <- ncvar_get(dataset, "precip24_depth")

time <- time %>% as.numeric()
Temp <- Temp %>% as.numeric()
#RH <- RH %>% as.numeric()
Dew <- Dew %>% as.numeric()
#Precip <- Precip %>% as.numeric()

climate_data <- data.frame(time=time,Temp=Temp,Dew=Dew) %>%
    mutate(days=round(time/24)) %>% 
    mutate(time = as.Date("1931-01-01 00:00")+hours(time)) %>%
    filter(time >= as.Date("1970-01-01 00:00") & time <= as.Date("2019-12-31 23:59")) %>%
    mutate(day = yday(time),year=format(time,"%Y")) %>% 
    mutate(time = decimal_date(time)) %>%
    mutate(
        temp = na.approx(if_else(Temp > 50 | Temp < 0, NA, Temp)),
        Dew = na.approx(if_else(Dew > 35 | Dew < -20.1, NA, Dew)))

magnus <- function(Temp, Dew) {
    beta <- 17.625
    lambda <- 243.04
    top <- exp((beta*Dew)/(lambda+Dew))
    bottom <- exp((beta*Temp)/(lambda+Temp))
    RH <- 100*top / bottom
    return(RH)
}

climate_data <- climate_data %>%
    mutate(
        Temp = round(Temp, digits = 2),
        Dew = round(Dew, digits = 2),
        RH = round(magnus(Temp,Dew), digits = 2)) %>% 
    select(-Dew)

precip <- read_csv("data/precipitation_regions.csv") %>% rename(day=doy,time=date)
precip <- precip %>% 
    filter(region=="Central") %>% 
    select(time,precip,day,year) %>% 
    mutate(time=decimal_date(time)) %>% 
    filter(year<=max(climate_data$year))

climate_data <- climate_data %>%
    filter(year>=min(precip$year)) %>% 
    mutate(days=days-min(days)+1)

climate_data <- climate_data %>% 
    group_by(days) %>% 
    summarise(Temp=mean(Temp),RH=mean(RH)) %>% 
    ungroup

precip$days <- precip$day
for (i in 2:nrow(precip)) {
    if (precip$day[i]==1) {
        precip$days[i:nrow(precip)]=precip$days[i:nrow(precip)]+precip$day[i-1]
    }
}

climate_data <- climate_data[match(precip$days,climate_data$days),] %>% 
    select(-days) %>% 
    bind_cols(precip %>% select(precip,time,day)) %>%
    mutate(Temp=na.approx(Temp),RH=na.approx(RH))

climate_data <- climate_data %>% 
    mutate(year=year(date_decimal(time))) %>% 
    rename(Precip=precip)

write_csv(climate_data,"data/mosquito_clim_data.csv")

climate_data <- read_csv("data/mosquito_clim_data.csv")

```

Create mosquito pars
```{r}
climate_data %>% 
    pivot_longer(cols=Temp:Precip,names_to="covariate",values_to="value") %>% 
    ggplot(aes(x=time,y=value,color=covariate))+
    geom_point(alpha=0.5,size=0.7)+
    theme_classic()+
    scale_color_manual(values=c("#636363","#eb4dd6","#39b7bf"),
                       labels=c("Rainfall","Relative humidity","Temperature"))+
    xlab("Time")+ylab("Value")+
    guides(color=guide_legend(title="Climate covariate"))

mosq_pars <- climate_data

k <- 3.3e-6
mosq_pars$Evap <- with(mosq_pars,k*(25+Temp)^2*(100-RH))

delta_rain <- with(mosq_pars,Precip-Evap)
Water <- rep(0,nrow(mosq_pars)+1)
H_max <- 30
for (i in 2:length(Water)) {
    change <- delta_rain[i-1]+Water[i-1]
    if (change>0) Water[i]=min(H_max,change)
}
mosq_pars$Water <- Water[2:length(Water)]

K_max <- 400*2
mosq_pars$K <- K_max*(mosq_pars$Water/H_max)+1

R_thresh <- 10
frac <- (mosq_pars$Precip/R_thresh)^5
mosq_pars$fR <- 0.8*(frac/(1+frac))

mosq_pars$extreme <- (mosq_pars$Temp<10)*0.5

beta=1.19*2

mosq_pars$theta <- 0
mosq_pars$theta[mosq_pars$Temp>11.7 & mosq_pars$Temp<37.2] <- 
    with(mosq_pars,0.1137*(-5.4+
                               1.8*Temp-
                               0.2124*Temp^2+
                               0.01015*Temp^3-
                               0.0001515*Temp^4))

Temp0 <- 273.15
R0 <- 8.314

Rx <- c(0.24,0.2088,0.384)
Ha <- c(10798,26018,14931)
Hh <- c(100000,55990,-472379)
Temp.5 <- c(14184,304.6,148)

matur <- function(Temp) {
    Rx*((Temp+Temp0)/298)*
        (exp((Ha/R0)*(1/298-1/(Temp+Temp0)))/
             (1+exp((Hh/R0)*(1/Temp.5-1/(Temp+Temp0)))))
}
matur_rates <- sapply(mosq_pars$Temp,matur) %>% t %>% as.data.frame
classes <- c("E","L","P")
colnames(matur_rates) <- paste0("mature_",classes)
mosq_pars <- cbind(mosq_pars,matur_rates)
mosq_pars$mature_L[mosq_pars$Temp<13.4] <- 0

mu_E <- 0.011
mu_M <- 0.091
mosq_pars$mu_L_P <- 0.01+0.9725*exp(-(mosq_pars$Temp-4.85)/2.7035)

```

Implement Euler integration
```{r}
equations <- function(df,mosq,h,EOD) {
    mosq[5] <- mosq[5]+h*with(df,mature_P*mosq[4]-mu_M*mosq[5])
    
    mosq[1] <- mosq[1]+h*with(df,beta*theta*mosq[5]-mu_E*mosq[1]-EOD*fR*mosq[1])
    
    Cg <- with(df,max(0,(1-mosq[3]/K)[1,1]))
    mosq[2] <- mosq[2]+h*with(df,EOD*fR*mosq[1]-max(mu_E,EOD*extreme)*mosq[2]-mature_E*Cg*mosq[2])
    
    Cl <- with(df,1.5*mosq[3]/K)
    mosq[3] <- mosq[3]+h*with(df,mature_E*Cg*mosq[2]-mature_L*mosq[3]-max(mu_L_P+Cl,EOD*extreme)*mosq[3])
    
    mosq[4] <- mosq[4]+h*with(df,mature_L*mosq[3]-max(mu_L_P,EOD*extreme)*mosq[4]-mature_P*mosq[4])
    
    return(mosq)
}

h <- 0.05
expanded_data <- mosq_pars[rep(1:nrow(mosq_pars),each=1/h),]
mosq_classes <- data.frame(matrix(1,nrow=nrow(expanded_data),ncol=5))
names(mosq_classes) <-c("Ed","Ew","L","P","M")

max_years <- diff(range(mosq_pars$year))+1

n_years <- max_years
time_start <- min(climate_data$time)
time_end <- time_start+n_years-1/365
idx_end <- match(round(time_end,3),round(expanded_data$time,3))+1/h-2

for (i in 2:idx_end) {
    #i=2
    if (i%%1000==0) print(i)
    EOD=0
    if ((i+1)%%100==0) EOD=1
    mosq_classes[i,] <- equations(expanded_data[i-1,],mosq_classes[i-1,],h,EOD)

}

mosq_classes$time <- expanded_data$time

mosq_classes %>% ggplot(aes(x=time,y=M))+
    geom_line()+
    theme_classic()

write_csv(mosq_classes,"mosquito_populations.csv")

```

Make monthly data
```{r}
mosq_classes <- read_csv("./mosquito_populations.csv")
mosq_classes$time <- round(mosq_classes$time,3)

daily_mosq <- mosq_classes[seq(from=(1/h)/2,
                               to=nrow(mosq_classes)-(1/h)/2,
                               by=1/h),]

daily_mosq$date <- date_decimal(daily_mosq$time)
daily_mosq$year <- year(daily_mosq$date)
daily_mosq$month <- month(daily_mosq$date)

bk_df <- read_csv("data/full_time.csv")
bk_df <- bk_df %>% filter(time>=min(daily_mosq$time)&
                              time<=max(daily_mosq$time))

monthly_mosq <- daily_mosq %>%
    filter(year>=min(bk_df$time)&
               year<=max(bk_df$time)) %>% 
    select(M,month,year) %>% 
    group_by(month,year) %>% 
    summarise(mean_m=mean(M),max_m=max(M)) %>% 
    ungroup

bk_df <- cbind(bk_df,monthly_mosq %>% select(mean_m,max_m))

bk_df %>%
    pivot_longer(cols=c(cases,mean_m:max_m),
                       names_to="Variable",
                       values_to="Value") %>% 
    ggplot(aes(x=time,y=Value))+
    geom_line()+
    theme_classic()+
    xlab("Time")+
    facet_wrap(~Variable,scales="free_y")


#write_csv(bk_df,"cluster_runs/run_2_25_a/bk_df.csv")
#tmp <- read_csv("cluster_runs/run_2_25_a/pars.csv") %>% 
#    select(-bT) %>% 
#    mutate(bM=runif(n(),0,2)) %>% 
#    write_csv("cluster_runs/run_2_25_a/pars.csv")

```

Do correlations
```{r}
peak_months <- c(5,6,7,8,9,10,11,12)

big_years <- bk_df %>% 
    mutate(year=year(date_decimal(time))) %>% 
    group_by(year) %>% 
    filter(max(cases)>=438) %>% 
    ungroup %>% 
    mutate(month=rep(1:12,n()/12))

case_sums <- big_years %>% 
    filter(month%in%peak_months) %>% 
    group_by(year) %>% 
    summarise(cases=sum(cases)) %>% pull(cases)

covs <- c("mean_m","max_m")
collect <- list()
for (cov in covs) {
    i_hero <- 0
    j_hero <- 0
    cor_hero <- 0
    for (j in 1:12) {
        for (i in 1:12) {
            #cov="max_m"
            #i=7
            #j=3
            
            batch=seq(from=i,to=i+j-1,by=1)%%12+1

            batched <- big_years %>% 
                group_by(year) %>% 
                filter(month%in%batch)
            
            #batched <- refilled %>% 
            #    group_by(year) %>% 
            #    filter(month%in%batch)
            
            test_cov <- batched %>% 
                summarise(test=mean(!!sym(cov))) %>% 
                pull(test)
            
            cor <- cor(case_sums,test_cov)
            
            #if (abs(cor)>0.25) print(paste0(cor,", ",paste0(batch,collapse=" ")))
            
            if (abs(cor) >= abs(cor_hero)) {
                cor_hero <- cor
                i_hero <- i
                j_hero <- j
            }
            
            if (j==12) break
        }
    }
    months <- seq(from=i_hero,to=i_hero+j_hero-1,by=1)%%12+1
    collect[[cov]]=months
    print(paste0(cov,": ",cor_hero," ",paste0(months,collapse=" ")))
}

for (cov in covs) {
    bk_df[paste0(cov,"_transf")] <- bk_df %>%
        mutate(year=year(date_decimal(time)),
               month=rep(1:12,n()/12)) %>% 
        filter(month%in%collect[[cov]]) %>% 
        group_by(year) %>% 
        summarise(cov=mean(!!sym(cov))) %>% 
        pull(cov) %>% 
        rep(each=12)
}
#write_csv(bk_df,"cluster_runs/run_2_26_a/bk_df.csv")

#tmp <- read_csv("cluster_runs/run_2_26_a/pars.csv")
#tmp$bMAX_M <- runif(nrow(tmp),0,2)
#tmp$bMEAN_M <- 0
#write_csv(tmp,"cluster_runs/run_2_26_a/pars.csv")

bk_df %>% 
    mutate(year=year(date_decimal(time))) %>% 
    pivot_longer(cols=max_m_transf:mean_m_transf,names_to="covariate",values_to="count") %>% 
    ggplot(aes(x=year,y=count,color=covariate))+
    geom_line()+
    theme_classic()+
    scale_color_manual(values=c("#eb4dd6","#39b7bf"),labels=c("max mosquitos","mean mosquitos"))

```

SSA/wavelets for mosquitos
```{r}
nonseasonal <- bk_df %>% select(cases,mean_m)
for (x in c("cases","mean_m")) {
    #x <- "cases"
    s <- ssa(nonseasonal[x])
    r <- Rssa::reconstruct(s)
    nonseasonal[x] <- r[
        lapply(r,function(y) {
            #y <- r$F2
            change <- y[[x]][2:456]*y[[x]][1:455]
            (sum(change<0)/2)<(456/12)
            }) %>% 
            unlist %>% which %>% names
        ] %>% melt %>% 
            group_by(name) %>% 
            summarise(cases=sum(value)) %>% 
            pull(cases)
}

nonseasonal %>% 
    mutate(Time=bk_df$time) %>% 
    pivot_longer(cols=cases:mean_m,names_to="Variable",values_to="Value") %>% 
    ggplot(aes(x=Time,y=Value,color=Variable))+
    geom_line(linewidth=0.8,alpha=0.9)+
    theme_classic()+
    scale_color_manual(values=c("#eb4dd6","#39b7bf"))

wc <- analyze.coherency(nonseasonal %>% select(cases,mean_m),
                        my.pair = c("cases","mean_m"),
                        loess.span = 0,
                        dt = 1/12, dj = 1/100,
                        lowerPeriod = 1/2,
                        upperPeriod = 8,
                        window.type.t = 1, window.type.s = 1,
                        window.size.t = 1, window.size.s = 1,
                        make.pval = TRUE, n.sim = 10)

wc.image(wc, n.levels = 250,
         legend.params = list(lab = "cross-wavelet power levels"),
         timelab = "year", periodlab = "period (years)",
         main="DEN and mosquito coherence",
         color.key = "interval",
         spec.time.axis=list(at=seq(from=0,to=38*12,length.out=38),
                             labels=1981+0:37))

```

Mosquito seasonality
```{r}
seasonal <- bk_df %>% select(time,mean_m) %>% rename(nonseasonal=mean_m)
s <- ssa(seasonal$nonseasonal)
r <- Rssa::reconstruct(s)
seasonal$seasonal <- r[
        lapply(r,function(y) {
            change <- sum((y[2:456]*y[1:455])<0)/2
            change >= (456/12)
            }) %>% 
            unlist %>% which %>% names
        ] %>% melt %>% 
            group_by(name) %>% 
            summarise(value=sum(value)) %>% 
            pull(value)

seasonal <- cbind(seasonal,splines=apply(bk_df %>% select(starts_with("season")),1,function(x) sum((unlist(as.vector(mle[1,1:6])))*x)))

seasonal %>% 
    pivot_longer(cols=seasonal:splines,names_to="variable",values_to="value") %>% 
    ggplot(aes(x=time,y=value,color=variable))+
    geom_line(linewidth=0.8,alpha=0.9)+
    theme_classic()+
    scale_color_manual(values=c("#39b7bf","#cc8c47"))

wc <- analyze.coherency(seasonal, my.pair = c("nonseasonal","splines"),
                           loess.span = 0,
                           dt = 1/12, dj = 1/100,
                           lowerPeriod = 0.5,
                           upperPeriod = 6,
                           window.type.t = 1, window.type.s = 1,
                           window.size.t = 1, window.size.s = 1,
                           make.pval = TRUE, n.sim = 10)
nyears <- diff(range(round(seasonal$time)))
start_year <- round(seasonal$time[1])
wc.image(wc, n.levels = 250,
         legend.params = list(lab = "cross-wavelet power levels"),
         timelab = "year", periodlab = "period (years)",
         main="mean_m and splines coherence",
         color.key = "interval",exponent=0.5,
         spec.time.axis=list(at=seq(from=0,to=nrow(seasonal),length.out=nyears),
                             labels=start_year+0:(nyears-1)))

```

Simulate from new model
```{r}
bk <- read_csv("data/full_time.csv") %>% filter(time<2000)

nino_years <- bk %>% select(time,nino) %>% filter(nino>0) %>% pull(time) %>% round %>% unique
nino_years <- nino_years[(1:length(nino_years))%%2==1]

source("objects/object_test.R")
covariates <- covariate_table(bk %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

pomped <- construct_pomp(bk,covariates)

sim_vals <- c(b1=0.00802,b2=0.0569,b3=2.91,b4=1.91,b5=1.38,b6=-0.134,
              bEFF=0,bNino=1.5,bNina=0,
              sigma=0.255,
              beta_out=0.0001,alpha=0.648,
              delta=1/60,
              muE1I1=365/10,muI1R1=365/10,muR1H=365/2,muE2I2=365/10,
              tau=0.1,
              eta=100,omega=365/1,
              rho=0.05,
              S1_0=0.848,E1_0=0.00462,I1_0=0.00915,R1_0=0.11,H_0=0,
              S2_0=0.0161,E2_0=0.00547,I2_0=0.00605,
              K_0=0.0023,F_0=0.0101,
              sig_obs=0.05)

coef(pomped,par_names) <- unname(sim_vals[par_names])

sims <- pomped %>% simulate(nsim = 500,include.data = F, format = "data.frame")
sims_cases <- sims %>% 
    select(time,cases) %>% 
    group_by(time) %>% 
    summarise(cases=mean(cases))

ggplot(sims_cases, aes(x=time, y=cases)) +
    geom_line()+
    labs(x = "Year", y = "Cases", title="Simulation")+
    theme_classic()+
    theme(legend.position = "none")+
    geom_vline(xintercept=nino_years,color="#de0909",linewidth=0.6,linetype=2,alpha=0.5)



sims <- pomped %>% simulate(nsim = 1000,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,cases)
sims_cases <- sims_cases %>%
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    mutate(cases=ifelse(is.na(cases),0,cases))

colors <- c("black","#de0909")
labels <- c("Data","Simulation")

ggplot(sims_cases, aes(x=time, y=cases, color=.id, fill=.id)) +
    ggdist::stat_lineribbon(.width = c(0.05,0.95), alpha=0.5, linewidth=0.8) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_fill_manual(values = colors,labels = labels) +
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))
    

pf <- pfilter(pomped,Np=1000)
logLik(pf)

```

Simulate from Jaime model
```{r}
bk <- read_csv("data/full_time.csv") %>% filter(time<2000)

nino_years <- bk %>% select(time,nino) %>% filter(nino>0) %>% pull(time) %>% round %>% unique
nino_years <- nino_years[(1:length(nino_years))%%2==1]

source("objects/object_jaime_seirseir.R")
covariates <- covariate_table(bk %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

pomped <- construct_pomp(bk,covariates)

sim_vals <- c(b1=-4,b2=-4,b3=2,b4=4,b5=2,b6=-4,bEFF=0,bNino=1.5,bNina=0,
            sigma=0.005,beta_out=0.0001,alpha=0.65,
            delta=1/60,
            muEI=365/10,muIR=365/10,muRhRl=365/10,muRlS=2,
            theta=1,
            p1=0.2,p2=0.8,
            tau=0.01,rho=0.005,
            S1_0=0.9,E1_0=0.001,I1_0=0.001,Rh_0=0.3,Rl_0=0.3,
            S2_0=0.9,E2_0=0.001,I2_0=0.001,
            K_0=0.1,F_0=0.1,
            sig_obs=0.05)

coef(pomped,par_names) <- unname(sim_vals[par_names])

sims <- pomped %>% simulate(nsim = 100,include.data = F, format = "data.frame")
sims_cases <- sims %>% 
    select(time,cases) %>% 
    group_by(time) %>% 
    summarise(cases=mean(cases))

ggplot(sims_cases, aes(x=time, y=cases)) +
    geom_line()+
    labs(x = "Year", y = "Cases", title="Simulation")+
    theme_classic()+
    theme(legend.position = "none")+
    geom_vline(xintercept=nino_years,color="#de0909",linewidth=0.6,linetype=2,alpha=0.5)



sims <- pomped %>% simulate(nsim = 1000,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,cases)
sims_cases <- sims_cases %>%
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    mutate(cases=ifelse(is.na(cases),0,cases))

colors <- c("black","#de0909")
labels <- c("Data","Simulation")

ggplot(sims_cases, aes(x=time, y=cases, color=.id, fill=.id)) +
    ggdist::stat_lineribbon(.width = c(0.05,0.95), alpha=0.5, linewidth=0.8) +
    labs(x = "Year", y = "Cases", title="Dengue in Bangkok")+
    scale_fill_manual(values = colors,labels = labels) +
    scale_color_manual(values = colors,labels = labels) +
    theme_classic()+
    theme(legend.position = "bottom",
          legend.title=element_blank(),
          text = element_text(size = 14))
    

pf <- pfilter(pomped,Np=1000)
logLik(pf)

```

Look at S for run_3_14_c
```{r}
sim_s <- pomped %>% simulate(nsim=1000,format="data.frame")
sims_s <- sim_s %>% select(-c(cases,.id)) %>% 
    group_by(time_fact=as.factor(time)) %>% 
    summarise_all(mean) %>% 
    select(-time_fact) %>%  
    mutate_at(vars(-c(C,K,F,time)),function(x) x/bk$pop)

filtered_mean <- pomped %>% pfilter(Np=1000,filter.mean=T)
filtered_S <- filtered_mean@filter.mean %>% 
    t %>% 
    bind_cols(time=bk$time) %>% 
    mutate_at(vars(-c(C,K,F,time)),function(x) x/bk$pop)

cols_plot <- c("C")

tmp <- sims_s
tmp <- filtered_S

tmp %>% 
    select(all_of(c("time",cols_plot))) %>% 
    mutate(cases=bk$cases) %>% 
    mutate_at(vars(-time),function(x) x/max(x)) %>% 
    filter(time>=1989&time<1997) %>% 
    pivot_longer(cols=-time,
                 names_to="group",
                 values_to="count") %>% 
    mutate(group=factor(group,levels=c("cases",cols_plot,"time"))) %>% 
    ggplot(aes(x=time,y=count,color=group))+
    geom_line()+
    theme_classic()+
    scale_color_viridis_d(option="magma",begin=0.3)+
    theme(panel.background=element_rect(fill='black',color='black'),
          plot.background=element_rect(fill='black',color='black'),
          legend.background=element_rect(fill='black',color='black'),
          text=element_text(color="white"),
          axis.text=element_text(color="white"),
          axis.line=element_line(color="white"),
          axis.ticks=element_line(color="white"))
    scale_color_manual(values=c("#a576db","#7cf2b1","#f2c51f","#f54997"))

# tmp <- sims_s
# tmp <- filtered_S
# start <- 1979
# end <- 2000
# tmp %>%
#     mutate(cases=bk$cases/bk$pop) %>%
#     filter(time>=start & time<end) %>% 
#     pivot_longer(cols=c(S1,S2),names_to="Class",values_to="Value") %>%
#     ggplot(aes(x=Value,y=F,color=time))+
#     geom_point(size=2,alpha=0.6)+
#     facet_wrap(~Class)+
#     theme_classic()+
#     scale_colour_viridis_c(option="magma",name="Time",direction=-1)+
#     xlab("Fraction of population")+
#     ylab("Realized FOI")

#tmp %>% ggplot(aes(x=log(F)))+geom_density()+theme_classic()

#Calculate differences
tmp <- sims_s
tmp <- filtered_S
tmp_diff <- tmp
tmp_diff[1:(nrow(tmp_diff)-1),c("S1","S2")] <- 
    (tmp_diff[2:nrow(tmp_diff),c("S1","S2")]-
    tmp_diff[1:(nrow(tmp_diff)-1),c("S1","S2")])/
    tmp_diff[1:(nrow(tmp_diff)-1),c("S1","S2")]
tmp_diff <- tmp_diff[1:(nrow(tmp_diff)-1),]

bg.color <- "#030029"
text.color <- "#bdb8ff"

#>1987 & <1993
#>1997 & <2003

offset <- 9
n_years <- 5

start <- 1979+offset
end <- start+n_years

start <- 1988
end <- 1993

start <- 1998
end <- 2003

plotter1 <- tmp_diff %>%
    filter(time>=start & time<end) %>% 
    pivot_longer(cols=c(S1,S2),names_to="Class",values_to="Value")
plotter1 %>%
    ggplot(aes(x=1-F,y=Value,color=time))+
    geom_point(size=1.2,alpha=0.7,shape=4)+
    geom_path(size=0.4,alpha=0.6)+
    facet_wrap(~Class,labeller=labeller(Class=~paste("FILTERED ",.x,"/ N")))+
    theme_classic()+
    scale_color_gradient(name="year",
                         low="#b5095c",
                         high="#ffee99",
                         limits=c(start,end))+
    scale_x_continuous(breaks=breaks_extended(n=6)(1-plotter1$F),
                       labels=1-round(breaks_extended(n=6)(1-plotter1$F),2))+
    ylab('% change')+
    xlab("infection rate")+
    theme(panel.background=element_rect(fill=bg.color,
                                        color=bg.color),
          plot.background=element_rect(fill=bg.color,
                                       color=bg.color),
          legend.background=element_rect(fill=bg.color,
                                         color=bg.color),
          text=element_text(color=text.color,size=14,family="mono"),
          axis.text=element_text(color=text.color),
          axis.text.x=element_text(angle=70,hjust=1),
          axis.title.y=element_text(vjust=3),
          axis.title.x=element_text(vjust=-1),
          axis.line=element_line(color=text.color),
          axis.ticks=element_line(color=text.color),
          plot.margin = margin(r=15,t=15,l=15,b=15),
          strip.background=element_rect(fill=bg.color,
                                        color=text.color),
          strip.text=element_text(color=text.color,size=14),
          legend.title=element_text(vjust=4))

plotter2 <- tmp_diff %>%
    filter(time>=start & time<end)
plotter2 %>% 
    ggplot(aes(x=1-F,y=S1+S2,color=time))+
    geom_point(size=1.2,alpha=0.7,shape=4)+
    geom_path(size=0.4,alpha=0.6)+
    theme_classic()+
    scale_color_gradient(name="year",
                         low="#b5095c",
                         high="#ffee99",
                         limits=c(start,end))+
    scale_x_continuous(breaks=breaks_extended(n=11)(1-plotter2$F),
                       labels=1-round(breaks_extended(n=11)(1-plotter2$F),2))+
    ylab('% change')+
    xlab("infection rate")+
    theme(panel.background=element_rect(fill=bg.color,
                                        color=bg.color),
          plot.background=element_rect(fill=bg.color,
                                       color=bg.color),
          legend.background=element_rect(fill=bg.color,
                                         color=bg.color),
          text=element_text(color=text.color,size=14,family="mono"),
          axis.text=element_text(color=text.color),
          axis.text.x=element_text(angle=45,hjust=1),
          axis.title.y=element_text(vjust=3),
          axis.title.x=element_text(vjust=-1),
          axis.line=element_line(color=text.color),
          axis.ticks=element_line(color=text.color),
          plot.title=element_text(size=17,family="mono"),
          plot.margin = margin(r=15,t=15,l=15,b=15),
          legend.title=element_text(vjust=4))+
    ggtitle("FILTERED (S1+S2)/N")


ggplot(bk %>% filter(time>1997&time<2003),aes(x=time,y=cases/pop))+
    geom_line()+
    theme_classic()+
    geom_hline(yintercept=1.05*(1e-4),linetype=2)

outbreaks <- with(bk[1:(nrow(bk)-12),],time[cases/pop>=1.05*(1e-4)]) %>% 
    floor %>% unique
year_groups <- c(rbind(outbreaks,outbreaks+1))
tmp_diff$enso <- (bk$nino+bk$nina)[1:(length(bk$nino)-1)]
plotter3 <- lapply(1:(length(year_groups)/2),function(i) {
    years <- year_groups[(2*i-1):(2*i)]
    tmp_diff %>% filter(floor(time)%in%years) %>% mutate(group=i)
    }) %>% bind_rows

plotter3 <- plotter3 %>% 
    pivot_longer(cols=c(S1,S2),names_to="Class",values_to="Value")

plotter3 %>%
    ggplot(aes(x=1-F,y=Value,color=enso))+
    geom_point(size=1.2,alpha=0.7,shape=4)+
    geom_path(size=0.4,alpha=0.6)+
    facet_wrap(~Class,labeller=labeller(Class=~paste("FILTERED ",.x,"/ N")))+
    theme_classic()+
    scale_color_gradient(name="ENSO",
                         low="#b5095c",
                         high="#ffee99")+
    scale_x_continuous(breaks=breaks_extended(n=6)(1-plotter1$F),
                       labels=1-round(breaks_extended(n=6)(1-plotter1$F),2))+
    ylab('% change')+
    xlab("infection rate")+
    theme(panel.background=element_rect(fill=bg.color,
                                        color=bg.color),
          plot.background=element_rect(fill=bg.color,
                                       color=bg.color),
          legend.background=element_rect(fill=bg.color,
                                         color=bg.color),
          text=element_text(color=text.color,size=14,family="mono"),
          axis.text=element_text(color=text.color),
          axis.text.x=element_text(angle=70,hjust=1),
          axis.title.y=element_text(vjust=3),
          axis.title.x=element_text(vjust=-1),
          axis.line=element_line(color=text.color),
          axis.ticks=element_line(color=text.color),
          plot.margin = margin(r=15,t=15,l=15,b=15),
          strip.background=element_rect(fill=bg.color,
                                        color=text.color),
          strip.text=element_text(color=text.color,size=14),
          legend.title=element_text(vjust=4))

```

Look at S for run_2_28_e
```{r}
beta_in <- apply(bk %>% select(starts_with("season")),
      1,
      function(x) sum(x*mle[1:6])) +
    with(bk,season5*(mle$bT*beta_eff+mle$bNino*nino+mle$bNina*nina))

filtered_mean <- pomped %>% pfilter(Np=1000,filter.mean=T)
filtered_S <- filtered_mean@filter.mean[c("S","I","C"),] %>% t %>%
    bind_cols(time=bk$time) %>% 
    mutate(foi=mle$beta_out+beta_in*(I/bk$pop)^(mle$alpha)) %>% 
    select(-I)
filtered_S[,1:2] <- apply(filtered_S[,1:2],2,function(x) (x/bk$pop))

sim_s <- pomped %>% simulate(nsim=1000,format="data.frame")
sims_s <- sim_s %>% select(time,C,S,I) %>% 
    group_by(time=as.factor(time)) %>% 
    summarise(C=mean(C),S=mean(S),I=mean(I)) %>% 
    mutate(time=varhandle::unfactor(time)) %>% 
    mutate(foi=mle$beta_out+beta_in*(I/bk$pop)^(mle$alpha)) %>% 
    select(-I)
sims_s[,2:3] <- apply(sims_s[,2:3],2,function(x) (x/bk$pop))

tmp <- sims_s
tmp <- filtered_S
tmp %>% 
    mutate(C=C/max(C),
           S=S/max(S),
           beta_in=beta_in/max(beta_in),
           FOI=foi/max(foi)) %>% 
    pivot_longer(cols=c(C,S,FOI),names_to="group",values_to="count") %>% 
    ggplot(aes(x=time,y=count,color=group))+
    geom_line()+
    theme_classic()+
    scale_color_manual(values=c("#a576db","#7cf2b1","#f2c51f","#f54997"),
                       breaks=c("FOI","C","S"))+
    theme(panel.background=element_rect(fill='black',color='black'),
          plot.background=element_rect(fill='black',color='black'),
          legend.background=element_rect(fill='black',color='black'),
          text=element_text(color="white"),
          axis.text=element_text(color="white"),
          axis.line=element_line(color="white"),
          axis.ticks=element_line(color="white"))

tmp <- sims_s
tmp <- filtered_S
tmp %>% ggplot(aes(x=foi,y=C,color=S))+
    geom_point(size=2,alpha=0.8)+
    theme_classic()+
    scale_colour_viridis_c(option="inferno",name="S")+
    xlab("FOI")

```

for 2_28_e #4 and 3_14_b #2 do:
plot years 1987:1996

Test 1: swap states at 1/1/1989 and 1/1/1992, then separately simulate 1989:1990 and 1992:1996
Test 2: swap nino, nina, beta_eff data by placing 1992:1993 into 1989:1990 and placing c(1989,rep(1990,5)) into 1992:1996, then separately simulate 1989:1990 and 1992:1996

when selecting states, start with K and F; maybe remove later

## TEST 1
```{r}
bk %>% filter(time>=1999&time<2008) %>% 
    ggplot(aes(x=time,y=cases))+
    geom_line()+
    theme_classic()

#plot_years <- 1987:1996
#swap_years <- list(1989:1990,1992:1996)

plot_years <- 1997:2014
swap_years <- list(1999:2006,2009:2014)

break_years <- lapply(swap_years,function(x) x[1]) %>% unlist
end_break_years <- (lapply(swap_years,function(x) x[length(x)]) %>% unlist)+1

bk_subset <- bk %>% filter(floor(time)%in%plot_years)

sim <- pomped %>% simulate(nsim=1000,format="data.frame")
sims <- sim %>% 
    filter(floor(time)%in%plot_years)

sims_means <- sims %>% 
    group_by(time=as.factor(time)) %>% 
    summarise_at(vars(-.id),mean)

swaps <- sims_means[sims_means$time%in%break_years,state_names]

mle_exper <- rbind(mle,mle)
mle_exper[,paste0(state_names,"_0")] <- swaps[2:1,]

exper <- lapply(1:2,function(i) {
    times <- with(bk,time[floor(time)%in%swap_years[[i]]])
    pomped %>% simulate(nsim=1000,
             params=mle_exper[i,],
             times=times,
             t0=times[1]-1/12,
             format="data.frame")
    }) %>% bind_rows

sims$.id <- 0
exper$.id <- 1
sims_exper <- sims
sims_exper[floor(sims_exper$time)%in%unlist(swap_years),] <- exper

classes <- c("Original simulation","Exchanged states")
sims_cases <- map2(list(sims,sims_exper),
                   classes,
                   function(df,class) {
    df %>% 
        group_by(time=as.factor(time)) %>% 
        summarise(lower=quantile(cases,0.1),
              upper=quantile(cases,0.9),
              mean=mean(cases),
              S=mean(S)
              #S=mean(S1+S2)
              ) %>% 
        mutate(S=round(S/bk_subset$pop,3)) %>% 
        mutate(time=unfactor(time)) %>% 
        mutate(cases=bk_subset$cases) %>% 
        mutate(Class=class) %>% 
        mutate(S_scale=round((999*(S-min(S))/(max(S)-min(S))))+1) %>% 
        mutate(colors=viridis(n=1000,
                              option="rocket",
                              begin=1,end=0.2)[S_scale])
}) %>% bind_rows %>% mutate(Class=factor(Class,levels=classes))

line_colors <- sims_cases %>% 
    filter(Class=="Original simulation"&time%in%break_years) %>% 
    pull(colors)
line_colors <- c(line_colors,rev(line_colors))
axis_ticks <- plot_years[seq(2,length(plot_years),2)]
annot_df <- sims_cases %>%
                  filter(Class!="Original simulation") %>% 
                  mutate(Class=factor(Class,levels=classes)) %>% 
                  head(n=1)

ggplot(sims_cases,aes(x=time))+
    geom_rect(aes(xmin=time,xmax=time+1/12,
                  ymin=lower,ymax=upper),
              fill=sims_cases$colors,alpha=0.8)+
    geom_line(aes(y=mean,color=S),alpha=0)+
    geom_line(aes(y=cases),linewidth=0.6)+
    geom_vline(xintercept=break_years,
               linetype=2,linewidth=0.6,alpha=0.8,
               color=line_colors)+
    geom_rect(xmin=-Inf,xmax=Inf,ymin=-Inf,ymax=0,fill="white")+
    geom_rect(data=annot_df,
              xmin=break_years[1],xmax=end_break_years[1],
              ymin=0,ymax=max(sims_cases$upper),
              fill=line_colors[2],alpha=0.2
              )+
    geom_rect(data=annot_df,
              xmin=break_years[2],xmax=end_break_years[2],
              ymin=0,ymax=max(sims_cases$upper),
              fill=line_colors[1],alpha=0.2
              )+
    geom_rect(xmin=-Inf,xmax=Inf,ymin=max(sims_cases$upper),ymax=Inf,fill="white")+
    scale_x_continuous("Year",
                       labels=as.character(axis_ticks),
                       breaks=axis_ticks)+
    scale_color_viridis_c(#name="(S1+S2)/N",
                          name="S/N",
                          option="rocket",
                          begin=1,end=0.2)+
    ylab("Cases")+
    facet_wrap(~Class)+
    theme_classic()+
    theme(text=element_text(size=13,family="mono"),
          plot.margin = margin(r=10,t=10,l=10,b=10),
          strip.text=element_text(size=13),
          legend.title=element_text(hjust=0.1))

```

## TEST 2
```{r}
plot_years <- 1987:1996
swap_years <- list(1989:1990,1992:1996)
break_years <- lapply(swap_years,function(x) x[1]) %>% unlist
end_break_years <- (lapply(swap_years,function(x) x[length(x)]) %>% unlist)+1

bk_subset <- bk %>% filter(floor(time)%in%plot_years)

#clim_vars <- c("nino","nina","beta_eff")
clim_vars <- c("nino","nina","beta_eff","RH")
bk_swapped <- bk
bk_swapped[floor(bk_swapped$time)%in%swap_years[[1]],clim_vars] <- 
    bk[floor(bk$time)%in%swap_years[[2]],clim_vars][
        1:(12*length(swap_years[[1]])),]
bk_swapped[floor(bk_swapped$time)%in%swap_years[[2]],clim_vars] <- 
    bk[floor(bk$time)%in%swap_years[[1]],clim_vars][
        c(rep(1:(12*length(swap_years[[1]])),2),1:12),]
bk_swapped_subset <- bk_swapped %>% filter(floor(time)%in%plot_years)

covariates <- covariate_table(bk_swapped %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk_swapped, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)
pomped_swapped <- construct_pomp(bk_swapped,covariates)
coef(pomped_swapped,pars) <- unname(mle[pars])

sim <- pomped %>% simulate(nsim=1000,format="data.frame")
sims <- sim %>% 
    filter(floor(time)%in%plot_years)

sim_swapped <- pomped_swapped %>% simulate(nsim=1000,format="data.frame")
sims_exper <- sim_swapped %>% 
    filter(floor(time)%in%plot_years)

color_scale <- scales::div_gradient_pal(low="#1dabf2",mid="#d6d6d6",high="#e30775")(seq(0,1,length.out=1000))
classes <- c("Original simulation","Exchanged climate data")
sims_cases <- map2(list(sims,sims_exper),
                   classes,
                   function(df,class) {
    df %>% 
        group_by(time=as.factor(time)) %>% 
        summarise(lower=quantile(cases,0.1),
              upper=quantile(cases,0.9),
              mean=mean(cases)) %>% 
        mutate(time=unfactor(time)) %>% 
        mutate(cases=bk_subset$cases) %>% 
        mutate(Class=class)
}) %>% bind_rows %>% 
    bind_cols(bind_rows(
        bk_subset %>% select(all_of(clim_vars)),
        bk_swapped_subset %>% select(all_of(clim_vars)))) %>% 
    mutate(enso=nino+nina) %>% 
    mutate(enso_scale=round((999*(enso-min(enso))/(max(enso)-min(enso))))+1) %>% 
    mutate(colors=color_scale[enso_scale]) %>% 
    mutate(Class=factor(Class,levels=classes))

line_colors <- sims_cases %>% 
    filter(Class=="Original simulation"&time%in%break_years) %>% 
    pull(colors)
line_colors <- c(line_colors,rev(line_colors))
axis_ticks <- plot_years[seq(2,length(plot_years),2)]
annot_df_2 <- sims_cases %>%
                  filter(Class!="Original simulation") %>% 
                  mutate(Class=factor(Class,levels=classes)) %>% 
                  head(n=1)
annot_df_1 <- sims_cases %>%
                  filter(Class=="Original simulation") %>% 
                  mutate(Class=factor(Class,levels=classes)) %>% 
                  head(n=1)

ggplot(sims_cases,aes(x=time))+
    geom_rect(aes(xmin=time,xmax=time+1/12,
                  ymin=lower,ymax=upper),
              fill=sims_cases$colors,alpha=0.8)+
    geom_line(aes(y=mean,color=enso),alpha=0)+
    geom_line(aes(y=cases),linewidth=0.6)+
    geom_vline(xintercept=break_years,
               linetype=2,linewidth=0.6,alpha=0.8,
               color=line_colors)+
    geom_rect(xmin=-Inf,xmax=Inf,ymin=-Inf,ymax=0,fill="white")+
    geom_rect(data=annot_df_2,
              xmin=break_years[1],xmax=end_break_years[1],
              ymin=0,ymax=max(sims_cases$upper),
              fill=line_colors[2],alpha=0.2
              )+
    geom_rect(data=annot_df_2,
              xmin=break_years[2],xmax=end_break_years[2],
              ymin=0,ymax=max(sims_cases$upper),
              fill=line_colors[1],alpha=0.2
              )+
    geom_rect(data=annot_df_1,
              xmin=break_years[1],xmax=end_break_years[1],
              ymin=0,ymax=max(sims_cases$upper),
              fill=line_colors[1],alpha=0.2
              )+
    geom_rect(data=annot_df_1,
              xmin=break_years[2],xmax=end_break_years[2],
              ymin=0,ymax=max(sims_cases$upper),
              fill=line_colors[2],alpha=0.2
              )+
    geom_rect(xmin=-Inf,xmax=Inf,ymin=max(sims_cases$upper),ymax=Inf,fill="white")+
    scale_x_continuous("Year",
                       labels=as.character(axis_ticks),
                       breaks=axis_ticks)+
    scale_colour_gradient2(name="ENSO",
                           low="#1dabf2",mid="#d6d6d6",high="#e30775",
                           midpoint=0)+
    ylab("Cases")+
    facet_wrap(~Class)+
    theme_classic()+
    theme(text=element_text(size=13,family="mono"),
          plot.margin = margin(r=10,t=10,l=10,b=10),
          strip.text=element_text(size=13),
          legend.title=element_text(hjust=0.1,vjust=2))


```

## Shit
```{r}
peak_months <- c(5,6,7,8,9,10,11,12)
off_months <- c(1,2,3)

tmp <- sims_s
tmp <- filtered_S

beta_in <- apply(bk %>% select(starts_with("season")),
      1,
      function(x) sum(x*mle[1:6])) +
    with(bk,season5*(mle$bEFF*beta_eff+mle$bNino*nino+mle$bNina*nina))
tmp$beta_in <- beta_in
tmp$pop <- bk$pop

tmp_sums <- tmp %>% 
    mutate(date=date_decimal(time)) %>% 
    mutate(month=month(date)) %>% 
    mutate(year=year(date)) %>% 
    filter(month%in%peak_months) %>% 
    group_by(year) %>% 
    summarise(C=max(pop*C),beta=max(beta_in)) %>% 
    select(C,beta)
tmp_sums <- tmp %>% 
    mutate(date=date_decimal(time)) %>% 
    mutate(month=month(date)) %>% 
    mutate(year=year(date)) %>% 
    filter(month%in%off_months) %>% 
    group_by(year) %>% 
    summarise(S=max(pop*(S1+S2))) %>% 
    cbind(tmp_sums)

ggplot(tmp_sums,aes(x=log(beta),y=log(C),color=S))+
    geom_point(size=3,alpha=0.6)+
    theme_classic()+
    scale_color_viridis_c(option="inferno",end=0.8)

```

## Do the effective size
```{r}
bg.color <- "#0d0f0e"
text.color <- "#d9ffea"
bk %>% 
    select(beta_eff,nino,nina) %>% 
    apply(MARGIN=1,FUN=function(x) 
        x*(mle %>% select(bEFF,bNino,bNina))
        ) %>% 
    bind_rows %>% 
    rbind(exp(.)) %>%
    mutate(scale=factor(c(rep("Log",n()/2),c(rep("Original",n()/2))),
                           levels=c("Original","Log"))) %>% 
    cbind(time=rep(bk$time,2)) %>% 
    pivot_longer(cols=bEFF:bNina,
                 names_to="cov",
                 values_to="effect") %>% 
    mutate(cov=factor(cov,levels=c("bNino","bNina","bEFF"))) %>% 
    ggplot(aes(x=time,y=effect,color=cov))+
    geom_line()+
    facet_wrap(~scale,scales="free_y")+
    theme_classic()+
    scale_color_manual(name="Covariate",
                       values=c("#d42626","#40d6ed","#f0d89c"),
                       labels=c("El nio","La nia","Beta_eff"))+
    xlab("Time")+
    ylab("Effect size")+
    ggtitle("Multiplicative effect on force of infection")+
    theme(panel.background=element_rect(fill=bg.color,
                                        color=bg.color),
          plot.background=element_rect(fill=bg.color,
                                       color=bg.color),
          legend.background=element_rect(fill=bg.color,
                                         color=bg.color),
          text=element_text(color=text.color,size=14,family="mono"),
          axis.text=element_text(color=text.color),
          axis.text.x=element_text(angle=70,hjust=1),
          axis.title.y=element_text(vjust=3),
          axis.title.x=element_text(vjust=-1),
          axis.line=element_line(color=text.color),
          axis.ticks=element_line(color=text.color),
          plot.margin = margin(r=15,t=15,l=15,b=15),
          strip.background=element_rect(fill=bg.color,
                                        color=text.color),
          strip.text=element_text(color=text.color,size=14),
          legend.title=element_text(vjust=4))

```

## Replace params
```{r}
tmp <- read_csv("cluster_runs/run_4_10_c/pars.csv")
tmp <- tmp %>% select(-muRlS) %>% rename(muRS=muRhRl)
tmp$q <- runif(nrow(tmp),0.1,0.9)
write_csv(tmp,"cluster_runs/run_4_10_c/pars.csv")

```

## Process province data
```{r}
changwats <- list.files("../../thailand_stats/processed_changwats",full.names=T)
counts <- list.files("../../thailand_stats/processed_counts")
years <- unlist(lapply(counts,function(x) substr(x,1,4)))
counts <- list.files("../../thailand_stats/processed_counts",full.names=T)
counts <- lapply(counts,function(x) {
    count <- read_delim(x,delim="\n",col_names="count")$count
    count <- as.integer(gsub(",", "", count))
    })
i <- 19
years[i]
write.table(counts[[i]],"../../thailand_stats/tmp.txt",row.names=F,col.names=F)

tmp <- read_csv("/Users/juliangottfried/Desktop/old_years_converted.csv")
tmp2 <- tmp %>% distinct(Changwat,.keep_all=T)

for (i in 1:nrow(tmp2)) {
    tmp2[i,2:ncol(tmp2)] <- t(colSums(tmp[tmp$Changwat%in%tmp2$Changwat[i],2:ncol(tmp)]))
}

write_csv(tmp2,"/Users/juliangottfried/Desktop/old_years_converted.csv")

write_csv(tmp2[1,2:ncol(tmp2)]+tmp2[2,2:ncol(tmp2)],"tmp.csv")


```

## Process more province data
```{r}
# full join

correct <- function(region) {
    region[region=="Wester Region"]="Western Region"
    region[region=="Lamphua"]="Lamphun"
    region[region=="Uden Thani"]="Udon Thani"
    region[region=="Southem Region"]="Southern Region"
    region[region=="Northem Region"]="Northern Region"
    region[region=="Westem Region"]="Western Region"
    region[region=="Chatyaphum"]="Chaiyaphum"
    region[region=="Loe"]="Loei"
    region[region=="Souther Region"]="Southern Region"
    region[region=="Nakhon i Thammarat"]="Nakhon Si Thammarat"
    region[region=="Patani"]="Pattani"
    region[region=="Rot Et"]="Roi Et"
    region[region=="Lampbun"]="Lamphun"
    region[region=="Northeastem Region"]="Northeastern Region"
    region[region=="Pathur Thani"]="Pathum Thani"
    region[region=="Northen Region"]="Northern Region"
    region[region=="Phetehaburi"]="Phetchaburi"
    region[region=="Karnphaeng Phet"]="Kamphaeng Phet"
    region[region=="Chanthabuni"]="Chanthaburi"
    region[region=="Lop Buti"]="Lop Buri"
    region[region=="Kanchanabuti"]="Kanchanaburi"
    region[region=="Amanat Charoen"]="Amnat Charoen"
    region[region=="Subcentral Region"]="Central Region"
    region
}

path <- "~/Desktop/thailand_stats/last_batch"
years <- as.numeric(lapply(list.files(path),function(x) substr(x,1,4)))

files <- list.files(path,full.names=T)

old_pops <- read_csv("~/Desktop/thailand_stats/old_pops.csv")

pops <- full_join(old_pops,new_pops,by="Changwat")
write_csv(pops,"tmp.csv")

x=2007
readin <- files[years==x]
count <- read_delim(readin[1],delim="\n",col_names="y")$y
region <- read_delim(readin[2],delim="\n",col_names="y")$y
tmp <- data.frame(region,count)

#investigate Nong Bua Lam Phu

```

## Final processing?
```{r}
#write_csv(pops_cleaned,"pops_cleaned.csv")
pops_cleaned <- read_csv("pops_cleaned.csv")

missing <- (1965:2023)[which(!(1965:2023)%in%colnames(pops_cleaned))]
fill_in <- data.frame(matrix(NA,nrow=nrow(pops_cleaned),ncol=length(missing)))
colnames(fill_in) <- missing
changwats <- cbind(pops_cleaned,fill_in)
changwats <- changwats[,c(1,2,(order(colnames(changwats)[3:ncol(changwats)])+2))]
#write_csv(changwats,"changwats.csv")

(changwats$y2003[changwats$Changwat=="Bangkok"])

changwats <- read_csv("changwats.csv")
changwats_long <- changwats %>% pivot_longer(cols=-c(Changwat,Region),values_to="Pop",names_to="Year")
changwats_long %>% ggplot(aes(x=Year,y=(Pop),color=Changwat))+
    geom_point()+
    theme_classic()+
    scale_color_viridis_d(option="magma",end=0.9)+
    theme(axis.text.x=element_text(angle=90))+
    guides(color="none")

bks1 <- bk %>% filter(time==floor(time)) %>% select(time,old=pop)
bks2 <- changwats_long %>% filter(Region=="Bangkok and Vicinities") %>% select(time=Year,new=Pop) %>%
    group_by(time) %>% 
    summarise(new=sum(new))
bks2$time <- as.double(bks2$time)
bks <- full_join(bks1,bks2,by="time")
bks %>% pivot_longer(cols=old:new,names_to="source",values_to="pop") %>% 
    ggplot(aes(x=time,y=pop,color=source))+
    geom_point()+
    theme_classic()

#changwats[changwats$Changwat=="Whole Kingdom",as.character(c(1965:1972))] <- NA
#write_csv(changwats,"changwats_slimmed.csv")

# population counts for all 77 of thailand's provinces across 45 years, up to the present

```

## Do mapping!!
```{r}
provinces <- st_read("thailand-provinces.geojson",
  stringsAsFactors = FALSE,
  as_tibble = TRUE
)

seasia <- st_read("southeast-asia.geojson",
  stringsAsFactors = FALSE,
  as_tibble = TRUE
)

changwats <- read_csv("changwats.csv")

#provinces$NAME_1[!provinces$NAME_1%in%changwats$Changwat]
provinces$NAME_1[provinces$NAME_1=="Bangkok Metropolis"]="Bangkok"
provinces$NAME_1[provinces$NAME_1=="Phatthalung (Songkhla Lake)"]="Phatthalung"
provinces$NAME_1[provinces$NAME_1=="Songkhla (Songkhla Lake)"]="Songkhla"

colnames(changwats)[3:ncol(changwats)] <- paste0("y",colnames(changwats)[3:ncol(changwats)])

names(provinces)[2] <- "Changwat"
province_pop <- left_join(provinces,changwats,by="Changwat")

year <- "2023"
ppl_per_dot <- 10000

get_dot_density <- function() {
  num_dots <- data.frame(ceiling(province_pop[[paste0("y",year)]]/ppl_per_dot))
  plot_dots <- map_df(
      names(num_dots),
    ~ sf::st_sample(province_pop,size=num_dots[,.x],type = "random") %>% 
      sf::st_cast("POINT") %>% 
      sf::st_coordinates() %>% 
      as_tibble() %>% 
      setNames(c("long", "lat"))
  )
  return(plot_dots)
}
plot_dots <- get_dot_density()

ggplot(province_pop)+
    xlim(96,107)+
    ylim(4,23)+
    geom_sf(data=seasia,
            fill="#00124a",color="#002080",
            linewidth=0.3)+
    geom_sf(data=province_pop,fill="#002080",
            color="white",linewidth = 0.3,alpha=0.5)+
    scale_fill_gradient(low="black",high="white")+
    theme_classic()+
    theme(panel.background=element_rect(fill="black"))+
    xlab("")+
    ylab("")+
    geom_point(
        data=plot_dots,aes(x=long,y=lat),
        color="#bf2c15",size=0.8,alpha=0.2)

```

## Process census data
```{r}
censuses <- list.files("census_data",full.names=T)
years <- str_sub(censuses,28,31)
censuses <- map2(censuses,years,function(x,y) {
    #x=censuses[1]
    #y=years[1]
    tmp <- read.csv(x)
    colnames(tmp)[2:ncol(tmp)] <- paste0(colnames(tmp)[2:ncol(tmp)],"_",y)
    tmp
    })
census <- censuses[[1]]
for (i in censuses[2:length(censuses)]) {
    census <- full_join(census,i,by="Changwat")
}
census <- census %>% 
    mutate(Region=Region_2010,.after=Changwat) %>% 
    select(-Region_2010)
census_long <- census %>% pivot_longer(cols=-c(Changwat,Region),
                        names_to="Source",
                        values_to="Value")
census_long$Year <- str_sub(census_long$Source,-4,-1)
census_long$Population <- str_sub(census_long$Source,0,-6)
census_wide <- census_long %>%
    pivot_wider(id_cols=c(Changwat,Region,Year),
                names_from=Population,
                values_from=Value)
census_wide$Collective <- census_wide$Total-census_wide$Private
census_long <- census_wide %>% 
    pivot_longer(cols=Total:Collective,
                 names_to="Population",
                 values_to="Value")
census_wide <- census_long %>% 
    pivot_wider(id_cols=c(Changwat,Region,Population),
                names_from=Year,
                values_from=Value)
census <- census_wide
colnames(census)[4:9] <- paste0("y",colnames(census)[4:9])
write_csv(census,"census_df.csv")

```

## Map census data!
```{r}
year <- 2010
year <- paste0("y",year)
census <- read_csv("census_df.csv")

census_yr <- census %>% 
    select(Changwat,Region,Population,year) %>% 
    pivot_wider(id_cols=Changwat:Region,
                names_from=Population,
                values_from=year)

delta_census <- census %>% 
    filter(Population=="Total") %>% 
    mutate(Total=y2010-y1960) %>%
    select(Changwat,Total)

provinces <- st_read("thailand-provinces.geojson",
  stringsAsFactors = FALSE,
  as_tibble = TRUE
)

seasia <- st_read("southeast-asia.geojson",
  stringsAsFactors = FALSE,
  as_tibble = TRUE
)

plot_df <- census_yr
plot_df <- delta_census

provinces$NAME_1[!provinces$NAME_1%in%plot_df$Changwat]
provinces$NAME_1[provinces$NAME_1=="Bangkok Metropolis"]="Bangkok"
provinces$NAME_1[provinces$NAME_1=="Phatthalung (Songkhla Lake)"]="Phatthalung"
provinces$NAME_1[provinces$NAME_1=="Songkhla (Songkhla Lake)"]="Songkhla"
provinces$NAME_1[!provinces$NAME_1%in%plot_df$Changwat]

names(provinces)[2] <- "Changwat"
province_pop <- left_join(provinces,plot_df,by="Changwat")

#ppl_per_dot <- 10000
# get_dot_density <- function() {
#   num_dots <- data.frame(ceiling(province_pop[[paste0("y",year)]]/ppl_per_dot))
#   plot_dots <- map_df(
#       names(num_dots),
#     ~ sf::st_sample(province_pop,size=num_dots[,.x],type = "random") %>% 
#       sf::st_cast("POINT") %>% 
#       sf::st_coordinates() %>% 
#       as_tibble() %>% 
#       setNames(c("long", "lat"))
#   )
#   return(plot_dots)
# }
#plot_dots <- get_dot_density()

names <- c("log population","log change in\npopulation")
ggplot(province_pop)+
    xlim(96,107)+
    ylim(4,23)+
    geom_sf(data=seasia,
            fill="#0b0030",color="#090178",
            linewidth=0.3)+
    geom_sf(data=province_pop,aes(fill=log(Total)),
            color="white",linewidth = 0.01)+
    scale_fill_gradient(name=names[1],low="black",high="#f22202")+
    theme_classic()+
    theme(panel.background=element_rect(fill="black"),
          text=element_text(color="black",size=12,family="mono"))+
    xlab("")+
    ylab("")
#   geom_point(
#        data=plot_dots,aes(x=long,y=lat),
#        color="#bf2c15",size=0.8,alpha=0.2)


```

## Make new dataset
```{r}
census <- read_csv("census_df.csv")
totals <- census %>% 
    filter(Population=="Total") %>% 
    pivot_longer(cols=starts_with("y"),
                 names_to="Year",
                 values_to="Count") %>% 
    mutate(Year=as.numeric(str_sub(Year,2,5))) %>% 
    select(-c(Population,Region)) %>% 
    pivot_wider(id_cols=Year,
                names_from=Changwat,
                values_from=Count)

coefs <- apply(totals[,2:ncol(totals)],2,function(x) {
    glm(x~totals$Year,
        family=Gamma(link="log"))$coefficients
    }) %>% data.frame

times <- seq(1968,2019,by=1/12)
predictions <- apply(coefs,2,function(x) exp(x[1]+times*x[2])) %>% as.data.frame
colnames(predictions) <- str_replace_all(colnames(predictions),"[.]","")

dpopdt <- apply(predictions,1,function(x) x*t(coefs[2,])) %>% t %>% data.frame
colnames(dpopdt) <- colnames(predictions)

prov_cases <- read_csv("data/case_data.csv")

comp_pred <- colnames(predictions)[2:ncol(predictions)]
comp_case <- colnames(prov_cases)[2:ncol(prov_cases)]
comp_case[is.na(match(comp_case,comp_pred))]
comp_pred[is.na(match(comp_pred,comp_case))]

prov_cases <- prov_cases %>% 
    rename(BuriRam=Buriram,
           SiSaKet=Sisaket,
           Bangkok=KrungThep)
dates <- with(prov_cases,str_split(date,"-"))    
dates <- lapply(dates,function(x) {
    x <- as.numeric(x)
    x[1]+(x[2]-1)/12
    }) %>% unlist
prov_cases <- prov_cases %>% mutate(date=dates) %>% 
    rename(time=date)
prov_cases <- prov_cases %>% pivot_longer(cols=-time,
                                          names_to="changwat",
                                          values_to="cases")

predictions <- predictions %>% mutate(time=times) %>% 
    pivot_longer(cols=-time,names_to="changwat",values_to="Count")
joined <- left_join(prov_cases,predictions,by=c("changwat","time")) %>% 
    rename(pop=Count)

dpopdt <- dpopdt %>% mutate(time=times) %>% 
    pivot_longer(cols=-time,names_to="changwat",values_to="dpopdt")
joined <- left_join(joined,dpopdt,by=c("changwat","time"))

regions <- census %>% 
    select(Changwat:Region) %>% 
    distinct %>% 
    rename(changwat=Changwat,region=Region) %>% 
    mutate(changwat=str_replace_all(changwat,"[ ]",""))
joined <- left_join(joined,regions,by="changwat")

bsplines <- periodic_bspline_basis(x = joined$time, nbasis = 6, names = "season%d") |> as_tibble()
joined <- cbind(joined,bsplines)

joined <- joined[,c(1,2,6,3,4,5,7:12)]

jaime_data <- read_csv("data/jaime_climate_thailand.csv")
jaime_data <- jaime_data %>% select(time=date,changwat=province,climatic_region,temperature)

unique(joined$changwat[is.na(match(joined$changwat,jaime_data$changwat))])
unique(jaime_data$changwat[is.na(match(jaime_data$changwat,joined$changwat))])
jaime_data$changwat[jaime_data$changwat=="Buriram"]="BuriRam"
jaime_data$changwat[jaime_data$changwat=="KrungThep"]="Bangkok"
jaime_data$changwat[jaime_data$changwat=="Sisaket"]="SiSaKet"

jaime_data <- jaime_data %>% 
    mutate(time=year(time)+(month(time)-1)/12)

joined <- inner_join(joined,jaime_data,by=c("changwat","time"))

joined <- joined[,c(1:3,13,4,14,5:12)]

ensos <- read_csv("data/enso.csv")
ensos <- ensos %>% 
    mutate(time=year+(match(month,str_sub(month.name,1,3))-1)/12) %>% 
    select(time,enso=enso_34_anomaly)

joined <- left_join(joined,ensos,by="time")

joined <- joined[,c(1:6,15,7:14)]

joined <- joined %>% 
    add_column(
        beta_eff=read_csv("data/beta_eff_provinces.csv",col_names=F)$X1,
        .after="temperature")

write_csv(joined,"data/provinces_df.csv")

```

## Correlate private and collective households
```{r}
comps <- census %>% 
    pivot_longer(cols=starts_with("y"),
                 names_to="Year",
                 values_to="Count") %>% 
    mutate(Year=as.numeric(str_sub(Year,2,5))) %>% 
    pivot_wider(id_cols=c(Changwat,Year),names_from=Population,values_from=Count) %>% 
    na.omit %>% 
    mutate(Private=Private/Total,Collective=Collective/Total)
comps <- comps %>%
    mutate(changwat=str_replace_all(Changwat,"[ ]","")) %>% 
    select(-Changwat)

temp_prov <- joined %>% 
    select(c(changwat,temperature)) %>% 
    group_by(changwat) %>% 
    summarise(temp=mean(temperature))

unique(temp_prov$changwat[is.na(match(temp_prov$changwat,comps$changwat))])
unique(comps$changwat[is.na(match(comps$changwat,temp_prov$changwat))])

comps_temp <- inner_join(temp_prov,comps,by="changwat")
ggplot(comps_temp,aes(x=Year,y=Collective,color=changwat))+
    geom_line()+
    theme_classic()+
    scale_color_viridis_d(option="magma")+
    guides(color="none")+
    theme(text=element_text(size=12,family="mono"))+
    ylab("Proportion in Collective Households")
ggplot(comps_temp %>% filter(Year!=2010),aes(x=Year,y=Collective,color=changwat))+
    geom_line()+
    theme_classic()+
    scale_color_viridis_d(option="magma")+
    guides(color="none")+
    theme(text=element_text(size=12,family="mono"))+
    ylab("Proportion in Collective Households")

temp_splits <- 4^2
comps_region <- comps_temp %>%
    filter(Year!=2010,changwat!="Bangkok") %>% 
    group_by(changwat) %>% 
    summarize(Collective=mean(Collective),
              Total=mean(Total),
              temp=mean(temp)) %>% 
    inner_join(joined %>% select(changwat,climatic_region) %>% distinct,
               by="changwat") %>% 
    mutate(climatic_region=factor(climatic_region,
                                  levels=rev(c("Southern",
                                           "Eastern",
                                           "Central",
                                           "Northeastern",
                                           "Northern")))) %>% 
    mutate(temp_d=(temp-min(temp))/(max(temp)-min(temp))) %>% 
    arrange(temp_d) %>% 
    mutate(temp_d=c(
        rep(1:(temp_splits-1),
            each=n()%/%temp_splits),
        rep(temp_splits,
            times=n()-(temp_splits-1)*n()%/%temp_splits)
        ))

comps_region %>% 
    ggplot(aes(x=Total,y=Collective))+
    geom_point(size=2)+
    theme_classic()+
    theme(text=element_text(size=12,family="mono"))+
    xlab("Population Size")+
    ylab("Proportion in Collective Households")

comps_region %>% 
    ggplot(aes(x=Total,y=Collective))+
    geom_point()+
    facet_wrap(~climatic_region,ncol=1)+
    theme_classic()+
    theme(text=element_text(size=12,family="mono"))+
    xlab("Population Size")+
    ylab("Proportion in Collective Households")

comps_region %>% 
    ggplot(aes(x=Total,y=Collective))+
    geom_point()+
    facet_wrap(~temp_d,labeller=labeller(temp_d=~paste("Temp",.x)))+
    theme_classic()+
    theme(text=element_text(size=12,family="mono"),
          axis.text.x=element_text(angle=45,vjust=0.6))+
    xlab("Population Size")+
    ylab("Proportion in Collective Households")

# comps_region %>% 
#     rename(Temperature=temp,Population_Size=Total) %>% 
#     pivot_longer(cols=c(Temperature,Population_Size)) %>% 
#     ggplot(aes(x=Collective,y=value))+
#     geom_point()+
#     facet_wrap(~name,scales="free_x",strip.position="bottom",
#                labeller=labeller(name=~str_replace(.x,"_"," ")))+
#     coord_flip()+
#     theme_classic()+
#     ylab("")+
#     xlab("Proportion in Collective Households")+
#     theme(text=element_text(size=12,family="mono"))
#
# comps_region %>% 
#     rename(Population_Size=Total,
#            Proportion_in_Collective_Households=Collective) %>% 
#     arrange(Proportion_in_Collective_Households) %>% 
#     mutate(changwat=factor(changwat,levels=changwat)) %>% 
#     pivot_longer(cols=c(Proportion_in_Collective_Households,
#                         Population_Size)) %>% 
#     ggplot(aes(x=climatic_region,y=value))+
#     geom_violin()+
#     geom_point(aes(x=climatic_region,y=value,color=changwat))+
#     facet_wrap(~name,scales="free_y",
#                labeller=labeller(name=~str_replace_all(.x,"_"," ")))+
#     theme_classic()+
#     ylab("")+
#     xlab("Climatic Region")+
#     theme(text=element_text(size=11,family="mono"),
#           axis.text.x=element_text(angle=45,vjust=0.6))+
#     scale_color_viridis_d(option="magma",begin=0.2)+
#     guides(color="none")

```

## Compare forecasting between 4_28_b (#6) and 3_14_c (mle #3) and 2_28_c (mle #4)
```{r}
fit_date <- 1990
sim_date <- 2019
real <- bk %>% filter(time>=fit_date&time<sim_date) %>% pull(cases)
quantiles <- c(0.5,0.1,0.9,0.025,0.975)

produce <- function(pomped,state_names) {
    filtered_mean <- pomped %>% pfilter(Np=1000,filter.mean=T)
    coef(pomped,paste0(state_names,"_0")) <- 
        filtered_mean@filter.mean[state_names,(fit_date-1970)*12]
    sims <- pomped %>% simulate(nsim = 1000,
                                times=seq(from=fit_date,to=sim_date-1/12,by=1/12),
                                format = "data.frame")
    intervals <- sims %>% 
        select(time,cases) %>% 
        group_by(time) %>% 
        summarise(as_tibble_row(quantile(cases,probs=quantiles)))
    apply(cbind(intervals,real), 1, function(x) {
        evalcast::weighted_interval_score(quantiles,x[2:6],x[7])
        })
}

p1 <- construction("cluster","4_29","a",4)
p2 <- construction("cluster","4_28","b",6)
p3 <- construction("cluster","3_14","c",3)
p4 <- construction("cluster","2_28","d",4)

wis1 <- produce(p1[[1]],p1[[2]])
wis2 <- produce(p2[[1]],p2[[2]])
wis3 <- produce(p3[[1]],p3[[2]])
wis4 <- produce(p4[[1]],p4[[2]])

times <- seq(from=fit_date,to=sim_date-1/12,by=1/12)
compare <- data.frame(Year=times,a=wis1,b=wis2,c=wis3,d=wis4)[2:length(times),]
for (i in 2:nrow(compare)) compare[i,2:4] <- (compare[i-1,2:4]*(i-1)+compare[i,2:4])/i

model_select <- c(1,2,3)

compare_plot <- compare %>% pivot_longer(cols=c(a,b,c),names_to="Model",values_to="WIS")

ggplot(compare_plot,aes(x=Year,y=WIS,color=Model))+
    geom_line(linewidth=0.7,alpha=0.8)+
    theme_classic()+
    scale_color_manual(name="Model",
                       labels=c(
                           "S[EIRs]S w/out splines",
                           "SEIRS w/out splines",
                           "SEI[Rs]SEI[Rs]",
                           "SEIRS")[model_select],
                       values=c("#db1d7f",
                                "#15a6d1",
                                "#f5a11b",
                                "#0a5c01")[model_select])+
    theme_classic()+
    theme(text=element_text(size=12,family="mono"))+
    xlab("Year")+
    ylab("Mean Cumulative WIS")+
    ggtitle(paste0("Simulating From ",fit_date))

```

## Compare trough matching between 3_14_c (mle #3) and 2_28_c (mle #4)
```{r}
make_sim <- function(po,letter) {
    sims <- po %>% 
        simulate(nsim = 1000,include.data = TRUE,format = "data.frame")
    sims %>%
        select(time,.id,cases) %>% 
        mutate(model=letter)
}

sims1 <- make_sim(p1[[1]],"a")
sims2 <- make_sim(p2[[1]],"b")
sims3 <- make_sim(p3[[1]],"c")
sims4 <- make_sim(p4[[1]],"d")

sims_combined <- rbind(sims1,sims2,sims3,sims4)

troughs <- sims_combined %>% 
    mutate(year=floor(time)) %>% 
    group_by(.id,model,year) %>%
    summarise(trough=min(cases)) %>% 
    pivot_wider(id_cols=c(year,model),names_from=.id,values_from=trough) %>% 
    ungroup
troughs[,4:ncol(troughs)] <- apply(troughs[,4:ncol(troughs)],
                       2,
                       function(x) {unlist(abs(x-troughs[,3]))})
troughs <- troughs %>% 
    select(-data) %>% 
    pivot_longer(cols=-c(year,model)) %>% 
    group_by(year,model) %>% 
    summarise(mean=mean(value),
              lower=quantile(value,0.1),
              upper=quantile(value,0.9)) %>% 
    filter(year>=1973)

labels=c(
    "S[EIRs]S w/out splines",
    "SEIRS w/out splines",
    "SEI[Rs]SEI[Rs]",
    "SEIRS")
values=c("#db1d7f",
         "#15a6d1",
         "#f5a11b",
         "#0a5c01")
troughs %>% ggplot(aes(x=year,y=mean,color=model))+
    geom_line(linewidth=0.7,alpha=0.8)+
    geom_ribbon(aes(ymin=lower,ymax=upper,fill=model),alpha=0.2,color="transparent")+
    scale_color_manual(name="Model",
                       labels=labels,
                       values=values)+
    scale_fill_manual(values=values)+
    guides(fill="none")+
    theme_classic()+
    theme(text=element_text(size=12,family="mono"))+
    xlab("Year")+
    ylab("Absolute Distance From Trough")

```

## Calculate new beta_eff
```{r}
quad <- function(x) {-x[3]*(x[4]-x[1])*(x[4]-x[2])}
briere <- function(x) {x[3]*x[4]*(x[4]-x[1])*sqrt(x[2]-x[4])}
functions <- list(quad,briere)

#function_id,is_prob,t0,tM,c
parameters <- list(a=c(2,0,13.35,40.08,2.02e-4),
                   efd=c(2,0,14.58,34.61,8.56e-3),
                   pea=c(1,1,13.56,38.29,5.99e-3),
                   mdr=c(2,0,11.36,39.17,7.86e-5),
                   lf=c(1,0,9.16,37.73,1.48e-1),
                   b=c(2,1,17.05,35.83,8.49e-4),
                   c=c(2,1,12.22,37.46,4.91e-4))

calculate <- function(temp){
    unlist(t(lapply(parameters,function(x) {
    val <- functions[[x[1]]](c(x[3:5],temp))
    if (x[2]) val <- min(val,1)
    val <- max(val,0)})))
}
values <- lapply(bk$temp,calculate) %>% 
    unlist %>% 
    matrix(nrow=length(parameters)) %>% 
    t %>% 
    as.data.frame
colnames(values) <- names(parameters)

values$pop <- bk$pop

inner_term <- with(values,1-1/(lf^2*efd*pea*mdr))
left_term <- with(values,pop/(lf*inner_term*a^2*b*c))
right_term <- with(values,1/(inner_term*a*b))
#beta_inv <- (1/k)*(left_term+I*right_term)

rh_df <- read_csv("data/mosquito_clim_data.csv")
rh_df <- rh_df %>% 
    mutate(month=month(date_decimal(time))) %>%
    group_by(month,year) %>% 
    summarise(RH=mean(RH)) %>% 
    mutate(time=year+(month-1)/12) %>% 
    arrange(year,month) %>% 
    ungroup %>% 
    select(time,RH) %>% 
    mutate(RH=scale(RH)[,1])

new_data <- bk
new_data <- new_data %>%
    select(time,cases,pop,dpopdt,nino,nina) %>% 
    mutate(left=left_term,right=right_term)

new_data <- inner_join(rh_df,new_data,by="time")

source("objects/object_comp_virus.R")

covariates <- covariate_table(new_data %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(new_data, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

pomped <- construct_pomp(new_data,covariates)

params <- c(sigma=0.005,
            theta=2,phi=1,gamma=100,
            bNina=-1,bNino=3,
            beta_out=0.05,alpha=1,
            delta=1/60,
            muEI1=365/10,muIR1=365/10,muRS1=0.5,
            muEI2=365/20,muIR2=365/20,muRS2=0.5,
            tau=0.01,
            rho=0.005,
            S_0=0.1,
            E1_0=0.5,I1_0=0.5,R1_0=0.9,
            E2_0=0.1,I2_0=0.1,R2_0=0.1,
            K1_0=0.1,F1_0=0.1,
            K2_0=0.01,F2_0=0.01,
            sig_obs=0.05)

coef(pomped,par_names) <- unname(params[par_names])

#pf <- pfilter(pomped,Np=100)
#logLik(pf)

sims <- pomped %>% simulate(nsim = 100,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,cases,C1,C2)
sims_cases <- sims_cases %>%
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    mutate(cases=ifelse(is.na(cases),0,cases))

sims_cases <- sims_cases %>% 
    pivot_longer(cols=cases:C2) %>% 
    mutate(name=factor(name,levels=c("cases","C1","C2")))

colors <- c("black","#40d6ed","#cf0a56")
labels <- c("Data","C1","C2")

ggplot(sims_cases,aes(x=time,value,color=name))+
    geom_line(alpha=0.4)+
    labs(x="Year",y="Cases",title="Dengue in Bangkok")+
    scale_color_manual(name="",values=colors,labels=labels)+
    theme_classic()+
    theme(legend.position="bottom",
          text=element_text(size = 12))

```

## Get finer climate data
```{r}
library(zoo)
library(lubridate)
library(ncdf4)

dataset <- nc_open("../hadisd.3.4.2.202501p_19310101-20250201_484550-99999_humidity.nc")
#print(dataset)
#{
#  sink("../hadISD_metadata.txt")
#  print(dataset)
#  sink()
#}

time <- ncvar_get(dataset, "time")
Temp <- ncvar_get(dataset, "temperatures")
Dew <- ncvar_get(dataset, "dewpoints")

time <- time %>% as.numeric()
Temp <- Temp %>% as.numeric()
Dew <- Dew %>% as.numeric()

climate_data <- data.frame(time=time,Temp=Temp,Dew=Dew) %>%
    mutate(time=as.Date("1931-01-01 00:00")+hours(time)) %>%
    filter(time>=as.Date("1970-01-01 00:00")&time<=as.Date("2019-12-31 23:59")) %>%
    mutate(day=yday(time),month=month(time),year=format(time,"%Y")) %>% 
    mutate(time=decimal_date(time)) %>% 
    group_by(year,day) %>% 
    mutate(hour=1:n()) %>% 
    ungroup

ggplot(climate_data %>% filter(time>=1975.5,time<1976.5),aes(x=time,y=Temp))+
    geom_point()+
    theme_classic()

magnus <- function(Temp, Dew) {
    beta <- 17.625
    lambda <- 243.04
    top <- exp((beta*Dew)/(lambda+Dew))
    bottom <- exp((beta*Temp)/(lambda+Temp))
    RH <- 100*top / bottom
    return(RH)
}

climate_data <- climate_data %>% 
    mutate(
        Temp = na.approx(if_else(Temp > 45.4 | Temp < -1.4, NA, Temp)),
        Dew = na.approx(if_else(Dew > 35 | Dew < -20.1, NA, Dew))
        )

ggplot(climate_data %>% filter(time>=1975.91,time<1976.01),aes(x=time,y=Temp))+
    geom_point()+
    theme_classic()

s <- ssa(climate_data$Temp)
r <- reconstruct(s)
r2 <- melt(r[1]) %>% rename(component=.L1,time=name,Temp=value)
r2$time <- climate_data$time
r2 <- rbind(r2,cbind(component="data",climate_data %>% select(time,Temp)))
ggplot(r2,aes(x=time,y=Temp,color=component))+
    geom_line()+
    scale_color_manual(values=c("#e67082",viridis_pal()(2)))+
    theme_classic()

detrended <- climate_data %>% mutate(Temp=Temp-r[1]$F1)
#detrended <- climate_data %>% mutate(Temp=Temp-0)
detrended %>% 
    filter(time>1974&time<1978) %>%
    ggplot(aes(x=time,y=Temp))+geom_point()+theme_classic()

past_dec <- detrended %>% filter(month==12 & year<1975)
ggplot(past_dec,aes(x=time,y=Temp))+geom_point()+theme_classic()

old_dec <- detrended %>% 
    filter(month==12 & year==1975) %>% 
    select(-Temp)

new_dec <- past_dec %>% 
    filter(paste0(day,hour)%in%paste0(old_dec$day,old_dec$hour)) %>% 
    group_by(day,hour) %>% 
    summarise(Temp=median(Temp))

new_dec <- left_join(old_dec,new_dec,by=c("day","hour"))

detrended[detrended$year==1975&detrended$month==12,] <- new_dec[,colnames(detrended)]

retrended <- detrended %>% mutate(Temp=Temp+r[1]$F1)
#retrended <- detrended %>% mutate(Temp=Temp+0)
retrended <- retrended %>%
    mutate(RH = na.approx(magnus(Temp,Dew)),
           Temp = na.approx(Temp)) %>% 
    select(-Dew)

ggplot(retrended %>% filter(time>=1973,time<2000),aes(x=time,y=RH))+
    geom_point()+
    theme_classic()

```

## Calculate Leo's beta_eff
```{r}
quad <- function(x) {-x[3]*(x[4]-x[1])*(x[4]-x[2])}
briere <- function(x) {
    if (x[2]<=x[4]) return(0)
    x[3]*x[4]*(x[4]-x[1])*sqrt(x[2]-x[4])
    }
functions <- list(quad,briere)

#function_id,is_prob,t0,tM,c
parameters <- list(a=c(2,0,13.35,40.08,2.02e-4),
                   efd=c(2,0,14.58,34.61,8.56e-3),
                   pea=c(1,1,13.56,38.29,5.99e-3),
                   mdr=c(2,0,11.36,39.17,7.86e-5),
                   lf=c(1,0,9.16,37.73,1.48e-1),
                   b=c(2,1,17.05,35.83,8.49e-4),
                   c=c(2,1,12.22,37.46,4.91e-4))

calculate <- function(temp){
    unlist(t(lapply(parameters,function(x) {
    val <- functions[[x[1]]](c(x[3:5],temp))
    if (x[2]) val <- min(val,1)
    val <- max(val,0)})))
}
use_data <- retrended %>% 
    filter(time>=1970&time<2019)
values <- lapply(use_data$Temp,calculate) %>% 
    unlist %>% 
    matrix(nrow=length(parameters)) %>% 
    t %>% 
    as.data.frame
colnames(values) <- names(parameters)

ndays <- use_data %>% 
    group_by(year,month) %>% 
    summarise(n=n()) %>% 
    pull(n)

values$date <- as_date(date_decimal(use_data$time))

get_pop <- read_csv("data/population_data.csv")
values <- inner_join(values,get_pop,by="date")

values <- cbind(values,use_data %>% select(RH,day,month,year))

values$beta_eff <- with(values,(a^2*b*c*lf)*(1/population)*(1-1/(lf^2*efd*pea*mdr)))
values$beta_eff[values$beta_eff==-Inf|is.na(values$beta_eff)] <- 0

values <- values %>% 
    select(day,month,year,RH,beta_eff) %>% 
    group_by(day,month,year) %>% 
    summarise_all(mean) %>% 
    ungroup %>% 
    select(-day) %>% 
    group_by(month,year) %>% 
    summarise_all(mean) %>% 
    ungroup %>% 
    mutate(time=as.numeric(year)+(month-1)/12) %>% 
    select(-c(year,month))

new_data <- read_csv("data/full_time.csv")
new_data <- new_data %>%
    select(time,cases,pop,dpopdt,nino,nina)
new_data <- inner_join(new_data,values,by="time")
#write_csv(new_data,"cluster_runs/run_4_28_a/bk_df.csv")

ggplot(new_data,aes(x=time,y=beta_eff*pop))+geom_line()+theme_classic()
ggplot(new_data,aes(x=time,y=RH))+geom_line()+theme_classic()

```

## Examine beta_eff components
```{r}
values$temp <- use_data$Temp
values <- values %>% 
    mutate(beta_eff=beta_eff*population) %>% 
    select(-c(dpdt,population)) %>% 
    group_by(day,month,year) %>% 
    summarise_all(mean) %>% 
    ungroup %>% 
    select(-day) %>% 
    group_by(month,year) %>% 
    summarise_all(mean) %>% 
    ungroup %>% 
    mutate(time=as.numeric(year)+(month-1)/12) %>% 
    select(-c(year,month,date))

bk <- read_csv("cluster_runs/run_5_20_d/bk_df.csv")
values <- values %>% 
    arrange(time) %>% 
    mutate(cases=bk$cases,enso=bk$nino+bk$nina)

comp_echos <- values %>% filter(time>=1996&time<2003)
comp_echos %>% 
    mutate(mu=1/lf) %>% 
    pivot_longer(cols=c(enso,temp,mu,beta_eff,cases)) %>% 
    mutate(name=factor(name,levels=c("enso","temp","mu","a","b","c","efd","pea","mdr","beta_eff","cases"))) %>% 
    ggplot(aes(x=time,y=value))+
    geom_line()+
    geom_rect(xmin=1997.167,xmax=1998.167,ymin=-Inf,ymax=Inf,alpha=0.005)+
    geom_rect(xmin=2001.167,xmax=2002.167,ymin=-Inf,ymax=Inf,alpha=0.005)+
    geom_vline(xintercept=c(1997.915,2001.59),linetype=2)+
    facet_wrap(~name,scales="free_y",ncol=1)+
    theme_classic()


peak_months <- values %>% 
    mutate(month=rep(1:12,n()/12)) %>% 
    filter(month%in%c(4,5,6)) %>% 
    group_by(year=floor(time)) %>%
    arrange(-temp,.by_group=T) %>% 
    slice_head(n=1) %>% 
    summarise(month=mean(month)) %>% 
    pull(month)
enso <- values %>% 
    group_by(year=floor(time)) %>% 
    summarise(enso=mean(enso)) %>% 
    pull(enso)
data.frame(enso=enso[1:(length(enso))],month=peak_months[1:(length(peak_months))]) %>% 
    ggplot(aes(x=enso,y=month))+
    geom_point()+
    theme_classic()

values %>% ggplot(aes(x=temp,y=beta_eff))+geom_point()+theme_classic()

low_vals <- values %>% 
    mutate(month=rep(1:12,n()/12)) %>% 
    filter(month==1) %>% 
    group_by(year=floor(time)) %>%
    summarise(temp=min(temp)) %>% 
    pull(temp)
enso <- values %>% 
    group_by(year=floor(time)) %>% 
    summarise(enso=max(enso)) %>% 
    pull(enso)
data.frame(enso,low_vals) %>% 
    ggplot(aes(x=enso,y=low_vals))+
    geom_point()+
    theme_classic()

```

## Calculate my beta_eff again
```{r}
term <- with(values,1-1/(lf^2*efd*pea*mdr))
values$left <- with(values,population/(lf*a^2*b*c*term))
values$right <- with(values,1/(a*b*term))
values[values<0|is.na(values)|values==Inf] <- 0

values <- values %>% 
    select(RH,left,right,date) %>% 
    group_by(date) %>% 
    summarise_all(mean) %>% 
    ungroup %>% 
    select(-day) %>% 
    group_by(month,year) %>% 
    summarise_all(mean) %>% 
    ungroup %>% 
    mutate(time=as.numeric(year)+(month-1)/12) %>% 
    select(-c(year,month))

new_data <- read_csv("data/full_time.csv")
new_data <- new_data %>%
    select(time,cases,pop,dpopdt,nino,nina)
new_data <- inner_join(new_data,values,by="time")
#write_csv(new_data,"cluster_runs/run_4_29_a/bk_df.csv")

ggplot(new_data,aes(x=time,y=1/(left+pop*right)*pop))+geom_line()+theme_classic()
ggplot(new_data,aes(x=time,y=RH))+geom_line()+theme_classic()

```

## Sim from 2 strain model
```{r}
colors <- c("#9c9c9c","#40d6ed","#cf0a56")
labels <- c("Data","C1","C2")

source("objects/object_two_strain_beta2.R")
bk <- new_data

covariates <- covariate_table(bk %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

pomped <- construct_pomp(bk,covariates)

params <- c(sigma=0.01,
            theta=4,phi=0.01,gamma=25,
            bNina=0.5,bNino=2.4,
            beta_out=0.001,alpha=0.8,
            delta=1/60,
            muEI1=365/15,muIR1=365/12,muRS1=2,
            muEI2=365/15,muIR2=365/12,muRS2=0.5,
            tau=0.005,
            rho=0.01,
            S_0=0.6,
            E1_0=0.05,I1_0=0.5,R1_0=0.5,
            E2_0=0.01,I2_0=0.01,R2_0=0.1,
            K1_0=0.05,F1_0=0.05,
            K2_0=0.01,F2_0=0.01,
            sig_obs=0.05)
coef(pomped,par_names) <- unname(params[par_names])

sims <- pomped %>% simulate(nsim = 100,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,cases,C1,C2)
sims_cases <- sims_cases %>%
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    mutate(cases=ifelse(is.na(cases),0,cases)) %>% 
    pivot_longer(cols=cases:C2) %>% 
    mutate(name=factor(name,levels=c("cases","C1","C2")))

ggplot(sims_cases,aes(x=time,value,color=name))+
    geom_line(alpha=0.6)+
    labs(x="Year",y="Cases",title="Dengue in Bangkok")+
    scale_color_manual(name="",values=colors,labels=labels)+
    theme_classic()+
    theme(legend.position="bottom",
          text=element_text(size = 12))


#tmp <- read_csv("cluster_runs/run_4_29_a/pars.csv")
#tmp <- tmp %>%
#    mutate(E2_0=E_0,I2_0=I_0,R2_0=R_0,K2_0=K_0,F2_0=F_0) %>% 
#    rename(E1_0=E_0,I1_0=I_0,R1_0=R_0,K1_0=K_0,F1_0=F_0)
#write_csv(tmp,"cluster_runs/run_4_29_a/pars.csv")

```   

## New daily dataset for precip stuff
```{r}
# Climate data
daily_retrended <- retrended %>%
    group_by(year,month,day) %>% 
    summarise_all(mean) %>% 
    mutate(year=as.numeric(year),month=as.numeric(month),day=as.numeric(day)) %>% 
    select(-hour)

precip <- read_csv("data/precipitation_regions.csv") %>% rename(day=doy,time=date)
precip <- precip %>% 
    filter(region=="Central") %>% 
    select(precip,day,month,year)

all_clim <- inner_join(daily_retrended,precip,by=c("day","month","year"))
all_clim <- all_clim %>% 
    rename(P=precip,T=Temp) %>% 
    mutate(date=as_date(date_decimal(time))) %>% 
    mutate(day=day(date)) %>% 
    group_by(year,month) %>%
    mutate(ndays=n()) %>% 
    mutate(time=year+((month+(day-1)/ndays)-1)/12) %>% 
    ungroup

# Pop data
pop_data <- read_csv("data/population_data.csv")
pop_data <- pop_data %>% 
    mutate(date=as_date(date))

joined <- inner_join(all_clim,pop_data,by="date")

# Beta_eff
values <- values %>% 
    select(date,beta_eff) %>% 
    group_by(date) %>% 
    summarise(beta_eff=mean(beta_eff)) %>% 
    ungroup
joined <- inner_join(joined,values,by="date")

joined <- joined %>% 
    select(-c(year,month,day)) %>% 
    rename(pop=population,dpopdt=dpdt)

# case data and enso
cases <- read_csv("data/full_time.csv")
cases <- cases %>% 
    select(time,cases,nina,nino) %>% 
    mutate(month=rep(1:12,length.out=n()),
           year=floor(time),
           day=1) %>% 
    mutate(date=make_date(year=year,month=month,day=day))

joined <- left_join(joined,cases %>% select(date,cases,nino,nina),by="date")

locations <- which(!is.na(joined$cases))
joined[,c("nino","nina")] <-
    joined[rep(locations,joined$ndays[locations]),c("nino","nina")]

joined$time <- decimal_date(joined$date)

write_csv(joined,"cluster_runs/run_5_9_a/bk_df_3.csv")

W_max <- 1000
Ws <- rep(0,nrow(joined))
for (i in 2:nrow(joined)) {
    Ws[i] <- Ws[i-1]+joined$change[i]/W_max
    if (Ws[i]<0) Ws[i]=0
    else if (Ws[i]>1) Ws[i]=1
}
ggplot(data.frame(time=joined$time,water=Ws),aes(x=time,y=water))+geom_line()+theme_classic()

```

## Simulate new K model
```{r}
colors <- c("black","#25b8cf")
labels <- c("Data","Sim")

source("cluster_runs/run_5_1_a/object.R")
bk <- read_csv("cluster_runs/run_5_1_a/bk_df.csv")

covariates <- covariate_table(bk %>% select(all_of(covars)),
    times = "time")
t_extrap <- with(bk, c(2 * time[1] - time[2], time))
covariates <- repair_lookup_table(covariates, t_extrap)

pomped <- construct_pomp(bk,covariates)

params <- c(sigma=0.005,
            kappa=3e-5,W_max=25,
            theta=2,phi=100,eta=1,
            bNina=1,bNino=1,
            beta_out=0.001,alpha=0.8,
            muEI=365/21,muIR=365/14,muRS=60,
            delta=1/60,
            tau=0.08,
            rho=0.01,
            S_0=0.7,
            E_0=0.001,I_0=0.001,R_0=0.3,
            K_0=0.02,F_0=0.01,
            W_0=0,
            sig_obs=0.05)
coef(pomped,par_names) <- unname(params[par_names])

sims <- pomped %>% simulate(nsim = 100,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,cases)
sims_cases <- sims_cases %>%
    mutate(.id=ifelse(.id=="data","data","sim")) %>% 
    mutate(cases=ifelse(is.na(cases),0,cases)) %>% 
    mutate(date=date_decimal(time)) %>% 
    mutate(year=year(date),month=month(date)) %>% 
    group_by(year,month,.id) %>% 
    summarise(cases=mean(cases)) %>% 
    ungroup %>% 
    mutate(time=year+(month-1)/12)

ggplot(sims_cases,aes(x=time,y=cases,color=.id))+
    geom_line(alpha=0.8)+
    labs(x="Year",y="Cases",title="Dengue in Bangkok")+
    scale_color_manual(name="",values=colors,labels=labels)+
    theme_classic()+
    theme(legend.position="bottom",
          text=element_text(size=12))


mle <- model_fit %>% select(all_of(pars)) %>% slice(1)
coef(pomped,pars) <- unname(mle[pars])
sims <- pomped %>% simulate(nsim = 1000,include.data = TRUE,format = "data.frame")
sims_cases <- sims %>% select(time,.id,cases,W,pop)
sims_cases <- sims_cases %>%
    mutate(.id=ifelse(.id=="data","data","sim"),
           cases=ifelse(is.na(cases),0,cases),
           W=with(mle,phi*(theta+1)*W^eta)) %>% 
    pivot_longer(cols=cases:W,names_to="source") %>% 
    na.omit %>% 
    mutate(source=ifelse(source=="cases",.id,source)) %>% 
    select(-c(.id,pop))

nino_years <- bk %>% 
    filter(!is.na(cases)) %>% 
    select(time,nino,nina) %>% 
    mutate(enso=nino+nina) %>% 
    select(time,enso) %>% 
    mutate(upper=sims_cases %>% 
    filter(source=="sim") %>% 
    group_by(time) %>% 
    summarize(upper=quantile(value,0.95)) %>% 
    ungroup %>%
    pull(upper))

colors <- c("black","#40d6ed","grey")
labels <- c("Data","Simulation","K")

ggplot() +
    ggdist::stat_lineribbon(data=sims_cases,
                            mapping=aes(x=time,
                                        y=value,
                                        color=source, 
                                        fill=source),
                            .width = c(0.1,0.9),
                            alpha=0.65,
                            linewidth=0.8)+
    labs(x="Year",
         y="Cases", 
         title="Dengue in Bangkok")+
    scale_fill_manual(values = colors,labels = labels)+
    scale_color_manual(values = colors,labels = labels)+
    guides(color="none",fill=guide_legend(title=""))+
    new_scale_fill()+
    geom_rect(data=nino_years,
              mapping=aes(xmin=time,
                          xmax=time+1/12,
                          ymin=upper,
                          ymax=Inf,
                          fill=enso),
              alpha=0.45,
              inherit.aes=F)+
    scale_fill_gradient2(low="#f2c51f",
                         mid="white",
                         high="#f54997",
                         name="ENSO")+
    theme_classic()+
    theme(legend.position="bottom",
          legend.title=element_text(size=10,vjust=0.8),
          text=element_text(size = 14))



sims %>% 
    select(time,left,right,I,W,pop,nino,nina,P) %>% 
    na.omit %>% 
    mutate(Suitability=
               1/(left+I*right),
           K=with(mle,
                  phi*(theta+1)*W^eta),
           K_all=with(mle,
                  phi*(theta+exp(bNina*nina+bNino*nino))*W^eta*pop)) %>% 
    mutate(beta_eff=Suitability*K_all) %>% 
    select(time,Suitability,K,beta_eff,P) %>% 
    pivot_longer(cols=Suitability:P) %>% 
    mutate(name=factor(name,levels=c("P","K","Suitability","beta_eff"))) %>% 
    ggplot(aes(x=time,y=value))+
    geom_line()+
    theme_classic()+
    facet_wrap(~name,
               scales="free_y",
               labeller=labeller(name=c("beta_eff"="\u03b2")))

sims %>% 
    mutate(nino=nino/max(nino),
           P=P/max(P),
           W=ifelse(W<0.5,NA,W)) %>% 
    pivot_longer(cols=c(P,W,nino)) %>% 
    na.omit %>% 
    mutate(name=factor(name,levels=c("P","W","nino"))) %>% 
    ggplot(aes(x=time,y=value))+
    geom_line()+
    theme_classic()+
    facet_wrap(~name,ncol=1,scales="free_y")


```

## Just some seasonality
```{r}
bk %>% 
    select(time,beta_eff,pop) %>% 
    filter(time>=1987&time<1998) %>% 
    ggplot(aes(x=time,y=beta_eff*(mle$theta+1)*mle$phi*pop))+
    geom_line()+
    theme_classic()

tmp <- read_csv("cluster_runs/run_5_5_c/bk_df.csv")

read_csv("cluster_runs/run_5_5_d/bk_df.csv") %>% 
    mutate(beta_eff=scale(tmp$beta_eff)[,1],
           pop=tmp$pop,
           dpopdt=tmp$dpopdt) %>%
    write_csv("cluster_runs/run_5_5_d/bk_df.csv")

read_csv("cluster_runs/run_5_5_d/pars.csv") %>% 
    rename(bEFF=bT) %>% 
    write_csv("cluster_runs/run_5_5_d/pars.csv")

```

## SARIMA
```{r}
df <- read_csv("cluster_runs/run_5_5_c/bk_df.csv")
df.ts <- ts(df$cases,
         start=df$time[1],
         end=df$time[nrow(df)],
         frequency=12)
autoplot(df.ts)
arima_fit <- auto.arima(df.ts,lambda=0,approximation=F,stepwise=F,allowdrift=F)
loglik <- arima_fit$loglik
arima_fit
k <- (arima_fit$aic+2*loglik)/2
loglik <- loglik-sum(log(df$cases))
aic <- 2*k-2*loglik
loglik
aic

forecast.plot <- arima_fit %>% 
    forecast(h=12*(2019-1973)) %>% 
    as.data.frame %>% 
    rownames_to_column(var="date") %>%
    mutate(time=decimal_date(my(date))) %>% 
    select(time,lo=`Lo 80`,hi=`Hi 80`,mean=`Point Forecast`) %>% 
    mutate(id="sim") %>% 
    mutate(time=time-(2019-1973+1)) %>%
    rbind(df %>% select(time,lo=cases,hi=cases,mean=cases) %>% mutate(id="data"))

forecast.plot %>% 
    filter(id=="sim") %>% 
    mutate(month=rep(1:12,n()/12)) %>% 
    filter(month==1) %>% 
    ggplot(aes(x=time,y=hi))+
    geom_line()+
    theme_classic()

forecast.plot[forecast.plot$id=="sim",] <- forecast.plot %>% 
    filter(id=="sim") %>% 
    mutate(month=rep(1:12,n()/12)) %>% 
    group_by(month) %>% 
    mutate(lo=lo-max(lo)+min(lo)) %>% 
    mutate(hi=hi-max(hi)+min(hi)) %>% 
    ungroup %>% 
    select(-month)

nino_years <- df %>% 
    filter(!is.na(cases)) %>% 
    select(time,nino,nina) %>% 
    mutate(enso=nino+nina) %>% 
    select(time,enso) %>% 
    mutate(upper=(forecast.plot %>% 
                      filter(id=="sim") %>% 
                      pull(hi)))

fill_colors <- c("black","#40d6ed")
color_colors <- c("black","#16a4ba")
labels <- c("Data","Simulation")

forecast.plot %>% 
    ggplot(aes(x=time,y=mean,color=id,fill=id))+
    geom_ribbon(aes(ymin=lo,ymax=hi),color="transparent",alpha=0.65)+
    geom_line(linewidth=0.8)+
    scale_fill_manual(values = fill_colors,labels = labels)+
    scale_color_manual(values = color_colors,labels = labels)+
    guides(color="none",fill=guide_legend(title=""))+
    ylab("Cases")+
    xlab("Year")+
    ggtitle("Dengue in Bangkok")+
    new_scale_fill()+
    geom_rect(data=nino_years,
              mapping=aes(xmin=time,
                          xmax=time+1/12,
                          ymin=upper,
                          ymax=Inf,
                          fill=enso),
              alpha=0.45,
              inherit.aes=F)+
    scale_fill_gradient2(low="#f2c51f",mid="white",high="#f54997",name="ENSO")+
    theme_classic()+
    theme(legend.position="bottom",
          legend.title=element_text(size=10,vjust=0.8),
          text=element_text(size = 14))+
    ylim(0,5000)


```

## SARIMA 2
```{r}
df <- read_csv("cluster_runs/run_5_9_a/bk_df.csv") %>% select(time,cases,nino,nina) %>% na.omit
df$time <- read_csv("cluster_runs/run_5_8_a/bk_df.csv") %>% 
    filter(time>=df$time[1]) %>% 
    pull(time)
df.ts <- ts(df$cases,
         start=df$time[1],
         end=2019+11/12,
         frequency=12)
autoplot(df.ts)
arima_fit <- auto.arima(df.ts,lambda=0,approximation=F,stepwise=F,allowdrift=F)
loglik <- arima_fit$loglik
arima_fit
k <- (arima_fit$aic+2*loglik)/2
loglik <- loglik-sum(log(df$cases))
aic <- 2*k-2*loglik
loglik
k
aic

forecast.plot <- arima_fit %>% 
    forecast(h=12*(2019-df$time[1])) %>% 
    as.data.frame %>% 
    rownames_to_column(var="date") %>%
    mutate(time=decimal_date(my(date))) %>% 
    select(time,lo=`Lo 80`,hi=`Hi 80`,mean=`Point Forecast`) %>% 
    mutate(id="sim") %>% 
    mutate(time=time-(2019-df$time[1]+1)) %>%
    rbind(df %>% select(time,lo=cases,hi=cases,mean=cases) %>% mutate(id="data"))

forecast.plot[forecast.plot$id=="sim",] <- forecast.plot %>% 
    filter(id=="sim") %>% 
    mutate(month=rep(1:12,n()/12)) %>% 
    group_by(month) %>% 
    mutate(hi=hi/exp((time-df$time[1])/(2019/50))) %>% 
    ungroup %>% 
    select(-month)

forecast.plot %>% 
    filter(id=="sim") %>% 
    mutate(month=rep(1:12,n()/12)) %>% 
    filter(month==6) %>% 
    ggplot(aes(x=time,y=hi))+
    geom_line()+
    theme_classic()

nino_years <- df %>% 
    filter(!is.na(cases)) %>% 
    select(time,nino,nina) %>% 
    mutate(enso=nino+nina) %>% 
    select(time,enso) %>% 
    mutate(upper=(forecast.plot %>% 
                      filter(id=="sim") %>% 
                      pull(hi)))

fill_colors <- c("black","#40d6ed")
color_colors <- c("black","#16a4ba")
labels <- c("Data","Simulation")

forecast.plot %>% 
    ggplot(aes(x=time,y=mean,color=id,fill=id))+
    geom_ribbon(aes(ymin=lo,ymax=hi),color="transparent",alpha=0.65)+
    geom_line(linewidth=0.8)+
    scale_fill_manual(values = fill_colors,labels = labels)+
    scale_color_manual(values = color_colors,labels = labels)+
    guides(color="none",fill=guide_legend(title=""))+
    ylab("Cases")+
    xlab("Year")+
    ggtitle("Dengue in Bangkok")+
    new_scale_fill()+
    geom_rect(data=nino_years,
              mapping=aes(xmin=time,
                          xmax=time+1/12,
                          ymin=upper,
                          ymax=Inf,
                          fill=enso),
              alpha=0.45,
              inherit.aes=F)+
    scale_fill_gradient2(low="#f2c51f",mid="white",high="#f54997",name="ENSO")+
    theme_classic()+
    theme(legend.position="bottom",
          legend.title=element_text(size=10,vjust=0.8),
          text=element_text(size = 14))
    ylim(0,5000)

```

## Param guesses for refinement
```{r}
lapply(paste0(list.files("cluster_runs",full.names=T)[grep("5_7",list.files("cluster_runs"))],"/results.csv"),
       function(path) {
           #path <- "cluster_runs/run_5_7_a/results.csv"
           y <- read_csv(path) %>% 
               arrange(-loglik) %>%
               select(-c(sample,loglik,loglik.se,flag))
           y <- y[,2:ncol(y)]
           n <- 500-nrow(y)
           if (n<1) {
               z <- y
           } else {z <- rbind(y,y[1:n,])}
           new_path <- str_replace(path,"7","8")
           new_path <- str_replace(new_path,"results","pars")
           #print(paste0(path," ",new_path," ",nrow(z)))
           write_csv(z,new_path)
       })

lapply(paste0(list.files("cluster_runs",full.names=T)[grep("5_8",list.files("cluster_runs"))],"/pars.csv"),
       function(path) {
           #path <- "cluster_runs/run_5_7_a/results.csv"
           read_csv(path) %>% nrow
       })


read_csv("cluster_runs/run_5_9_e/pars.csv") %>% 
    mutate(bNina=0) %>%
    write_csv("cluster_runs/run_5_9_e/pars.csv")

```

## Examine convergence and conditional loglik
```{r}
stats <- read_csv(paste0(file_path,"/stats.csv"))
cond <- stats %>% 
    select(cond,time) %>% 
    mutate(time=round(time,3)) %>% 
    mutate(cond=-cond) %>% 
    full_join(bk %>% select(cases,time) %>% mutate(time=round(time,3)),by="time") %>% 
    na.omit

nino_years <- bk %>% 
    filter(!is.na(cases)) %>% 
    select(time,nino,nina) %>% 
    mutate(enso=nino+nina) %>% 
    select(time,enso) %>% 
    mutate(lower=cond %>% 
    select(time,cond) %>% 
    group_by(time) %>% 
    summarize(upper=quantile(cond,0.99)) %>% 
    ungroup %>%
    pull(upper))

max_first  <- max(cond$cases)
max_second <- max(cond$cond)
min_first  <- min(cond$cases)
min_second <- min(cond$cond)

max_second
min_second

max_second <- 42
min_second <- 2

scale=(max_second-min_second)/(max_first-min_first)
shift=-min_second+min_first

scale_function <- function(x, scale, shift) return (-(x*scale-shift))
inv_scale_function <- function(x, scale, shift) return (-(x+shift)/scale)

ggplot(cond,aes(x=time,y=cases)) +
    geom_line(aes(color="Cases"),linewidth=0.6) +
    ggdist::stat_lineribbon(aes(y=inv_scale_function(-cond,scale,shift),color="Loglik"),
                            .width=c(0.025,0.975),
                            alpha=0.5,
                            linewidth=0.6,
                            fill="#40d6ed")+
    scale_y_continuous(sec.axis=sec_axis(~scale_function(.,scale,shift),name="Conditional loglik")) +
    labs(x="Year",y="Cases",color = "") +
    scale_color_manual(values=c("black", "#16a4ba"))+
    guides(color="none")+
    new_scale_fill()+
    geom_rect(data=nino_years,
              mapping=aes(xmin=time,
                          xmax=time+1/12,
                          ymin=inv_scale_function(-lower,scale,shift),
                          ymax=Inf,
                          fill=enso),
              alpha=0.45,
              inherit.aes=F)+
    scale_fill_gradient2(low="#f2c51f",mid="white",high="#f54997",name="ENSO")+
    theme_classic()+
    theme(axis.title.y.right=element_text(color="#16a4ba"),
          axis.line.y.right=element_line(color="#16a4ba"),
          axis.text.y.right=element_text(color="#16a4ba"),
          axis.ticks.y.right=element_line(color="#16a4ba"),
          legend.position="bottom",
          legend.title=element_text(size=10,vjust=0.8),
          text=element_text(size = 14))

```

## Peak timing, magnitude, duration
```{r}
threshold <- 150

get_stats <- function(df) {
    #df <- tmp
    tmp <- df %>% 
        group_by(.id) %>% 
        mutate(year=floor(time),month=rep(1:12,n()/12)) %>% 
        group_by(.id,year)
    tmp_ret <- data.frame(year=unique(tmp$year))
    right_join(tmp_ret,tmp %>% 
                   filter(cases==max(cases)) %>% 
                   ungroup %>% 
                   select(year,peak=month,.id),
               by="year") %>% 
        inner_join(tmp %>%
                       filter(cases>=threshold) %>% 
                       summarise(cases=sum(cases)) %>% 
                       ungroup %>% 
                       select(year,magnitude=cases,.id),
                   by=c("year",".id")) %>% 
        inner_join(tmp %>%
                       filter(cases>=threshold) %>% 
                       summarise(n_months=n()) %>% 
                       ungroup %>% 
                       select(year,duration=n_months,.id),
                   by=c("year",".id"))
}

bk_stats <- read_csv("cluster_runs/run_5_8_f/bk_df.csv") %>% 
    mutate(.id="data") %>% 
    get_stats

fit_list <- list(seasonality=rep(c("Splines","Beta_eff"),each=6),
                 model=rep(rep(c("SEIRS","Boosting"),each=3),2),
                 covariate=rep(c("none","nino","enso"),4))
fit_list$path <- c("run_5_8_f","run_5_8_g","run_5_8_d",
                   "run_5_14_a","run_5_14_b","run_5_14_c",
                   "run_5_8_b","run_5_8_i","run_5_8_a",
                   "run_5_12_d","run_5_12_e","run_5_12_f")
fit_list$mle <- c(1,1,1,
                  1,1,2,
                  1,1,1,
                  1,1,1)
fit_list$aic <- c("6662.06","6648.74","6650.30",
                  "6678.58","6674.10","6675.72",
                  "6610.20","6618.56","6631.00",
                  "6630.56","6641.14","6667.94")

acc_results <- data.frame()
for (i in 1:12) {
    print(i)
    file_path <- paste0("./cluster_runs/",fit_list$path[i])
    source(paste0(file_path,"/object.R"))
    mle <- read.csv(paste0(file_path,"/results.csv")) %>% 
        arrange(-loglik) %>%
        select(all_of(par_names)) %>% 
        slice(fit_list$mle[i])
    bk <- read_csv(paste0(file_path,"/bk_df.csv"))
    covariates <- covariate_table(bk %>% select(all_of(covars)),
        times = "time")
    t_extrap <- with(bk, c(2 * time[1] - time[2], time))
    covariates <- repair_lookup_table(covariates, t_extrap)
    pomped <- construct_pomp(bk,covariates)
    coef(pomped,par_names) <- unname(mle[par_names])
    sims <- pomped %>% simulate(nsim=1000,include.data=F,format="data.frame")
    sims_stats <- sims %>% 
        select(time,.id,cases) %>% 
        get_stats
    acc <- sims_stats %>% 
        left_join(bk_stats,by="year") %>% 
        group_by(year) %>% 
        summarise(peak_acc=sum(peak.x==peak.y)/n(),
                  dur_acc=sum(duration.x==duration.y)/n(),
                  mag_acc=sum(floor(log(magnitude.x))==
                                  floor(log(magnitude.y)))/n())
    acc <- acc %>% 
        cbind(data.frame(
            seasonality=fit_list$seasonality[i],
            model=fit_list$model[i],
            covariate=fit_list$covariate[i]))
    if (i==1) { acc_results <- acc
    } else acc_results <- bind_rows(acc_results,acc)
}

axis_ticks <- seq(1973,2018,by=10)
sarima_label <- data.frame(seasonality="Splines",
                                   model="Boosting",
                                   covariate="none",
                                   path="",
                                   mle="",
                                   aic="",
                                   lab="6659.73",
                                   x=2013,
                                   y=Inf,
                                   vjust=1.4,
                                   color="black")
acc_results %>%
    mutate(seasonality=ifelse(seasonality=="splines","Splines","Beta_eff"),
           model=ifelse(model=="SEIRS","SEIRS","Boosting")) %>% 
    mutate(covariate=factor(covariate,levels=c("none","nino","enso"))) %>% 
    ggplot(aes(x=year,y=mag_acc,color=covariate))+
    facet_grid(factor(seasonality,c("Splines","Beta_eff"))~factor(model,c("SEIRS","Boosting")))+
    geom_line(linewidth=0.6)+
    scale_color_manual(name="Covariate",
                       values=c("#a5b2b5","#7ccfa5","#ad688b","black"),
                       labels=c("None","Nio","Nio + Nia",""))+
    labs(x="Year",y="Log Magnitude Accuracy")+
    scale_x_continuous("Year",
                       labels=as.character(axis_ticks),
                       breaks=axis_ticks)+
    theme_classic()+
    theme(text=element_text(size=14))+
    geom_text(data=data.frame(fit_list) %>% 
                  mutate(lab=aic,
                         x=1970,
                         y=Inf,
                         vjust=rep(seq(from=2,to=5,length.out=3),4),
                         color=covariate) %>% 
                  rbind(sarima_label),
              aes(x=x,y=y,label=lab,color=color,vjust=vjust),
              hjust=0,
              show.legend=F)


```

## Just peak timing
```{r}
get_stats <- function(df) {
    years <- head(unique(floor(df$time)),-1)
    tmp <- df %>% 
        group_by(.id) %>% 
        mutate(month=(rep(1:12,n()/12))) %>% 
        filter(!month%in%2:4) %>% 
        slice_head(n=-8) %>% 
        slice_tail(n=-1) %>% 
        mutate(year=rep(years,each=9))

    tmp_ret <- data.frame(year=unique(tmp$year))
    right_join(tmp_ret,tmp %>% 
                   group_by(year,.id) %>% 
                   filter(cases==max(cases)) %>% 
                   ungroup %>% 
                   select(year,peak=month,.id),
               by="year")
}

bk_stats <- read_csv("cluster_runs/run_5_8_f/bk_df.csv") %>% 
    mutate(.id="data") %>% 
    get_stats

fit_list <- list(seasonality=rep(c("Splines","Beta_eff"),each=6),
                 model=rep(rep(c("SEIRS","Boosting"),each=3),2),
                 covariate=rep(c("none","nino","enso"),4))
fit_list$path <- c("run_5_8_f","run_5_8_g","run_5_8_d",
                   "run_5_14_a","run_5_14_b","run_5_14_c",
                   "run_5_8_b","run_5_8_i","run_5_8_a",
                   "run_5_12_d","run_5_12_e","run_5_12_f")
fit_list$mle <- c(1,1,1,
                  1,1,2,
                  1,1,1,
                  1,1,1)
fit_list$aic <- c("6662.06","6648.74","6650.30",
                  "6678.58","6674.10","6675.72",
                  "6610.20","6618.56","6631.00",
                  "6630.56","6641.14","6667.94")

acc_results <- data.frame()
for (i in 1:12) {
    print(i)
    file_path <- paste0("./cluster_runs/",fit_list$path[i])
    source(paste0(file_path,"/object.R"))
    mle <- read.csv(paste0(file_path,"/results.csv")) %>% 
        arrange(-loglik) %>%
        select(all_of(par_names)) %>% 
        slice(fit_list$mle[i])
    bk <- read_csv(paste0(file_path,"/bk_df.csv"))
    covariates <- covariate_table(bk %>% select(all_of(covars)),
        times = "time")
    t_extrap <- with(bk, c(2 * time[1] - time[2], time))
    covariates <- repair_lookup_table(covariates, t_extrap)
    pomped <- construct_pomp(bk,covariates)
    coef(pomped,par_names) <- unname(mle[par_names])
    sims <- pomped %>% simulate(nsim=1000,include.data=F,format="data.frame")
    sims_stats <- sims %>% 
        select(time,.id,cases) %>% 
        get_stats
    acc <- sims_stats %>% 
        left_join(bk_stats,by="year") %>% 
        group_by(year) %>% 
        mutate(error=abs(peak.x-peak.y),
               sq_error=(peak.x-peak.y)^2) %>% 
        summarise(me=mean(error),
                  mse=mean(sq_error),
                  lo_me=quantile(error,0.2),
                  hi_me=quantile(error,0.8),
                  lo_mse=quantile(sq_error,0.2),
                  hi_mse=quantile(sq_error,0.8),
                  acc=sum(peak.x==peak.y)/n())
    acc <- acc %>% 
        cbind(data.frame(
            seasonality=fit_list$seasonality[i],
            model=fit_list$model[i],
            covariate=fit_list$covariate[i]))
    if (i==1) { acc_results <- acc
    } else acc_results <- bind_rows(acc_results,acc)
}

axis_ticks <- seq(1973,2018,by=10)
sarima_label <- data.frame(seasonality="Splines",
                                   model="Boosting",
                                   covariate="black",
                                   path="",
                                   mle="",
                                   aic="",
                                   lab="6659.73",
                                   x=2013,
                                   y=Inf,
                                   vjust=1.4,
                                   color="black")
acc_results %>% 
    mutate(covariate=factor(covariate,levels=c("none","nino","enso"))) %>% 
    ggplot(aes(x=year,y=me,color=covariate,fill=covariate))+
    facet_grid(factor(seasonality,c("Splines","Beta_eff"))~factor(model,c("SEIRS","Boosting")))+
    geom_line(linewidth=0.6)+
    geom_ribbon(aes(ymin=lo_me,ymax=hi_me),alpha=0.2,color="transparent")+
    scale_fill_manual(name="Covariate",
                       values=c("#a5b2b5","#7ccfa5","#ad688b","black"),
                       labels=c("None","Nio","Nio + Nia",""))+
    scale_color_manual(values=c("#a5b2b5","#7ccfa5","#ad688b","black"))+
    guides(color="none")+
    labs(x="Year",y="Peak Timing ME")+
    scale_x_continuous("Year",
                       labels=as.character(axis_ticks),
                       breaks=axis_ticks)+
    theme_classic()+
    theme(text=element_text(size=14))+
    geom_text(data=data.frame(fit_list) %>% 
                  mutate(lab=aic,
                         x=1970,
                         y=Inf,
                         vjust=rep(seq(from=2,to=5,length.out=3),4),
                         color=covariate) %>% 
                  rbind(sarima_label),
              aes(x=x,y=y,label=lab,color=color,vjust=vjust),
              hjust=0,
              show.legend=F)

acc_results %>% 
    mutate(covariate=factor(covariate,levels=c("none","nino","enso"))) %>% 
    ggplot(aes(x=year,y=acc,color=covariate))+
    facet_grid(factor(seasonality,c("Splines","Beta_eff"))~factor(model,c("SEIRS","Boosting")))+
    geom_line(linewidth=0.6)+
    scale_color_manual(name="Covariate",
                       values=c("#a5b2b5","#7ccfa5","#ad688b","black"),
                       labels=c("None","Nio","Nio + Nia",""))+
    labs(x="Year",y="Peak Timing Accuracy")+
    scale_x_continuous("Year",
                       labels=as.character(axis_ticks),
                       breaks=axis_ticks)+
    theme_classic()+
    theme(text=element_text(size=14))+
    geom_text(data=data.frame(fit_list) %>% 
                  mutate(lab=aic,
                         x=1970,
                         y=Inf,
                         vjust=rep(seq(from=2,to=5,length.out=3),4),
                         color=covariate) %>% 
                  rbind(sarima_label),
              aes(x=x,y=y,label=lab,color=color,vjust=vjust),
              hjust=0,
              show.legend=F)

```

## Look at S
```{r}
plot_years <- 1997:2014
plot_years <- 1973:2018
bk_subset <- bk %>% filter(floor(time)%in%plot_years)

sim <- pomped %>% simulate(nsim=1000,format="data.frame")
sims <- sim %>% 
    filter(floor(time)%in%plot_years)

sims_cases <- sims %>% 
    group_by(time=as.factor(time)) %>% 
    summarise(lower=quantile(cases,0.1),
              upper=quantile(cases,0.9),
              mean=mean(cases),
              S=mean(S),
              I=mean(I),
              R=mean(R),
              #S=mean(S1+S2)
              ) %>% 
    mutate(S=round(S/bk_subset$pop,3),
           I=round(I/bk_subset$pop,4),
           R=round(R/bk_subset$pop,3)) %>% 
    mutate(time=unfactor(time)) %>% 
    mutate(cases=bk_subset$cases) %>% 
    mutate(S_scale=round((999*(S-min(S))/(max(S)-min(S))))+1,
           I_scale=round((999*(I-min(I))/(max(I)-min(I))))+1,
           R_scale=round((999*(R-min(R))/(max(R)-min(R))))+1) %>% 
    mutate(S_colors=viridis(n=1000,
                              option="rocket",
                              begin=1,end=0.2)[S_scale],
           I_colors=viridis(n=1000,
                              option="rocket",
                              begin=1,end=0.2)[I_scale],
           R_colors=viridis(n=1000,
                              option="rocket",
                              begin=1,end=0.2)[R_scale])
axis_ticks <- plot_years[seq(2,length(plot_years),2)]

ggplot(sims_cases,aes(x=time))+
    geom_rect(aes(xmin=time,xmax=time+1/12,
                  ymin=lower,ymax=upper),
              fill=sims_cases$I_colors,alpha=0.8)+
    geom_line(aes(y=mean,color=I),alpha=0)+
    geom_rect(xmin=-Inf,xmax=Inf,ymin=-Inf,ymax=0,fill="white")+
    geom_rect(xmin=-Inf,xmax=Inf,ymin=max(sims_cases$upper),ymax=Inf,fill="white")+
    geom_line(aes(y=cases),linewidth=0.6)+
    scale_x_continuous("Year",
                       labels=as.character(axis_ticks),
                       breaks=axis_ticks)+
    scale_color_viridis_c(#name="(S1+S2)/N",
                          name="S/N",
                          option="rocket",
                          begin=1,end=0.2)+
    ylab("Cases")+
    ylim(0,max(sims_cases$upper))+
    theme_classic()+
    theme(text=element_text(size=13,family="mono"),
          plot.margin = margin(r=10,t=10,l=10,b=10),
          strip.text=element_text(size=13),
          legend.title=element_text(hjust=0.1))
```

panel pomp with beta_eff, SEIRS, el nio and not

mercedes' guiding questions:
1. is temperature sufficient to explain enso effects
2. interplay of enso and susceptibles
3. breakdown of epidemic synchrony in 2000s - is it a sign of control,
   or does it correspond to climate slowdown - the answer is probably no
For #3 we can fit model until 2001 and then simulate with observed covariates - to confirm that the same
underlying patterns can predict it, using just climate

which parameter in the VC equation can give us a more heightened response - to offer bigger peaks, capturing the effect of enso
somehow alter equation to heighten effect of temperature - make is more sensitive - increase the amplitude
so that when it's higher the response is much higher
especially in the mortality term

how does the response to enso change in different regions in thailand, and how do mosquito parameters change

## Continuous enso data
```{r}
enso <- read_csv("data/jaime_monthly_enso.csv")
enso <- enso %>% select(enso=nino_3m_ave,mag=mag_nino)

bk <- read_csv("cluster_runs/run_5_19_a/bk_df.csv")
bk <- cbind(bk,enso)

bk$nino <- with(bk,ifelse(enso>=0,enso,0))
bk$nina <- with(bk,ifelse(enso<=0,enso,0))
bk <- bk %>% select(-enso)

bk <- bk %>% rename(magnitude=mag) %>% 
    mutate(magnitude=case_match(magnitude,NA~0,"normal"~1,"strong"~2,"super strong"~3))

write_csv(bk,"cluster_runs/run_5_19_c/bk_df.csv")


bk <- read_csv("cluster_runs/run_5_19_c/bk_df.csv")
bk$magnitude[bk$nina<=-0.5&bk$nina>-1] <- -1
bk$magnitude[bk$nina<=-1&bk$nina>-2] <- -2
bk$magnitude[bk$nina<=-2] <- -3

#https://agupubs.onlinelibrary.wiley.com/doi/epdf/10.1029/2024GH001193
la_nina <- c(1983,1984,1988,1995,1998,1999,
             2000,2005,2007,2008,2010,2011,2016,2017)

bk$ninas <- ifelse(floor(bk$time)%in%la_nina,1,0)
bk$magnitude[bk$nina!=0&bk$time>=1980] <- bk$ninas[bk$nina!=0&bk$time>=1980]*bk$magnitude[bk$nina!=0&bk$time>=1980]

bk <- bk %>% select(-ninas)

ggplot(bk,aes(x=time,y=nino+nina))+
    geom_line()+
    geom_point(aes(y=magnitude))+
    geom_hline(yintercept=c(-2,-1,-0.5,0,0.5,1,2),linetype=2)+
    theme_classic()

write_csv(bk,"cluster_runs/run_5_19_c/bk_df.csv")


enso <- read_csv("cluster_runs/run_5_20_d/bk_df.csv") %>% select(time,nino,nina)
enso <- enso %>% mutate(year=floor(time),month=rep(1:12,n()/12)) %>% select(-time)
bk <- read_csv("cluster_runs/run_5_20_a/bk_df.csv")
bk <- bk %>% mutate(year=year(date),month=month(date)) %>% select(-c(nino,nina))
bk <- left_join(bk,enso,by=c("year","month"))
bk <- bk %>% mutate(beta_eff=beta_eff*pop)
write_csv(bk,"cluster_runs/run_5_20_a/bk_df.csv")

```

